var fluid_2_0=fluid_2_0||{},fluid=fluid||fluid_2_0;!function(e,t){"use strict";function n(e,t,n,o){for(var r=e[n],a=0;a<o.length-1;++a)r=o[a+1](r,n);t[n]=r}function o(e,n,o,r){for(var a=0;a<o;++a)e=r(e,n[a],a,t.makeArray(n));return e}function r(e,t,n,r){for(var a=[],i=0;i<e.length;++i){var u=o(e[i],t,n,r[i]);void 0!==u&&a.push(u)}return a}t.version="Infusion 2.0-SNAPSHOT",t.Error=Error,t.environment={fluid:t},t.global=t.global||window||{},t.invokeLater=function(e){return setTimeout(e,1)},t.defeatLogging=!0,t.activityTracing=!1,t.activityTrace=[];var a=/(%\w+)/g;t.renderOneActivity=function(e,t){for(var n=t===!0?[]:["    while "],o=e.message,r=a.lastIndex=0;;){var i=a.exec(o);if(!i)break;var u=i[1].substring(1);n.push(o.substring(r,i.index)),n.push(e.args[u]),r=a.lastIndex}return r<o.length&&n.push(o.substring(r)),n},t.renderActivity=function(e,n){return n=n||t.renderOneActivity,t.transform(e,n)},t.getActivityStack=function(){var e=t.globalThreadLocal();return e.activityStack||(e.activityStack=[]),e.activityStack},t.describeActivity=t.getActivityStack,t.logActivity=function(e){e=e||t.describeActivity();var n=t.renderActivity(e).reverse();t.log("Current activity: "),t.each(n,function(e){t.doLog(e)})},t.pushActivity=function(e,n,o){var r={type:e,message:n,args:o,time:(new Date).getTime()};t.activityTracing&&t.activityTrace.push(r),t.passLogLevel(t.logLevel.TRACE)&&t.doLog(t.renderOneActivity(r,!0));var a=t.getActivityStack();a.push(r)},t.popActivity=function(e){e=e||1,t.activityTracing&&t.activityTrace.push({pop:e});var n=t.getActivityStack(),o=n.length-e;n.length=o<0?0:o},t.FluidError=function(e){this.message=e,this.stack=(new Error).stack},t.FluidError.prototype=new Error,t.builtinFail=function(e,n,o){t.log.apply(null,[t.logLevel.FAIL,"ASSERTION FAILED: "].concat(n)),t.logActivity(o);var r=n.join("");if(e)throw new t.FluidError(r);r["Assertion failure - check console for details"]()};var i=[!1];t.fail=function(){var e=t.makeArray(arguments),n=t.makeArray(t.describeActivity());t.popActivity(n.length);var o=i[0];"boolean"==typeof o?t.builtinFail(o,e,n):"function"==typeof o&&o(e,n)},t.pushSoftFailure=function(e){"boolean"==typeof e||"function"==typeof e?i.unshift(e):e===-1&&i.shift()},t.notrycatch=!0,t.tryCatch=function(e,n,o){if(o=o||t.identity,t.notrycatch){var r=e();return o(),r}try{return e()}catch(e){if(!n)throw e;n(e)}finally{o()}},t.expect=function(e,n,o){t.transform(t.makeArray(n),function(n){"undefined"==typeof o[n]&&t.fail(e+" missing required parameter "+n)})},t.isLogging=function(){return u[0].priority>t.logLevel.IMPORTANT.priority},t.isLogLevel=function(e){return t.isMarker(e)&&void 0!==e.priority},t.passLogLevel=function(e){return e.priority<=u[0].priority},t.setLogging=function(e){var n;"boolean"==typeof e?n=t.logLevel[e?"INFO":"IMPORTANT"]:t.isLogLevel(e)?n=e:t.fail("Unrecognised fluid logging level ",e),u.unshift(n)},t.setLogLevel=t.setLogging,t.popLogging=function(){return 1===u.length?u[0]:u.shift()},t.doLog=function(e){var t=e.join("");"undefined"!=typeof console?console.debug?console.debug.apply(console,e):"function"==typeof console.log?console.log.apply(console,e):console.log(t):"undefined"!=typeof YAHOO?YAHOO.log(t):"undefined"!=typeof opera&&opera.postError(t)},t.log=function(){var e=t.makeArray(arguments),n=t.logLevel.INFO;if(t.isLogLevel(e[0])&&(n=e.shift()),t.passLogLevel(n)){var o=t.renderTimestamp(new Date)+":  ",r=[o].concat(e);t.doLog(r)}},t.identity=function(e){return e},t.isValue=function(e){return void 0!==e&&null!==e},t.isPrimitive=function(e){var t=typeof e;return!e||"string"===t||"boolean"===t||"number"===t||"function"===t},t.isArrayable=function(e){return e&&(e.jquery||"[object Array]"===Object.prototype.toString.call(e))},t.isPlainObject=function(e){if(!e)return!1;var t=Object.prototype.toString.call(e);return"[object Array]"===t||"[object Object]"===t},t.isDOMNode=function(e){return e&&"number"==typeof e.nodeType},t.isDOMish=function(e){return t.isDOMNode(e)||e.jquery},t.isComponent=function(e){return e&&e.typeName&&e.id},t.freshContainer=function(e){return t.isArrayable(e)?[]:{}},t.copy=function(n){return t.isPrimitive(n)?n:e.extend(!0,t.freshContainer(n),n)},t.makeArray=function(e){var n=[];if(null!==e&&void 0!==e)if(t.isPrimitive(e)||"number"!=typeof e.length)n.push(e);else for(var o=0;o<e.length;++o)n[o]=e[o];return n},t.transform=function(e){var o=t.freshContainer(e);if(t.isArrayable(e))for(var r=0;r<e.length;++r)n(e,o,r,arguments);else for(var a in e)n(e,o,a,arguments);return o},t.each=function(e,n){if(t.isArrayable(e))for(var o=0;o<e.length;++o)n(e[o],o);else for(var r in e)n(e[r],r)},t.make_find=function(e){var n=!e&&void 0;return function(o,r,a){var i;if(t.isArrayable(o)){for(var u=0;u<o.length;++u)if(i=r(o[u],u),i!==n)return e?o[u]:i}else for(var l in o)if(i=r(o[l],l),i!==n)return e?o[l]:i;return a}},t.find=t.make_find(!1),t.find_if=t.make_find(!0),t.accumulate=function(e,t,n){for(var o=0;o<e.length;++o)n=t(e[o],n,o);return n},t.remove_if=function(e,n,o){if(t.isArrayable(e))for(var r=e.length-1;r>=0;--r)n(e[r],r)&&(o&&o.unshift(e[r]),e.splice(r,1));else for(var a in e)n(e[a],a)&&(o&&(o[a]=e[a]),delete e[a]);return o||e},t.generate=function(e,t,n){for(var o=[],r=0;r<e;++r)o[r]=n?t(r):t;return o},t.iota=function(e,t){t=t||0;for(var n=[],o=0;o<e;++o)n[n.length]=t++;return n},t.getMembers=function(e,n){return t.transform(e,function(e){return t.get(e,n)})},t.filterKeys=function(n,o,r){return t.remove_if(e.extend({},n),function(t,n){return r^e.inArray(n,o)===-1})},t.censorKeys=function(e,n){return t.filterKeys(e,n,!0)},t.makeFlatten=function(e){return function(n){var o=[];return t.each(n,function(){o.push(arguments[e])}),o}},t.keys=t.makeFlatten(1),t.values=t.makeFlatten(0),t.contains=function(n,o){return n?t.isArrayable(n)?e.inArray(o,n)!==-1:t.find(n,function(e){if(o===e)return!0}):void 0},t.keyForValue=function(e,n){return t.find(e,function(e,t){if(n===e)return t})},t.findKeyInObject=t.keyForValue,t.arrayToHash=function(e){var n={};return t.each(e,function(e){n[e]=!0}),n},t.clear=function(e){if(t.isArrayable(e))e.length=0;else for(var n in e)delete e[n]},t.compareStringLength=function(e){return e?function(e,t){return e.length-t.length}:function(e,t){return t.length-e.length}},t.logLevelsSpec={FATAL:0,FAIL:5,WARN:10,IMPORTANT:12,INFO:15,TRACE:20},t.logLevel=t.transform(t.logLevelsSpec,function(e,t){return{type:"fluid.marker",value:t,priority:e}});var u=[t.logLevel.IMPORTANT];t.VALUE={type:"fluid.marker",value:"VALUE"},t.NO_VALUE={type:"fluid.marker",value:"NO_VALUE"},t.EXPAND={type:"fluid.marker",value:"EXPAND"},t.EXPAND_NOW={type:"fluid.marker",value:"EXPAND_NOW"},t.isMarker=function(e,t){return!(!e||"object"!=typeof e||"fluid.marker"!==e.type)&&(!t||e.value===t.value)},t.model={},t.model.copyModel=function(n,o){t.clear(n),e.extend(!0,n,o)},t.model.parseEL=function(e){return""===e?[]:String(e).split(".")},t.model.composePath=function(e,t){return""===e?t:""===t?e:e+"."+t},t.model.composeSegments=function(){return t.makeArray(arguments).join(".")},t.path=t.model.composeSegments,t.composePath=t.model.composePath,t.requireDataBinding=function(){t.fail("Please include DataBinding.js in order to operate complex model accessor configuration")},t.model.setWithStrategy=t.model.getWithStrategy=t.requireDataBinding,t.model.resolvePathSegment=function(e,t,n,o){return!o&&e.resolvePathSegment?e.resolvePathSegment(t):n&&void 0===e[t]?e[t]={}:e[t]},t.model.pathToSegments=function(e,n){var o=n&&n.parser?n.parser.parse:t.model.parseEL,r="number"==typeof e||"string"==typeof e?o(e):e;return r},t.model.accessImpl=function(e,n,o,r,a,i,u){var l=t.model.pathToSegments(n,r),s=0;a&&(s=a.length,l=a.concat(l));var c=o===t.NO_VALUE?0:1;return e=u(e,l,s,r,c),o===t.NO_VALUE||o===t.VALUE?i?{root:e,segs:l}:e:void(e[l[l.length-1]]=o)},t.model.accessSimple=function(e,n,o,r,a,i){return t.model.accessImpl(e,n,o,r,a,i,t.model.traverseSimple)},t.model.traverseSimple=function(e,n,o,r,a){for(var i=r,u=n.length-a,l=0;l<u;++l){if(!e)return e;var s=n[l];e=r&&r[s]?r[s]:t.model.resolvePathSegment(e,s,1===a,i),r=null}return e},t.model.setSimple=function(e,n,o,r,a){t.model.accessSimple(e,n,o,r,a,!1)},t.model.getSimple=function(e,n,o,r){return null===n||void 0===n||0===n.length?e:t.model.accessSimple(e,n,t.NO_VALUE,o,r,!1)},t.decodeAccessorArg=function(e){return e&&e!==t.model.defaultGetConfig&&e!==t.model.defaultSetConfig?"environment"===e.type?e.value:void 0:null},t.set=function(e,n,o,r,a){var i=t.decodeAccessorArg(r);void 0===i?t.model.setWithStrategy(e,n,o,r,a):t.model.setSimple(e,n,o,i,a)},t.get=function(e,n,o,r){var a=t.decodeAccessorArg(o);return void 0===a?t.model.getWithStrategy(e,n,o,r):t.model.accessImpl(e,n,t.NO_VALUE,a,null,!1,t.model.traverseSimple)},t.model.setBeanValue=t.set,t.model.getBeanValue=t.get,t.getGlobalValue=function(e,n){if(e)return n=n||t.environment,t.get(t.global,e,{type:"environment",value:n})},t.bind=function(e,n,o){return e[n].apply(e,t.makeArray(o))},t.invokeGlobalFunction=function(e,n,o){var r=t.getGlobalValue(e,o);return r?r.apply(null,n||[]):void t.fail("Error invoking global function: "+e+" could not be located")},t.registerGlobalFunction=function(e,n,o){o=o||t.environment,t.set(t.global,e,n,{type:"environment",value:o})},t.setGlobalValue=t.registerGlobalFunction,t.registerNamespace=function(e,n){n=n||t.environment;var o=t.getGlobalValue(e,n);return o||(o={},t.setGlobalValue(e,o,n)),o},t.dumpEl=t.identity,t.renderTimestamp=t.identity,t.registerNamespace("fluid.event"),t.generateUniquePrefix=function(){return Math.floor(1e12*Math.random()).toString(36)+"-"};var l=t.generateUniquePrefix();t.fluidInstance=l;var s=1;t.allocateGuid=function(){return l+s++},t.event.identifyListener=function(e,n){return"string"==typeof e||e.$$fluid_guid||n||(e.$$fluid_guid=t.allocateGuid()),e.$$fluid_guid},t.event.impersonateListener=function(e,n){t.event.identifyListener(e),n.$$fluid_guid=e.$$fluid_guid},t.event.mapPriority=function(e,t){return null===e||void 0===e?t:"last"===e?Number.MAX_VALUE:"first"===e?-Number.MAX_VALUE:-e},t.priorityComparator=function(e,t){return e.priority-t.priority},t.event.sortListeners=function(e){var n=[];return t.each(e,function(e){for(var t,o=0;o<e.length;++o){var r=e[o];r.softNamespace||t||(t=r)}t?n.push(t):n=n.concat(e)}),n.sort(t.priorityComparator)},t.event.invokeListener=function(e,n){return"string"==typeof e&&(e=t.event.resolveListener({globalName:e})),e.apply(null,n)},t.event.resolveListener=function(e){if(e.globalName){var n=t.getGlobalValue(e.globalName);n?e=n:t.fail("Unable to look up name "+e.globalName+" as a global function")}return e},t.nameComponent=function(e){return e?"component with typename "+e.typeName+" and id "+e.id:"[unknown component]"},t.event.nameEvent=function(e,n){return n+" of "+t.nameComponent(e)},t.makeEventFirer=function(e){function n(n,a,i){if(n&&!o.destroyed){t.log(t.logLevel.TRACE,"Firing event "+r+" to list of "+n.length+" listeners");for(var u=0;u<n.length;++u){var l=n[u];l.listener=t.event.resolveListener(l.listener);var s=l.listener;if(!l.predicate||l.predicate(s,a)){var c,f=(i?i(s):s).apply(null,a);if((e.preventable&&f===!1||o.destroyed)&&(c=!1),void 0!==c)return c}}}}e=e||{};var o,r=e.name||"<anonymous>",a=t.event.identifyListener,i=function(){o.listeners={},o.byId={},o.sortedListeners=[],o.addListener=function(e,n,r,i,u){if(o.destroyed&&t.fail("Cannot add listener to destroyed event firer "+o.name),e){"string"==typeof e&&(e={globalName:e});var l=a(e);n=n||l;var s={listener:e,predicate:r,namespace:n,softNamespace:u,priority:t.event.mapPriority(i,o.sortedListeners.length)};o.byId[l]=s;var c=o.listeners[n]=t.makeArray(o.listeners[n]);c[u?"push":"unshift"](s),o.sortedListeners=t.event.sortListeners(o.listeners)}},o.addListener.apply(null,arguments)};return o={eventId:t.allocateGuid(),name:r,ownerId:e.ownerId,typeName:"fluid.event.firer",destroy:function(){o.destroyed=!0},addListener:function(){i.apply(null,arguments)},removeListener:function(e){if(o.listeners){var n,r,i;if("string"==typeof e){if(n=e,i=o.listeners[n],!i)return}else"function"==typeof e&&(r=a(e,!0),r||t.fail("Cannot remove unregistered listener function ",e," from event "+o.name));var u=o.byId[r],l=u&&u.softNamespace;n=n||u&&u.namespace||r,delete o.byId[r],i=o.listeners[n],i&&(l?t.remove_if(i,function(e){return e.listener.$$fluid_guid===r}):i.shift(),0===i.length&&delete o.listeners[n],o.sortedListeners=t.event.sortListeners(o.listeners))}},fireToListeners:function(e,t,o){return n(e,t,o)},fire:function(){return n(o.sortedListeners,arguments)}}},t.fireEvent=function(e,n,o){var r=t.get(e,n);r&&r.fire.apply(null,t.makeArray(o))},t.event.addListenerToFirer=function(e,n,o,r){if(r=r||t.identity,t.isArrayable(n))for(var a=0;a<n.length;++a)t.event.addListenerToFirer(e,n[a],o,r);else"function"==typeof n||"string"==typeof n?r(e).addListener(n,o):n&&"object"==typeof n&&r(e).addListener(n.listener,o||n.namespace,n.predicate,n.priority,n.softNamespace)},t.event.resolveListenerRecord=function(e){return{records:e}},t.expandOptions=function(e){t.fail("fluid.expandOptions could not be loaded - please include FluidIoC.js in order to operate IoC-driven event with descriptor "+e)},t.mergeListeners=function(e,n,o){t.each(o,function(o,r){var a,i;if("{"===r.charAt(0))a=t.expandOptions(r,e),a||t.fail("Error in listener record: key "+r+' could not be looked up to an event firer - did you miss out "events." when referring to an event firer?');else{var u=r.indexOf(".");u!==-1&&(i=r.substring(u+1),r=r.substring(0,u)),n[r]||t.fail("Listener registered for event "+r+" which is not defined for this component"),a=n[r]}var l=t.event.resolveListenerRecord(o,e,r,i,!0);t.event.addListenerToFirer(a,l.records,i,l.adderWrapper)})},t.eventFromRecord=function(e,n,o){var r,a=e&&("string"!=typeof e||"{"===e.charAt(0));return a?t.event.resolveEvent?r=t.event.resolveEvent(o,n,e):t.fail("fluid.event.resolveEvent could not be loaded - please include FluidIoC.js in order to operate IoC-driven event with descriptor ",e):r=t.makeEventFirer({name:t.event.nameEvent(o,n),preventable:"preventable"===e,ownerId:o.id}),r},t.instantiateFirers=function(e,n){t.each(n.events,function(n,o){e.events[o]=t.eventFromRecord(n,o,e)})},t.mergeListenerPolicy=function(e,n,o){"string"!=typeof o&&t.fail("Error in listeners declaration - the keys in this structure must resolve to event names - got "+o+" from ",n);var r="{"!==o.charAt(0)&&o.indexOf(".")!==-1;return r?n||e:t.arrayConcatPolicy(e,n)},t.makeMergeListenersPolicy=function(e){return function(n,o){return n=n||{},t.each(o,function(t,o){n[o]=e(n[o],t,o)}),n}},t.unique=function(e){return t.remove_if(e,function(t,n){return!t||n>0&&t===e[n-1]})},t.arrayConcatPolicy=function(e,n){return t.makeArray(e).concat(t.makeArray(n))},t.typeTag=function(e){return e?{typeName:e,id:t.allocateGuid()}:null},t.staticEnvironment=t.typeTag("fluid.staticEnvironment"),t.singleThreadLocal=function(e){var t=e();return function(e){return void 0===e?t:t=e}},t.threadLocal=t.singleThreadLocal,t.globalThreadLocal=t.threadLocal(function(){return t.typeTag("fluid.dynamicEnvironment")});var c=1,f={},d={},p=function(e,n,o){var r=!0;return o?r=1===n.length:n=t.makeArray(n),t.each(n,function(n){if(n&&!e.gradeHash[n]){var o="{"===n.charAt(0),a=(o?null:r?t.rawDefaults(n):t.getGradedDefaults(n))||{},i=f[n]||c-1;e.lastTick=Math.max(e.lastTick,i),e.gradeHash[n]=!0,e.gradeChain.push(n),e.optionsChain.push(a);for(var u=t.makeArray(a.gradeNames),l=0;l<u.length;++l){var s=u[l],d="autoInit"===s;r?d||p(e,s):e.gradeHash[s]||d||(e.gradeHash[s]=!0,e.gradeChain.push(s))}}}),e};t.resolveGradeStructure=function(e,n){var o={lastTick:0,gradeChain:[],gradeHash:{},optionsChain:[]};return p(o,(t.makeArray(n).reverse()||[]).concat([e]),!0)};var g={};t.gradeNamesToKey=function(e,t){return e+"|"+t.join("|")},t.hasGrade=function(e,n){return!(!e||!e.gradeNames)&&t.contains(e.gradeNames,n)},t.resolveGrade=function(n,o,r){for(var a=t.resolveGradeStructure(o,r),i=a.optionsChain.reverse(),u={},l=0;l<i.length;++l)i[l]&&i[l].mergePolicy&&(u=e.extend(!0,u,i[l].mergePolicy));i=[u,{}].concat(i);var s=t.merge.apply(null,i);return s.gradeNames=a.gradeChain,t.hasGrade(n,"autoInit")&&s.gradeNames.push("autoInit"),{defaults:s,lastTick:a&&a.lastTick}},t.getGradedDefaults=function(e,n){n=t.makeArray(n);var o=t.gradeNamesToKey(e,n),r=g[o];if(r){for(var a=0,i=r.defaults.gradeNames||[],u=0;u<i.length;++u)a=Math.max(a,f[i[u]]||0);a>r.lastTick&&(t.log("Clearing cache for component "+e+" with gradeNames ",i),r=null)}if(!r){var l=t.rawDefaults(e);if(!l)return l;r=g[o]=t.resolveGrade(l,e,n)}return r.defaults},t.annotateListeners=function(e,n){n.listeners&&(n.listeners=t.transform(n.listeners,function(n){var o=t.makeArray(n);return t.transform(o,function(n){return t.isPrimitive(n)||(n.componentSource=e),n})}))},t.rawDefaults=function(e,n){if(void 0===n)return d[e];t.pushActivity("registerDefaults","registering defaults for grade %componentName with options %options",{componentName:e,options:n});var o=t.expandCompact?t.expandCompact(n):t.copy(n);t.annotateListeners(e,o),d[e]=o,f[e]=c++,t.popActivity()},t.doIndexDefaults=function(e,n,o,r){for(var a=t.makeArray(r.gradeNames),i=0;i<a.length;++i)if(!t.hasGrade(n,a[i]))return;for(var u="function"==typeof r.indexFunc?r.indexFunc:t.getGlobalValue(r.indexFunc),l=u(n)||[],s=0;s<l.length;++s)(o[l[s]]=o[l[s]]||[]).push(e)},t.indexDefaults=function(e,n){var o={};for(var r in d){var a=t.getGradedDefaults(r);t.doIndexDefaults(r,a,o,n)}return o},t.defaults=function(e,n){return void 0===n?t.getGradedDefaults(e):(n&&n.options&&t.fail("Probable error in options structure for "+e+' with option named "options" - perhaps you meant to write these options at top level in fluid.defaults? - ',n),t.rawDefaults(e,n),t.hasGrade(n,"autoInit")&&t.makeComponent(e,t.getGradedDefaults(e)),void 0)},t.makeComponent=function(n,o){if(o.gradeNames&&0!==o.gradeNames.length){if(!o.initFunction){for(var r=[],a=0;a<o.gradeNames.length;++a){var i=o.gradeNames[a],u=t.rawDefaults(i);u||"autoInit"===i||r.push(i)}0===r.length?t.fail("Cannot autoInit component "+n+" which does not have an initFunction defined"):t.fail("The grade hierarchy of component with typeName "+n+" is incomplete - it inherits from the following grade(s): "+r.join(", ")+" for which the grade definitions are corrupt or missing. Please check the files which might include these grades and ensure they are readable and have been loaded by this instance of Infusion")}}else t.fail("Cannot autoInit component "+n+" which does not have any gradeNames defined");var l=function(){return t.initComponent(n,arguments)},s=t.getGlobalValue(n);s&&e.extend(l,s),t.setGlobalValue(n,l)},t.makeComponents=function(e){t.each(e,function(e,n){var o={gradeNames:t.makeArray(e).concat(["autoInit"])};t.defaults(n,o)})},t.model.mergeModel=function(n,o){if(!t.isPrimitive(n)){var r=t.copy(o);e.extend(!0,o,n),e.extend(!0,o,r)}return o};var m={};t.derefMergePolicy=function(e){return(e?e["*"]:m)||m},t.compileMergePolicy=function(e){var n={},o={},r={builtins:n,defaultValues:o};return e?(t.each(e,function(e,a){var i={},u=!0;if("function"==typeof e)i.func=e;else if("object"==typeof e)i=e;else if(t.isDefaultValueMergePolicy(e))t.set(o,a,"{that}.options."+e),r.hasDefaults=!0,u=!1;else for(var l=e.split(/\s*,\s*/),s=0;s<l.length;++s)i[l[s]]=!0;u&&t.set(n,t.composePath(a,"*"),i)}),r):r},t.isDefaultValueMergePolicy=function(e){return"string"==typeof e&&e.indexOf(",")===-1&&!/replace|preserve|nomerge|noexpand/.test(e)},t.mergeOneImpl=function(e,n,o,r,a,i,u){var l=e,s=t.isPrimitive(e);return void 0!==n&&(a.func||null===n||!t.isPlainObject(n)||t.isDOMish(n)||n===t.VALUE||a.preserve||a.nomerge?(r[o]=void 0,l=a.func?a.func.call(null,e,n,u[i-1],u,i):t.isValue(e)&&a.preserve?t.model.mergeModel(e,n):n):s&&(l=e=t.freshContainer(n))),l},t.fetchMergeChildren=function(e,n,o,r,a,i){for(var u=t.derefMergePolicy(a),l=r.length-1;l>=0;--l){var s=r[l];if(void 0!==s&&(t.each(s,function(t,u){e.hasOwnProperty(u)||(o[n]=u,i.strategy(e,u,n+1,o,r,a))}),u.replace))break}return e},t.inEvaluationMarker={__CURRENTLY_IN_EVALUATION__:!0},t.destroyedMarker={__COMPONENT_DESTROYED__:!0},t.strategyRecursionBailout=50,t.makeMergeStrategy=function(e){var n=function(n,a,i,u,l,s){if(i>t.strategyRecursionBailout&&t.fail("Overflow/circularity in options merging, current path is ",u," at depth ",i,' - please protect components from merging using the "nomerge" merge policy'),!t.isPrimitive(n)){t.isTracing&&t.tracing.pathCount.push(t.path(u.slice(0,i)));var c;if(n.hasOwnProperty(a)){if(c=n[a],!e.evaluateFully)return c}else n[a]=t.inEvaluationMarker;void 0===l&&(u=t.makeArray(u),l=r(e.sources,u,i-1,e.sourceStrategies),s=o(e.mergePolicy,u,i-1,t.concreteTrundler));var f,d,p,g=t.concreteTrundler(s,a),m=t.derefMergePolicy(g);m.replace?(f=1-l.length,d=0,p=-1):(f=0,d=l.length-1,p=1);for(var v,h=[],k=f;k<=d;++k){var y=p*k,b=e.sourceStrategies[y](l[y],a,i,u);if(void 0!==b&&(h[y]=b,void 0===c)){if(p===-1){v=n[a]=b;break}v=n[a]=t.mergeOneImpl(v,b,k,h,m,i,u,e)}}return void 0!==c&&(v=c),h.length>0&&(t.isPrimitive(v)||t.fetchMergeChildren(v,i,u,h,g,e)),void 0===c&&0===h.length&&delete n[a],v}};return e.strategy=n,n},t.driveStrategy=function(e,n,o){n=t.makeArray(n);for(var r=0;r<n.length;++r){if(!e)return;e=o(e,n[r],r+1,n)}return e},t.concreteTrundler=function(e,t){return e?e[t]:void 0},t.merge=function(e){var n=Array.prototype.slice.call(arguments,1),o=t.compileMergePolicy(e).builtins,r=t.makeMergeOptions(o,n,{});return r.initter(),r.target},t.simpleGingerBlock=function(e,n){var o={target:e,simple:!0,strategy:t.concreteTrundler,initter:t.identity,recordType:n,priority:t.mergeRecordTypes[n]};return o},t.makeMergeOptions=function(n,o,r){var a={mergePolicy:n,sources:o};return a=e.extend(a,r),a.target=a.target||t.freshContainer(a.sources[0]),a.sourceStrategies=a.sourceStrategies||t.generate(a.sources.length,t.concreteTrundler),a.initter=function(){a.evaluateFully=!0,t.fetchMergeChildren(a.target,0,[],a.sources,a.mergePolicy,a)},t.makeMergeStrategy(a),a},t.transformOptions=function(e,n){t.expect("Options transformation record",["transformer","config"],n);var o=t.getGlobalValue(n.transformer);return o.call(null,e,n.config)},t.findMergeBlocks=function(e,n){return t.remove_if(t.makeArray(e),function(e){return e.recordType!==n})},t.transformOptionsBlocks=function(e,n,o){t.each(o,function(o){var r=t.findMergeBlocks(e,o);t.each(r,function(e){e[e.simple?"target":"source"]=t.transformOptions(e.source,n)})})},t.deliverOptionsStrategy=t.identity,t.computeComponentAccessor=t.identity,t.computeDynamicComponents=t.identity,t.mergeRecordTypes={defaults:0,localOptions:50,defaultValueMerge:100,subcomponentRecord:200,distribution:300,user:500,demands:600},t.destroyValue=function(e,n){e&&t.model.applyChangeRequest(e,{type:"DELETE",path:n})},t.mergeComponentOptions=function(n,o,r,a){function i(){k=t.driveStrategy(f,"mergePolicy",v.strategy),k=e.extend({},t.rootMergePolicy,k),h=t.compileMergePolicy(k),e.extend(!0,s,h.builtins)}var u=t.rawDefaults(o),l=t.getGradedDefaults(o,u&&u.gradeNames?null:a.gradeNames),s={},c=[];c=t.expandComponentOptions?c.concat(t.expandComponentOptions(s,l,r,n)):c.concat([t.simpleGingerBlock(l,"defaults"),t.simpleGingerBlock(r,"user")]);var f={},d=[],p=[],g={target:f,sourceStrategies:d},m=function(){c.sort(t.priorityComparator),d.length=0,p.length=0,t.each(c,function(e){d.push(e.strategy),p.push(e.target)})};m();var v=t.makeMergeOptions(s,p,g);v.mergeBlocks=c,v.updateBlocks=m,v.destroyValue=function(e){for(var n=0;n<c.length;++n)t.destroyValue(c[n].target,e);t.destroyValue(g.target,e)};var h,k;i(),h.hasDefaults&&(t.generateExpandBlock?(c.push(t.generateExpandBlock({options:h.defaultValues,recordType:"defaultValueMerge",priority:t.mergeRecordTypes.defaultValueMerge},n,{})),m()):t.fail("Cannot operate mergePolicy ",k," for component ",n," without including FluidIoC.js")),n.options=f;var y=t.driveStrategy(f,"nickName",v.strategy);n.nickName=y||t.computeNickName(n.typeName),t.driveStrategy(f,"gradeNames",v.strategy),t.deliverOptionsStrategy(n,f,v);var b=t.driveStrategy(f,"transformOptions",v.strategy);return b&&(t.transformOptionsBlocks(c,b,["user","subcomponentRecord"]),m()),t.computeComponentAccessor(n),g.target.mergePolicy||i(),v},t.defaults("fluid.function",{}),t.invokeGradedFunction=function(e,n){var o=t.defaults(e);o&&o.argumentMap&&t.hasGrade(o,"fluid.function")||t.fail("Cannot look up name "+e+" to a function with registered argumentMap - got defaults ",o);var r=[];return t.each(o.argumentMap,function(e,t){r[e]=n[t]}),t.invokeGlobalFunction(e,r)},t.lifecycleFunctions={preInitFunction:!0,postInitFunction:!0,finalInitFunction:!0},t.rootMergePolicy=e.extend({gradeNames:t.arrayConcatPolicy,distributeOptions:t.arrayConcatPolicy,transformOptions:"replace"},t.transform(t.lifecycleFunctions,function(){return t.mergeListenerPolicy})),t.defaults("fluid.littleComponent",{gradeNames:["autoInit"],initFunction:"fluid.initLittleComponent",mergePolicy:t.rootMergePolicy,argumentMap:{options:0}}),t.defaults("fluid.eventedComponent",{gradeNames:["fluid.littleComponent","autoInit"],events:{onCreate:null,onAttach:null,onClear:null,onDestroy:null,afterDestroy:null},mergePolicy:{listeners:t.makeMergeListenersPolicy(t.mergeListenerPolicy)}}),t.COMPONENT_OPTIONS={type:"fluid.marker",value:"COMPONENT_OPTIONS"},t.emptySubcomponent=function(e){var n=t.typeTag("fluid.emptySubcomponent");n.options=e||{},n.options.gradeNames=[n.typeName],e=t.makeArray(e);for(var o=0;o<e.length;++o)n[e[o]]=t.identity;return n},t.computeNickName=function(e){var n=t.model.parseEL(e);return n[n.length-1]},t.typeFount=function(e){var n=t.initLittleComponent("fluid.typeFount",e);return t.typeTag(n.options.targetTypeName)},t.initLittleComponent=function(e,n,o,r){var a=t.typeTag(e);o=o||{gradeNames:"fluid.littleComponent"},a.destroy=t.makeRootDestroy(a);var i=t.mergeComponentOptions(a,e,n,o),u=a.options,l=t.hasGrade(u,"fluid.eventedComponent");l&&(a.events={}),(r||t.identity)(a,u,i.strategy),t.computeDynamicComponents(a,i);for(var s=0;s<i.mergeBlocks.length;++s)i.mergeBlocks[s].initter();return i.initter(),delete u.mergePolicy,t.initLifecycleFunctions(a),t.fireEvent(u,"preInitFunction",a),l&&(t.instantiateFirers(a,u),t.mergeListeners(a,a.events,u.listeners)),t.hasGrade(u,"autoInit")||t.clearLifecycleFunctions(u),a},t.updateWithDefaultLifecycle=function(e,n,o){var r=o+"."+e.substring(0,e.length-"function".length),a=t.getGlobalValue(r);if("function"==typeof a){n=t.makeArray(n);var i=t.find(n,function(e){var t=e.listener||e;if(t===a||t===r)return!0});i||n.push(a)}return n},t.initLifecycleFunctions=function(e){var n=e.options.gradeNames||[];t.each(t.lifecycleFunctions,function(o,r){for(var a=e.options[r],i=n.length-1;i>=0;--i)"autoInit"!==n[i]&&(a=t.updateWithDefaultLifecycle(r,a,n[i]));a&&(e.options[r]=t.makeEventFirer({name:r,ownerId:e.id}),t.event.addListenerToFirer(e.options[r],a))})},t.clearLifecycleFunctions=function(e){t.each(t.lifecycleFunctions,function(t,n){delete e[n]}),delete e.initFunction},t.diagnoseFailedView=t.identity,t.makeRootDestroy=function(e){return function(){t.fireEvent(e,"events.onClear",[e,"",null]),t.doDestroy(e),t.fireEvent(e,"events.afterDestroy",[e,"",null])}},t.isDestroyed=function(e){return e.destroy===t.destroyedMarker},t.doDestroy=function(e,n,o){t.fireEvent(e,"events.onDestroy",[e,n||"",o]),e.destroy=t.destroyedMarker;for(var r in e.events)"afterDestroy"!==r&&"function"==typeof e.events[r].destroy&&e.events[r].destroy();e.applier&&e.applier.destroy()},t.resolveReturnedPath=t.identity,t.initComponent=function(e,n){var o=t.defaults(e);o.gradeNames||t.fail("Cannot initialise component "+e+" which has no gradeName registered");var r,a=[e].concat(t.makeArray(n));return t.pushActivity("initComponent","constructing component of type %componentName with arguments %initArgs",{componentName:e,initArgs:n}),r=t.invokeGlobalFunction(o.initFunction,a),t.diagnoseFailedView(e,r,o,a),t.fireEvent(r.options,"postInitFunction",r),t.initDependents&&t.initDependents(r),t.fireEvent(r.options,"finalInitFunction",r),t.clearLifecycleFunctions(r.options),t.fireEvent(r,"events.onCreate",r),t.popActivity(),t.resolveReturnedPath(r.options.returnedPath,r)?t.get(r,r.options.returnedPath):r},t.initSubcomponentImpl=function(e,n,o){var r;if("function"!=typeof n){var a="string"==typeof n?n:n.type;r="fluid.emptySubcomponent"===a?t.emptySubcomponent(n.options):t.invokeGlobalFunction(a,o)}else r=n.apply(null,o);return r},t.initSubcomponents=function(e,n,o){var r=e.options[n];if(r){var a=t.makeArray(r),i=-1,u=[];o=t.makeArray(o);for(var l=0;l<o.length;++l)o[l]===t.COMPONENT_OPTIONS&&(i=l);for(l=0;l<a.length;++l)r=a[l],i!==-1&&(o[i]=r.options),u[l]=t.initSubcomponentImpl(e,r,o);return u}},t.initSubcomponent=function(e,n,o){return t.initSubcomponents(e,n,o)[0]};var v="(?:[\\w\\u00c0-\\uFFFF*_-";t.simpleCSSMatcher={regexp:new RegExp("([#.]?)("+v+"]|\\\\.)+)","g"),charToTag:{"":"tag","#":"id",".":"clazz"}},t.IoCSSMatcher={regexp:new RegExp("([&#]?)("+v+"]|\\.)+)","g"),charToTag:{"":"context","&":"context","#":"id"}};var h=new RegExp("\\s*(>)?\\s*","g");t.parseSelector=function(n,o){var r=[];n=e.trim(n);var a=o.regexp;a.lastIndex=0;for(var i=0;;){for(var u=[],l=!0;;){var s=a.exec(n);if(!s)break;if(s.index!==i){if(!l)break;t.fail("Error in selector string - cannot match child selector expression starting at "+n.substring(i))}var c={},f=s[2],d=o.charToTag[s[1]];d&&(c[d]=f),u[u.length]=c,i=a.lastIndex,l=!1}h.lastIndex=i;var p={predList:u},g=h.exec(n);if(g&&g.index===i||t.fail("Error in selector string - can not match child selector expression at "+n.substring(i)),">"===g[1]&&(p.child=!0),r[r.length]=p,h.lastIndex>=n.length)break;i=h.lastIndex,a.lastIndex=h.lastIndex}return r},t.stringToRegExp=function(e,t){return new RegExp(e.replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g,"\\$&"),t)},t.stringTemplate=function(e,n){var o=t.keys(n);o=o.sort(t.compareStringLength());for(var r=0;r<o.length;++r){var a=o[r],i=t.stringToRegExp("%"+a,"g");e=e.replace(i,n[a])}return e},t.defaults("fluid.messageResolver",{gradeNames:["fluid.littleComponent","autoInit"],mergePolicy:{messageBase:"nomerge",parents:"nomerge"},resolveFunc:t.stringTemplate,parseFunc:t.identity,messageBase:{},parents:[]}),t.messageResolver.preInit=function(e){e.messageBase=e.options.parseFunc(e.options.messageBase),e.lookup=function(n){var o=t.messageResolver.resolveOne(e.messageBase,n);return void 0===o?t.find(e.options.parents,function(e){return e?e.lookup(n):void 0}):{template:o,resolveFunc:e.options.resolveFunc}},e.resolve=function(n,o){if(!n)return"[No messagecodes provided]";n=t.makeArray(n);var r=e.lookup(n);return r?r.resolveFunc(r.template,o):"[Message string for key "+n[0]+" not found]"}},t.messageResolver.resolveOne=function(e,t){for(var n=0;n<t.length;++n){var o=t[n],r=e[o];if(void 0!==r)return r}},t.messageLocator=function(e,n){var o=t.messageResolver({messageBase:e,resolveFunc:n});return function(e,t){return o.resolve(e,t)}}}(jQuery,fluid_2_0);var fluid_2_0=fluid_2_0||{};!function(e,t){"use strict";function n(e,t){var n=s[e]||[];e:for(var o=0;o<n.length;++o){for(var r=n[o],a=0;a<t.length;++a)if(r.contexts[a]!==t[a])continue e;return r.spec}}function o(e,n,o,r){for(var a=0;a<o;++a)e=r(e,n[a],a,t.makeArray(n));return e}t.visitComponentChildren=function(e,n,o,r,a){var i=t.getInstantiator(e);for(var u in e){var l=i.composePath(r,u),s=e[u];if(!(!t.isComponent(s)||o.visited&&o.visited[s.id])){if(o.visited&&(o.visited[s.id]=!0),n(s,u,l,r,a))return!0;o.flat||t.visitComponentChildren(s,n,o,l)}}},t.getMemberNames=function(e,n){var o=e.idToPath(n[n.length-1].id),r=t.model.parseEL(o);return r.unshift.apply(r,t.generate(n.length-r.length,"")),r};var r=function(e,n,o,r){r=r||{visited:{},flat:!0,instantiator:e};for(var a=t.getMemberNames(e,n),i=n.length-1;i>=0;--i){var u,l=n[i];if(l.typeName&&(r.visited[l.id]=!0,u=e.idToPath[l.id],o(l,a[i],u,u,i)))return;if(t.visitComponentChildren(l,o,r,u,i))return}};t.mountStrategy=function(e,t,n){var o=e.length;return function(t,r,a,i){if(!(a<=e.length)){for(var u=0;u<e.length;++u)if(i[u]!==e[u])return;
return n(t,r,a-e.length,i.slice(o))}}},t.invokerFromRecord=function(e,n,o){t.pushActivity("makeInvoker","beginning instantiation of invoker with name %name and record %record as child of %that",{name:n,record:e,that:o});var r=t.makeInvoker(o,e,n);return t.popActivity(),r},t.memberFromRecord=function(e,n,o){var r=t.expandOptions(e,o,null,null,{freeRoot:!0});return r},t.recordStrategy=function(e,n,o,r,a,i){return i=i||[],{strategy:function(i,u,l){if(1===l){var s=t.driveStrategy(n,[r,u],o);if(void 0!==s){t.set(i,[u],t.inEvaluationMarker);var c=a(s,u,e);return t.set(i,[u],c),c}}},initter:function(){var a=t.driveStrategy(n,r,o)||{};for(var u in a)t.getForComponent(e,i.concat([u]))}}},t.instantiateFirers=function(e){var n=t.shadowForComponent(e),o=t.get(n,["eventStrategyBlock","initter"])||t.identity;o()},t.makeDistributionRecord=function(n,o,r,a,i,u,l){u=u||0,l=l||"distribution";var s=t.copy(t.get(o,r));t.each(i,function(e){t.model.applyChangeRequest(s,{path:e,type:"DELETE"})});var c={options:{}},f=t.isPrimitive(s);return t.model.applyChangeRequest(c,{path:a,type:f?"ADD":"MERGE",value:s}),e.extend(c,{contextThat:n,recordType:l,priority:t.mergeRecordTypes.distribution+u})},t.filterBlocks=function(n,o,r,a,i,u){var l=[],s=0;return t.each(o,function(o){var c=t.get(o.source,r);if(c){l.push(t.makeDistributionRecord(n,o.source,r,a,i,s++,o.recordType));var f=e.extend({},c);u&&t.model.applyChangeRequest(o.source,{path:r,type:"DELETE"}),t.each(i,function(e){var n=t.get(f,e);t.set(o.source,r.concat(e),n)})}}),l},t.matchIoCSelector=function(e,t,n,o,r){for(var a=t.length-1,i=e.length-1;;){for(var u=a===t.length-1||e[i].child,l=t[a],s=e[i],c=!0,f=0;f<s.predList.length;++f){var d=s.predList[f];if(d.context&&!n[a][d.context]&&o[a]!==d.context){c=!1;break}if(d.id&&l.id!==d.id){c=!1;break}}if(0===i&&a>r&&u&&(c=!1),c){if(0===i)return!0;--a,--i}else{if(u)return!1;--a}if(a<r)return!1}},t.noteCollectedDistribution=function(e,n,o){t.model.setSimple(e,["collectedDistributions",n,o.id],!0)},t.isCollectedDistribution=function(e,n,o){return t.model.getSimple(e,["collectedDistributions",n,o.id])},t.clearCollectedDistributions=function(e,n){t.model.applyChangeRequest(e,{path:["collectedDistributions",n],type:"DELETE"})},t.collectDistributions=function(e,n,o,r,a,i,u){var l=i[i.length-1];!t.isCollectedDistribution(n,l,o)&&t.matchIoCSelector(o.selector,r,a,i,u)&&(e.push.apply(e,o.blocks),t.noteCollectedDistribution(n,l,o))},t.registerCollectedClearer=function(e,n,o){!e.collectedClearer&&n&&(e.collectedClearer=function(){t.clearCollectedDistributions(n,o)})},t.receiveDistributions=function(e,n,o,r){var a=t.getInstantiator(e||r),i=a.getThatStack(e||r),u=t.getMemberNames(a,i),l=[],s=t.transform(i,function(e){return a.idToShadow[e.id]}),c=s[s.length-(e?1:2)],f=t.getMembers(s,"contextHash");e?(u.push(o),f.push(t.gradeNamesToHash(n)),i.push(r)):t.registerCollectedClearer(s[s.length-1],c,u[u.length-1]);for(var d=0;d<i.length-1;++d)t.each(s[d].distributions,function(e){t.collectDistributions(l,c,e,i,f,u,d)});return l},t.applyDistributions=function(e,n,o){var r=t.transform(n,function(n){return t.generateExpandBlock(n,e,o.mergePolicy)}),a=o.mergeOptions;return a.mergeBlocks.push.apply(a.mergeBlocks,r),a.updateBlocks(),r},t.parseExpectedOptionsPath=function(e,n){var o=t.model.parseEL(e);return o.length>1&&"options"!==o[0]&&t.fail("Error in options distribution path ",e," - only "+n+' paths beginning with "options" are supported'),o.slice(1)},t.isIoCSSSelector=function(e){return e.indexOf(" ")!==-1},t.pushDistributions=function(e,n,o){var r=t.shadowForComponent(e),a=t.allocateGuid(),i=r.distributions=r.distributions||[];return i.push({id:a,selector:n,blocks:o}),a},t.clearDistributions=function(e,n){var o=t.shadowForComponent(e);t.remove_if(o.distributions,function(e){return e.id===n})},t.extractSelectorHead=function(e){var t=e[0].predList,n=t[0].context;return t.length=0,n},t.undistributableOptions=["gradeNames","distributeOptions","returnedPath","argumentMap","initFunction","mergePolicy","progressiveCheckerOptions"],t.distributeOptions=function(e,n){var o=t.makeArray(t.driveStrategy(e.options,"distributeOptions",n));t.each(o,function(n){var o,r,a=t.parseContextReference(n.target);if(t.isIoCSSSelector(a.context)){r=t.parseSelector(a.context,t.IoCSSMatcher);var i=t.extractSelectorHead(r);"that"!==i&&t.fail('Downwards options distribution not supported from component other than "that"'),o=e}else o=t.resolveContext(a.context,e),o||t.fail("Error in options distribution record ",n," - could not resolve context selector {"+a.context+"} to a root component");var u,l=t.model.parseEL(a.path);if(void 0!==n.record)u=[t.makeDistributionRecord(e,n.record,[],l,[],0)];else{var s=t.shadowForComponent(e),c=t.parseContextReference(n.source||"{that}.options");"that"!==c.context&&t.fail("Error in options distribution record ",n," only a context of {that} is supported");var f=t.parseExpectedOptionsPath(c.path,"source"),d=t.makeArray(n.exclusions).concat(0===f.length?t.undistributableOptions:[]),p=t.transform(d,function(e){return t.model.parseEL(e)});u=t.filterBlocks(e,s.mergeOptions.mergeBlocks,f,l,p,n.removeSource),s.mergeOptions.updateBlocks()}if(r)t.pushDistributions(o,r,u);else{var g=t.shadowForComponent(o);t.applyDistributions(e,u,g)}})},t.gradeNamesToHash=function(e){var n={};return t.each(e,function(e){n[e]=!0,n[t.computeNickName(e)]=!0}),n},t.cacheShadowGrades=function(e,n){var o=t.gradeNamesToHash(e.options.gradeNames);o[e.nickName]=!0,n.contextHash=o},t.deliverOptionsStrategy=function(e,n,o){var r=t.shadowForComponent(e,r);t.cacheShadowGrades(e,r),r.mergeOptions=o},t.resolveReturnedPath=function(e,n){var o=t.shadowForComponent(n);return o&&""!==o.path?null:e},t.defaults("fluid.gradeLinkageRecord",{gradeNames:["fluid.littleComponent"]}),t.defaults("fluid.applyGradeLinkage",{}),t.gradeLinkageIndexer=function(e){if(e.contextGrades&&e.resultGrades)return["*"]},t.getLinkedGrades=function(e){var n=[],o=t.indexDefaults("gradeLinkages",{gradeNames:"fluid.gradeLinkageRecord",indexFunc:t.gradeLinkageIndexer});return t.each(o["*"],function(o){var r=t.defaults(o),a=t.find(t.makeArray(r.contextGrades),function(n){if(!t.contains(e,n))return!0});a||n.push.apply(n,t.makeArray(r.resultGrades))}),n},t.expandDynamicGrades=function(e,n,o,r){var a=[];t.each(r,function(n){var o=t.expandOptions(n,e);"function"==typeof o&&(o=o()),o&&(a=a.concat(o))});var i=t.makeArray(o).concat(a);if(t.contains(i,"fluid.applyGradeLinkage")){var u=t.getLinkedGrades(i);t.remove_if(u,function(e){return t.contains(i,e)}),a=a.concat(u)}var l=t.receiveDistributions(null,null,null,e);if(l.length>0){var s=t.applyDistributions(e,l,n),c=t.transform(t.getMembers(s,["source","gradeNames"]),t.makeArray);a=a.concat.apply(a,c)}return a},t.collectDynamicGrades=function(e,n,o,r,a,i){var u=t.copy(t.getGradedDefaults(e.typeName,i));r.length=0,r.push.apply(r,u.gradeNames),t.cacheShadowGrades(e,n),n.mergeOptions.destroyValue("mergePolicy"),n.mergeOptions.destroyValue("components"),n.mergeOptions.destroyValue("invokers"),o.source=u,n.mergeOptions.updateBlocks();var l=t.remove_if(r,function(e){return"{"===e.charAt(0)&&!t.contains(a,e)},[]);return a.push.apply(a,l),l=t.expandDynamicGrades(e,n,r,l),i.push.apply(i,l),l},t.computeDynamicGrades=function(e,n,o){delete e.options.gradeNames;var r=t.driveStrategy(e.options,"gradeNames",o),a=t.findMergeBlocks(n.mergeOptions.mergeBlocks,"defaults")[0],i=t.remove_if(r,function(e){return"{"===e.charAt(0)||!t.hasGrade(a.target,e)},[]),u=t.expandDynamicGrades(e,n,r,i);if(0!==u.length){var l;do l=t.collectDynamicGrades(e,n,a,r,i,u);while(0!==l.length)}n.collectedClearer&&(n.collectedClearer(),delete n.collectedClearer)},t.computeDynamicComponentKey=function(e,t){return e+(0===t?"":"-"+t)},t.registerDynamicRecord=function(e,n,o,r,a){var i=t.computeDynamicComponentKey(n,o),u=t.copy(r);return delete u[a],t.set(e.options,["components",i],u),i},t.computeDynamicComponents=function(e,n){var o=t.shadowForComponent(e),r=o.subcomponentLocal={},a=t.driveStrategy(e.options,"dynamicComponents",n.strategy);t.each(a,function(n,a){if(n.sources||n.createOnEvent||t.fail("Cannot process dynamicComponents record ",n,' without a "sources" or "createOnEvent" entry'),n.sources){var i=t.expandOptions(n.sources,e);t.each(i,function(o,i){var u=t.registerDynamicRecord(e,a,i,n,"sources");r[u]={source:o,sourcePath:i}})}else if(n.createOnEvent){var u=t.event.expandOneEvent(e,n.createOnEvent);t.set(o,["dynamicComponentCount",a],0);var l=function(){var i=t.registerDynamicRecord(e,a,o.dynamicComponentCount[a]++,n,"createOnEvent");r[i]={arguments:t.makeArray(arguments)},t.initDependent(e,i)};u.addListener(l),t.recordListener(u,l,o)}})},t.computeComponentAccessor=function(e){var n=t.shadowForComponent(e),o=e.options,r=n.mergeOptions.strategy,a=t.mountStrategy(["options"],o,r);n.invokerStrategy=t.recordStrategy(e,o,r,"invokers",t.invokerFromRecord),n.eventStrategyBlock=t.recordStrategy(e,o,r,"events",t.eventFromRecord,["events"]);var i=t.mountStrategy(["events"],e,n.eventStrategyBlock.strategy,["events"]);return n.memberStrategy=t.recordStrategy(e,o,r,"members",t.memberFromRecord),n.getConfig={strategies:[t.model.funcResolverStrategy,t.makeGingerStrategy(e),a,n.invokerStrategy.strategy,n.memberStrategy.strategy,i]},t.computeDynamicGrades(e,n,r,n.mergeOptions.mergeBlocks),t.distributeOptions(e,r),n.getConfig},t.shadowForComponent=function(e){var n=t.getInstantiator(e);return n&&e?n.idToShadow[e.id]:null},t.getForComponent=function(e,n){var o=t.shadowForComponent(e),r=o?o.getConfig:void 0;return t.get(e,n,r)},t.makeGingerStrategy=function(e){var n=t.getInstantiator(e);return function(e,o,r,a){var i=e[o];if(i===t.inEvaluationMarker&&r===a.length&&t.fail('Error in component configuration - a circular reference was found during evaluation of path segment "'+o+'": for more details, see the activity records following this message in the console, or issue fluid.setLogging(fluid.logLevel.TRACE) when running your application'),r>1)return i;if(void 0===i&&e.hasOwnProperty(o))return t.NO_VALUE;if(void 0===i){var u=n.idToShadow[e.id].path,l=t.composePath(u,o);i=n.pathToComponent[l]}if(void 0===i){var s=t.getForComponent(e,["options","components",o]);s&&(s.createOnEvent&&t.fail('Error resolving path segment "'+o+'" of path '+a.join(".")+" since component with record ",s,' has annotation "createOnEvent" - this very likely represents an implementation error. Either alter the reference so it does not  match this component, or alter your workflow to ensure that the component is instantiated by the time this reference resolves'),t.initDependent(e,o),i=e[o])}return i}},t.filterBuiltinGrades=function(e){return t.remove_if(t.makeArray(e),function(e){return/^(autoInit|fluid.littleComponent|fluid.modelComponent|fluid.eventedComponent|fluid.viewComponent|fluid.typeFount)$/.test(e)})},t.dumpGradeNames=function(e){return e.options&&e.options.gradeNames?" gradeNames: "+JSON.stringify(t.filterBuiltinGrades(e.options.gradeNames)):""},t.dumpThat=function(e){return'{ typeName: "'+e.typeName+'"'+t.dumpGradeNames(e)+" id: "+e.id+"}"},t.dumpThatStack=function(e,n){var o=t.transform(e,function(e){var o=n.idToPath(e.id);return t.dumpThat(e)+(o?" - path: "+o:"")});return o.join("\n")},t.resolveContext=function(e,n){var o=t.getInstantiator(n);if("instantiator"===e)return o;if("that"===e)return n;var a,i=o.getFullStack(n);return r(o,i,function(n,o){var r=t.shadowForComponent(n);return e===o||r&&r.contextHash&&r.contextHash[e]||e===n.typeName||e===n.nickName?(a=n,!0):t.getForComponent(n,["options","components",e,"type"])&&!n[e]?(a=t.getForComponent(n,e),!0):void 0}),a};var a=/^(arguments|options|container|source|sourcePath|change)$/;t.makeStackFetcher=function(e,n){var o=function(o){e&&e.destroy===t.destroyedMarker&&t.fail("Cannot resolve reference "+t.renderContextReference(o)+" from component "+t.dumpThat(e)+" which has been destroyed");var r=o.context;if(n&&a.test(r)){var i=t.get(n[r],o.path);return"arguments"===r||"source"===r||"sourcePath"===r||"change"===r?i:{marker:"options"===r?t.EXPAND:t.EXPAND_NOW,value:i}}var u=t.resolveContext(r,e);if(!u&&""!==o.path){var l=t.renderContextReference(o);t.fail("Failed to resolve reference "+l+" - could not match context with name "+r+" from component "+t.dumpThat(e),e)}return t.getForComponent(u,o.path)};return o},t.makeStackResolverOptions=function(n,o){return e.extend(t.copy(t.rawDefaults("fluid.makeExpandOptions")),{fetcher:t.makeStackFetcher(n,o),contextThat:n})},t.clearListeners=function(e){t.each(e.listeners,function(e){e.event.removeListener(e.listener)}),delete e.listeners},t.recordListener=function(e,t,n){if(e.ownerId!==n.that.id){var o=n.listeners;o||(o=n.listeners=[]),o.push({event:e,listener:t})}};var i={};t.instantiator=function(e){function n(e,n,r){if(r){i[e.id]=o;var a=o.idToShadow[e.id]={};a.that=e,a.path=n}o.pathToComponent[n]&&t.fail("Error during instantiation - path "+n+" which has just created component "+t.dumpThat(e)+" has already been used for component "+t.dumpThat(o.pathToComponent[n])+" - this is a circular instantiation or other oversight. Please clear the component using instantiator.clearComponent() before reusing the path."),o.pathToComponent[n]=e}var o={id:t.allocateGuid(),free:e,nickName:"instantiator",pathToComponent:{},idToShadow:{},modelTransactions:{init:{}},composePath:t.composePath};return o.idToPath=function(e){var t=o.idToShadow[e];return t?t.path:""},o.getThatStack=function(e){var n=o.idToShadow[e.id];if(n){var r=n.path,a=t.model.parseEL(r),i=t.transform(a,function(e,n){var r=t.model.composeSegments.apply(null,a.slice(0,n+1));return o.pathToComponent[r]}),u=o.pathToComponent[""];return u&&i.unshift(u),i}return[e]},o.getEnvironmentalStack=function(){var n=[t.staticEnvironment];return e||n.push(t.globalThreadLocal()),n},o.getFullStack=function(e){var t=e?o.getThatStack(e):[];return o.getEnvironmentalStack().concat(t)},o.recordRoot=function(e){e&&e.id&&!o.pathToComponent[""]&&n(e,"",!0)},o.recordKnownComponent=function(e,t,r,a){var i=o.idToShadow[e.id].path,u=o.composePath(i,r);n(t,u,a)},o.clearComponent=function(e,n,r,a,u,l){var s=o.idToShadow[e.id].path;a=a||{flat:!0,instantiator:o},r=r||e[n],l=l||s,void 0===l&&t.fail("Cannot clear component "+n+" from component ",e," which was not created by this instantiator"),t.fireEvent(r,"events.onClear",[r,n,e]);var c=o.composePath(l,n),f=o.idToShadow[r.id];f&&f.path===c&&(t.doDestroy(r,n,e),t.clearListeners(f),t.visitComponentChildren(r,function(e,t,n,i){o.clearComponent(r,t,null,a,!0,i)},a,c),t.fireEvent(r,"events.afterDestroy",[r,n,e]),delete o.idToShadow[r.id],delete i[r.id]),delete o.pathToComponent[c],u||delete e[n]},o},t.freeInstantiator=t.instantiator(!0),t.getInstantiator=function(e){return e&&i[e.id]||t.freeInstantiator},t.expandOptions=function(e,n,o,r,a){if(!e)return e;t.pushActivity("expandOptions","expanding options %args for component %that ",{that:n,args:e});var i=t.makeStackResolverOptions(n,r);i.mergePolicy=o,i.freeRoot=a&&a.freeRoot;var u=a&&a.defer?t.makeExpandOptions(e,i):t.expand(e,i);return t.popActivity(),u},t.localRecordExpected=["type","options","args","mergeOptions","createOnEvent","priority","recordType"],t.checkComponentRecord=function(e,n){var o=t.arrayToHash(t.localRecordExpected);t.each(e&&e.argumentMap,function(e,t){o[t]=!0}),t.each(n,function(e,n){o[n]||t.fail('Probable error in subcomponent record - key "'+n+'" found, where the only legal options are '+t.keys(o).join(", "))})},t.pushDemands=function(e,n){function o(t){t.recordType="demands",t.priority=a++,e.push(t)}function r(e){o({options:e})}n=t.makeArray(n);for(var a=t.mergeRecordTypes.demands,i=0;i<n.length;++i){var u=n[i];if(u.options)o(u);else if(u.mergeOptions){var l=t.makeArray(u.mergeOptions);t.each(l,r)}else t.fail("Uninterpretable demands record without options or mergeOptions ",u)}},t.mergeRecordsToList=function(e){var n=[];return t.each(e,function(e,o){if(e.recordType=o,"distributions"===o)n.push.apply(n,e);else if("demands"!==o){if(!e.options)return;e.priority=t.mergeRecordTypes[o],void 0===e.priority&&t.fail("Merge record with unrecognised type "+o+": ",e),n.push(e)}else t.pushDemands(n,e)}),n};var u=function(e){return t.each(["gradeNames","mergePolicy","argumentMap","components","dynamicComponents","members","invokers","events","listeners","modelListeners","distributeOptions","transformOptions"],function(n){t.set(e,[n,"*","noexpand"],!0)}),e};t.generateExpandBlock=function(e,n,o,r){var a=t.expandOptions(e.options,e.contextThat||n,o,r,{defer:!0});return a.priority=e.priority,a.recordType=e.recordType,a};var l=function(n,o,r,a){var i=t.copy(o);u(n);var l=t.shadowForComponent(a);l.mergePolicy=n;var s={defaults:{options:i}};r&&(r.marker===t.EXPAND?(e.extend(s,r.mergeRecords),s.subcomponentRecord&&t.checkComponentRecord(o,s.subcomponentRecord)):s.user={options:t.expandCompact(r,!0)});var c=t.mergeRecordsToList(s),f=t.transform(c,function(e){return t.generateExpandBlock(e,a,n,r&&r.localRecord)});return f};t.makeIoCRootDestroy=function(e,t){return function(){e.clearComponent(t,"",t,null,!0)}},t.fabricateDestroyMethod=function(e,t,n,o){return function(){n.clearComponent(e,t,o)}},t.expandComponentOptions=function(e,n,o,r){var a,i=o&&o.marker===t.EXPAND&&void 0!==o.memberName?o.instantiator:null;i||(i=t.instantiator(),a=!0,t.log("Created new instantiator with id "+i.id+" in order to operate on component "+(r?r.typeName:"[none]")),r.destroy=t.makeIoCRootDestroy(i,r)),t.pushActivity("expandComponentOptions","expanding component options %options with record %record for component %that",{options:o&&o.mergeRecords,record:o,that:r}),a?i.recordRoot(r):i.recordKnownComponent(o.parentThat,r,o.memberName,!0);var u=l(e,n,o,r);return t.popActivity(),u},t.argMapToDemands=function(e){var n=[];return t.each(e,function(e,t){n[e]="{"+t+"}"}),n},t.makePassArgsSpec=function(e){return t.transform(e,function(e,t){return"{arguments}."+t})},t.pushDemandSpec=function(e,t,n){t&&"{options}"!==t&&e.push({options:t}),n&&e.push({mergeOptions:n})},t.embodyDemands=function(n,o,r,a){a=a||{},o.mergeOptions&&o.options&&t.fail("demandspec ",o," is invalid - cannot specify literal options together with mergeOptions"),o.transformOptions&&(o.options=e.extend(!0,{},o.options,{transformOptions:o.transformOptions}));var i=t.makeArray(o.args),u=t.defaults(o.funcName),l={},s=u&&n?t.receiveDistributions(n,u.gradeNames,a.memberName,l):[],c=u?u.argumentMap:null,f=!1;if(u&&(a.passArgs=!1),!c&&(u||a&&a.componentRecord))if(f=!0,i.length<2)c=t.rawDefaults("fluid.littleComponent").argumentMap;else{var d=e.inArray("{options}",i);d===-1&&(d=i.length-1),c={options:d}}a=a||{},0===i.length&&(c?i=t.argMapToDemands(c):a.passArgs&&(i=t.makePassArgsSpec(r)));var p=t.shadowForComponent(n),g=p&&a.memberName?p.subcomponentLocal[a.memberName]:null,m=e.extend({arguments:r},t.censorKeys(a.componentRecord,["type"]),g);t.each(c,function(e,t){if(r.length>0&&(m[t]=m.arguments[e]),void 0!==o[t]&&void 0===m[t]&&(m[t]=o[t]),"options"!==t)for(var n=0;n<s.length;++n)void 0!==s[n][t]&&(m[t]=s[n][t])});var v;for(v=0;v<s.length;++v)void 0!==s[v].type&&(o.funcName=s[v].type);var h={distributions:s};void 0!==a.componentRecord&&(h.subcomponentRecord=e.extend({},a.componentRecord));var k=t.makeStackResolverOptions(n,m),y=function(e){t.pushDemandSpec(h.demands,e.options,e.mergeOptions)},b=[];if(i)for(v=0;v<i.length;++v){var C=i[v];if(t.isMarker(C)&&C.value===t.COMPONENT_OPTIONS.value&&(C="{options}",f&&(c={options:v})),"string"==typeof C&&"@"===C.charAt(0)){var A=C.substring(1);C="{arguments}."+A}i[v]=C,c&&c.options===v?(a.passArgs&&t.fail("Error invoking function "+o.funcName+": found component creator rather than free function"),"object"!=typeof C||C.targetTypeName||(C.targetTypeName=o.funcName),h.demands=[],t.each(o.backSpecs.reverse(),y),t.pushDemandSpec(h.demands,o.options||C,o.mergeOptions),r.length>0&&(h.user={options:m.options}),b[v]={marker:t.EXPAND,localRecord:g,mergeRecords:h,instantiator:t.getInstantiator(n),parentThat:n,memberName:a.memberName}):b[v]=t.expand(C,k),b[v]&&t.isMarker(b[v].marker,t.EXPAND_NOW)&&(b[v]=t.expand(b[v].value,k))}else b=r?r:[];var S={args:b,preExpand:i,funcName:o.funcName};return S},t.initDependent=function(e,n,o){if(!e[n]){o=o||[];var r=e.options.components[n];t.pushActivity("initDependent",'instantiating dependent component with name "%name" with record %record as child of %parent',{name:n,record:r,parent:e});var a,u=i[e.id];if("string"==typeof r)a=t.expandOptions(r,e),u.recordKnownComponent(e,a,n,!1);else if(r.type){var l=t.expandOptions(r.type,e);l||t.fail("Error in subcomponent record: ",r.type," could not be resolved to a type for component ",n," of parent ",e);var s=t.resolveDemands(e,[l,n],o,{componentRecord:r,memberName:n});a=t.initSubcomponentImpl(e,{type:s.funcName},s.args);var c=u.composePath(u.idToPath(e.id),n),f=u.pathToComponent[c];f&&f!==a&&u.clearComponent(e,n,f),a&&a.typeName&&a.id&&a!==f&&u.recordKnownComponent(e,a,n,!0),a.destroy=t.fabricateDestroyMethod(e,n,u,a)}else t.fail("Unrecognised material in place of subcomponent "+n+' - no "type" field found');return e[n]=a,t.fireEvent(a,"events.onAttach",[a,n,e]),t.popActivity(),a}},t.bindDeferredComponent=function(e,n,o){var r=t.makeArray(o.createOnEvent);t.each(r,function(r){var a="{"===r.charAt(0)?t.expandOptions(r,e):e.events[r];a&&a.addListener||t.fail("Error instantiating createOnEvent component with name "+n+" of parent ",e," since event specification "+r+" could not be expanded to an event - got ",a),a.addListener(function(){if(t.pushActivity("initDeferred","instantiating deferred component %componentName of parent %that due to event %eventName",{componentName:n,that:e,eventName:r}),e[n]){var o=i[e.id];o.clearComponent(e,n)}t.initDependent(e,n),t.popActivity()},null,null,o.priority)})},t.priorityForComponent=function(e){return e.priority?e.priority:"fluid.typeFount"===e.type||t.hasGrade(t.defaults(e.type),"fluid.typeFount")?"first":void 0},t.initDependents=function(e){t.pushActivity("initDependents","instantiating dependent components for component %that",{that:e});var n=t.shadowForComponent(e);n.memberStrategy.initter();var o=e.options,r=o.components||{},a={};t.each(r,function(n,o){if(n.createOnEvent)t.bindDeferredComponent(e,o,n);else{var r=t.priorityForComponent(n);a[o]=[{key:o,priority:t.event.mapPriority(r,0)}]}});var i=t.event.sortListeners(a);t.each(i,function(n){t.initDependent(e,n.key)}),n.invokerStrategy.initter(),t.popActivity()};var s={},c=!1;t.setDemandLogging=function(e){c=e},t.isDemandLogging=function(){return c&&t.isLogging()},t.demands=function(e,o,r){var a=t.makeArray(o).sort();if(!r)return n(e,a);if(r.length&&(r={args:r}),t.getCallerInfo&&t.isDemandLogging()){var i=t.getCallerInfo(5);i&&(r.registeredFrom=i)}r.demandId=t.allocateGuid();var u=s[e];u||(u=[],s[e]=u),u.push({contexts:a,spec:r})},t.compareDemands=function(e,t){return t.intersect-e.intersect},t.locateAllDemands=function(e,n){var o=t.isDemandLogging(n);o&&t.log("Resolving demands for function names ",n," in context of "+(e?"component "+e.typeName:"no component"));var a={},i=[],u=t.getInstantiator(e),l=u.getFullStack(e);r(u,l,function(e,n,o,r,u){a[e.typeName]=u;var l=t.makeArray(t.get(e,["options","gradeNames"]));t.each(l,function(e){a[e]=u}),i.push(e)}),o&&t.log("Components in scope for resolution:\n"+t.dumpThatStack(i,u));for(var c=[],f=0;f<n.length;++f)for(var d=s[n[f]]||[],p=0;p<d.length;++p){for(var g=d[p],m=g.spec.horizon?a[g.spec.horizon]:-1,v={spec:g,intersect:0,uncess:0},h=0;h<g.contexts.length;++h){var k=a[g.contexts[h]];v[void 0!==k&&k>=m?"intersect":"uncess"]+=2}0===g.contexts.length&&v.intersect++,0===v.uncess&&c.push(v)}return c.sort(t.compareDemands),c},t.locateDemands=function(e,n){var o=t.locateAllDemands(e,n),r=t.getMembers(o,["spec","spec"]);return t.isDemandLogging(n)&&(r.length?t.log("Located "+o.length+" potential match"+(1===o.length?"":"es")+", selected best match with "+o[0].intersect+" matched context names: ",r):t.log("No matches found for demands, using direct implementation")),r},t.determineDemands=function(n,o){o=t.makeArray(o);var r=o[0],a=t.locateDemands(n,o);return a.length&&a[0].funcName&&(r=a[0].funcName),e.extend(!0,{funcName:r,args:a[0]?t.makeArray(a[0].args):[]},{backSpecs:a.slice(1)},t.censorKeys(a[0],["funcName","args"]))},t.resolveDemands=function(e,n,o,r){var a=t.determineDemands(e,n);return t.embodyDemands(e,a,o,r)},t.thisistToApplicable=function(e,n,o){return{apply:function(r,a){var i=t.expandOptions(n,o);"string"==typeof i&&(i=t.getGlobalValue(i)),i||t.fail("Could not resolve reference "+n+" to a value");var u=i[e.method];return"function"!=typeof u&&t.fail("Object ",i," at reference "+n+" has no member named "+e.method+" which is a function "),t.log("Applying arguments ",a," to method "+e.method+" of instance ",i),u.apply(i,a)}}},t.changeToApplicable=function(e,n){return{apply:function(o,r){var a=t.parseValidModelReference(n,"changePath listener record",e.changePath),i=t.expandOptions(e.value,n,{},{arguments:r});t.fireSourcedChange(a.applier,a.path,i,e.source)}}},t.recordToApplicable=function(e,n){if(e.changePath)return t.changeToApplicable(e,n);var o=e.this;return e.method^o&&t.fail("Record ",n,' must contain both entries "method" and "this" if it contains either'),e.method?t.thisistToApplicable(e,o,n):null},t.invoke=function(e,n,o,r){t.pushActivity("invokeFunc",'invoking function with name "%functionName" from component %that',{functionName:e,that:o});var a=t.resolveDemands(o,e,t.makeArray(n),{passArgs:!0}),i=t.invokeGlobalFunction(a.funcName,a.args,r);return t.popActivity(),i},t.makeFreeInvoker=function(e,n){var o=t.determineDemands(null,e);return function(){var e=t.embodyDemands(null,o,t.makeArray(arguments),{passArgs:!0});return t.invokeGlobalFunction(e.funcName,e.args,n)}};var f="{arguments}.";t.parseInteger=function(e){return isFinite(e)&&e%1===0?Number(e):NaN},t.makeFastInvoker=function(e,n){var o;if(e.preExpand){o={};for(var r=0;r<e.preExpand.length;++r){var a=e.preExpand[r];if("string"==typeof a){if(a.indexOf("}.model")!==-1)return{noFast:!0};if("{arguments}"===a)o[r]="*";else if(0===a.indexOf(f)){var i=t.parseInteger(a.substring(f.length));if(isNaN(i))return{noFast:!0};o[r]=i}}}}var u=e.args,l=o?function(e){for(var t in o)u[t]="*"===o[t]?e:e[o[t]];return n.apply(null,u)}:function(e){return n.apply(null,e)};return{invoke:l}},t.makeInvoker=function(e,n,o,r){var a;"string"==typeof n&&("{"===n.charAt(0)?n={func:n}:a=n);var i=a?t.determineDemands(e,a):n,u={noFast:n.dynamic};return function(){t.defeatLogging===!1&&t.pushActivity("invokeInvoker","invoking invoker with name %name and record %record from component %that",{name:o,record:n,that:e});var a;if(u.invoke)a=u.invoke(arguments);else{var l=t.recordToApplicable(n,e),s=t.makeArray(arguments),c=t.embodyDemands(e,i,s,{passArgs:!0});l=l||(c.funcName?t.getGlobalValue(c.funcName,r):t.expandOptions(i.func,e)),l&&l.apply||t.fail("Error in invoker record: could not resolve members func, funcName or method to a function implementation - got "+l+" from ",i),u.noFast!==!0&&(u=t.makeFastInvoker(c,l)),a=l.apply(null,c.args)}return t.defeatLogging===!1&&t.popActivity(),a}},t.event.makeTrackedListenerAdder=function(e){var n=t.shadowForComponent(e);return function(e){return{addListener:function(o){t.recordListener(e,o,n),e.addListener.apply(null,arguments)}}}},t.event.listenerEngine=function(e,n,o){function r(){var o=t.find(e,function(e,t){if(void 0===a[t])return!0});if(!o){var r=a;a={},n(r)}}var a={};t.each(e,function(e,n){o(e).addListener(function(){a[n]=t.makeArray(arguments),r()})})},t.event.dispatchListener=function(e,n,o,r,a){var i=function(){t.pushActivity("dispatchListener","firing to listener to event named %eventName of component %that",{eventName:o,that:e});var i=a?arguments[0]:t.makeArray(arguments),u=t.determineDemands(e,o);0===u.args.length&&r.args&&(u.args=r.args);var l=t.embodyDemands(e,u,i,{passArgs:!0}),s=t.event.invokeListener(n,l.args);return t.popActivity(),s};return t.event.impersonateListener(n,i),i},t.event.resolveSoftNamespace=function(e){if("string"!=typeof e)return null;var t=Math.max(e.lastIndexOf("."),e.lastIndexOf("}"));return e.substring(t+1)},t.event.resolveListenerRecord=function(e,n,o,r,a){var i=function(e,n){t.fail("Error in listener record - could not resolve reference ",e,' to a listener or firer. Did you miss out "events." when referring to an event firer?'+n)};t.pushActivity("resolveListenerRecord","resolving listener record for event named %eventName for component %that",{eventName:o,that:n});var u=t.makeArray(e),l=t.transform(u,function(e){var u=t.isPrimitive(e)||e.expander?{listener:e}:t.copy(e),l=t.recordToApplicable(e,n);l?u.listener=l:u.listener=u.listener||u.func||u.funcName,u.listener||i(e,' Listener record must contain a member named "listener", "func", "funcName" or "method"');var s=e.method?t.event.resolveSoftNamespace(e.this)+"."+e.method:t.event.resolveSoftNamespace(u.listener);u.namespace||r||!s||(u.softNamespace=!0,u.namespace=(e.componentSource?e.componentSource:n.typeName)+"."+s);var c=u.listener=t.expandOptions(u.listener,n);c||i(e,"");var f=!1;return"fluid.event.firer"===c.typeName&&(c=c.fire,f=!0),u.listener=a&&(u.args||f)?t.event.dispatchListener(n,c,o,u):c,u}),s={records:l,adderWrapper:a?t.event.makeTrackedListenerAdder(n):null};return t.popActivity(),s},t.event.expandOneEvent=function(e,n){var o;return o="string"==typeof n&&"{"!==n.charAt(0)?t.getForComponent(e,["events",n]):t.expandOptions(n,e),o&&"fluid.event.firer"===o.typeName||t.fail("Error in event specification - could not resolve base event reference ",n," to an event firer: got ",o),o},t.event.expandEvents=function(e,n){return"string"==typeof n?t.event.expandOneEvent(e,n):t.transform(n,function(n){return t.event.expandOneEvent(e,n)})},t.event.resolveEvent=function(e,n,o){t.pushActivity("resolveEvent","resolving event with name %eventName attached to component %that",{eventName:n,that:e});var r=t.event.makeTrackedListenerAdder(e);"string"==typeof o&&(o={event:o});var a=o.event||o.events;a||t.fail("Event specification for event with name "+n+" does not include a base event specification: ",o);var i,u=t.event.expandEvents(e,a),l="fluid.event.firer"!==u.typeName,s=o.args||l;if(s){i=t.makeEventFirer({name:" [composite] "+t.event.nameEvent(e,n)});var c=t.event.dispatchListener(e,i.fire,n,o,l);l?t.event.listenerEngine(u,c,r):r(u).addListener(c)}else i={typeName:"fluid.event.firer"},i.fire=function(){var e=t.makeArray(arguments);t.pushActivity("fireSynthetic","firing synthetic event %eventName ",{eventName:n});var o=u.fire.apply(null,e);return t.popActivity(),o},i.addListener=function(a,i,l,s,c){var f=t.event.dispatchListener(e,a,n,o);r(u).addListener(f,i,l,s,c)},i.removeListener=function(e){u.removeListener(e)};return t.popActivity(),i},t.withEnvironment=function(n,o,r){return r=r||t.globalThreadLocal(),t.tryCatch(function(){for(var t in n)r[t]=n[t];return e.extend(r,n),o()},null,function(){for(var e in n)delete r[e]})},t.fetchContextReference=function(e,n,o,r,a){r&&(e=r(e,o));var i=e.context?o[e.context]:n;if(!i){var u=a&&a(e);return u||i}return e.noDereference?e.path:t.get(i,e.path)},t.makeEnvironmentFetcher=function(e,n,o,r){return o=o||t.globalThreadLocal,function(a){var i=o();return t.fetchContextReference(a,e,i,n,r)}},t.coerceToPrimitive=function(e){return"false"!==e&&("true"===e||(isFinite(e)?Number(e):e))},t.compactStringToRec=function(n,o){var r=n.indexOf("("),a=n.indexOf(")");if((r===-1^a===-1||r>a)&&t.fail("Badly-formed compact "+o+" record without matching parentheses: ",n),r!==-1&&a!==-1){var i=n.substring(0,r),u=n.substring(r+1,a),l=t.transform(u.split(","),e.trim,t.coerceToPrimitive),s={args:l};return"invoker"===o&&"!"===i.charAt(r-1)&&(i=n.substring(0,r-1),s.dynamic=!0),s["{"===i.charAt(0)?"func":"funcName"]=i,s}return"expander"===o&&t.fail("Badly-formed compact expander record without parentheses: ",n),n},t.expandPrefix="@expand:",t.expandCompactString=function(e,n){var o=e;if(0===e.indexOf(t.expandPrefix)){var r=e.substring(t.expandPrefix.length);
o={expander:t.compactStringToRec(r,"expander")}}else n&&(o=t.compactStringToRec(e,n));return o};var d={listeners:"listener",modelListeners:"modelListener"},p=e.extend({invokers:"invoker"},d);t.expandCompactRec=function(e,n,o,r){var a=e.length>0?e[e.length-1]:"",i=p[a];!i&&e.length>1&&(i=d[e[e.length-2]]),t.each(o,function(o,a){return!t.isPlainObject(o)||t.isDOMish(o)||r&&"model"===a&&0===e.length?("string"==typeof o&&(o=t.expandCompactString(o,i)),void(n[a]=o)):(n[a]=t.freshContainer(o),e.push(a),t.expandCompactRec(e,n[a],o),void e.pop())})},t.expandCompact=function(e,n){var o={};return t.expandCompactRec([],o,e,n),o},t.extractEL=function(e,t){if("ALL"===t.ELstyle)return e;if(1===t.ELstyle.length){if(e.charAt(0)===t.ELstyle)return e.substring(1)}else if("${}"===t.ELstyle){var n=e.indexOf("${"),o=e.lastIndexOf("}");if(0===n&&o!==-1)return e.substring(2,o)}},t.extractELWithContext=function(e,n){var o=t.extractEL(e,n);return o&&"{"===o.charAt(0)&&o.indexOf("}")>0?t.parseContextReference(o):o?{path:o}:o},t.parseContextReference=function(e,n,o){n=n||0;var r=e.indexOf("}",n+1);r===-1&&t.fail('Cannot parse context reference "'+e+'": Malformed context reference without }');var a=e.substring(n+1,r),i=o?e.indexOf(o,r+1):e.length,u=e.substring(r+1,i);return"."===u.charAt(0)&&(u=u.substring(1)),{context:a,path:u,endpos:i}},t.renderContextReference=function(e){return"{"+e.context+"}"+(e.path?"."+e.path:"")},t.resolveContextValue=function(e,n){function o(o){t.pushActivity("resolveContextValue","resolving context value %string",{string:e});var r=n.fetcher(o);return t.pushActivity("resolvedContextValue","resolved value %string to value %value",{string:e,value:r}),t.popActivity(2),r}var r;if(n.bareContextRefs&&"{"===e.charAt(0)&&e.indexOf("}")>0)return r=t.parseContextReference(e),o(r);if(n.ELstyle&&"${}"!==n.ELstyle&&(r=t.extractELWithContext(e,n)))return o(r);for(;"string"==typeof e;){var a=e.indexOf("${"),i=e.indexOf("}",a+2);if(a===-1||i===-1)break;"{"===e.charAt(a+2)?(r=t.parseContextReference(e,a+2,"}"),i=r.endpos):r={path:e.substring(a+2,i)};var u=o(r),l=0===a&&i===e.length-1;if(void 0===u||null===u)return u;e=l?u:e.substring(0,a)+u+e.substring(i+1)}return e},t.expandExpander=function(e,n,o){var r=t.getGlobalValue(n.expander.type||"fluid.deferredInvokeCall");if(r)return r.call(null,e,n,o)},t.fetchExpandChildren=function(n,o,r,a,i,u,l){if(a.expander){var s=t.expandExpander(n,a,l);if(l.freeRoot||t.isPrimitive(s)||t.isDOMish(s)||!t.isPlainObject(s)||t.isArrayable(s)^t.isArrayable(n))return s;e.extend(!0,n,s)}return t.each(a,function(e,t){void 0===e?n[t]=void 0:"expander"!==t&&(r[o]=t,l.strategy(n,t,o+1,r,a,i,u))}),n},t.isUnexpandable=function(e){return t.isPrimitive(e)||t.isComponent(e)||void 0!==e.nodeType||e.jquery||!t.isPlainObject(e)},t.expandSource=function(e,n,o,r,a,i,u,l,s){var c,f,d,p=t.derefMergePolicy(u);return"string"!=typeof i||p.noexpand?p.noexpand||t.isUnexpandable(i)?c=i:i.expander?c=t.expandExpander(a,i,e):(p.preserve?(c=i,d=!0):c=t.freshContainer(i),f=!0):e.defaultEL&&"{"!==i.charAt(0)?c=i:(t.pushActivity("expandContextValue","expanding context value %source held at path %path",{source:i,path:t.path.apply(null,r.slice(0,o))}),c=t.resolveContextValue(i,e),t.popActivity(1)),d||c===t.NO_VALUE||a(c),f&&s(c,i,o,r,u,l||d),d&&c!==t.NO_VALUE&&a(c),c},t.makeExpandStrategy=function(e){var n=function(n,o,r,a,i,u){return t.fetchExpandChildren(n,r||0,a||[],o,i,u,e)},r=function(r,a,i,u,l,s,c){function f(e){r[a]=e}if(i>t.strategyRecursionBailout&&t.fail("Overflow/circularity in options expansion, current path is ",u," at depth ",i,' - please ensure options are not circularly connected, or protect from expansion using the "noexpand" policy or expander'),r){if(!c&&r.hasOwnProperty(a))return r[a];void 0===l&&(l=o(e.source,u,i-1,e.sourceStrategy),s=o(e.mergePolicy,u,i-1,t.concreteTrundler));var d=e.sourceStrategy(l,a,i,u),p=t.concreteTrundler(s,a);return t.expandSource(e,r,i,u,f,d,p,c,n)}};return e.recurse=n,e.strategy=r,r},t.defaults("fluid.makeExpandOptions",{ELstyle:"${}",bareContextRefs:!0,target:t.inCreationMarker}),t.makeExpandOptions=function(n,o){return o=e.extend({},t.rawDefaults("fluid.makeExpandOptions"),o),o.defaultEL="${}"===o.ELStyle&&o.bareContextRefs,o.expandSource=function(e){return t.expandSource(o,null,0,[],t.identity,e,o.mergePolicy,!1)},t.isUnexpandable(n)?(o.strategy=t.concreteTrundler,o.initter=t.identity,"string"==typeof n?o.target=o.expandSource(n):o.target=n):(o.source=n,o.target=t.freshContainer(n),o.sourceStrategy=o.sourceStrategy||t.concreteTrundler,t.makeExpandStrategy(o),o.initter=function(){o.target=t.fetchExpandChildren(o.target,0,[],o.source,o.mergePolicy,!1,o)}),o},t.expand=function(e,n){var o=t.makeExpandOptions(e,n);return o.initter(),o.target},t.registerNamespace("fluid.expander"),t.expander.deferredCall=function(e,n,o){var r=n.expander,a=!r.args||t.isArrayable(r.args)?r.args:t.makeArray(r.args);return a=o.recurse([],a),t.invokeGlobalFunction(r.func,a)},t.deferredCall=t.expander.deferredCall,t.deferredInvokeCall=function(e,n,o){var r=n.expander,a=t.makeArray(r.args);a=o.recurse([],a);var i=r.func||r.funcName,u=o.expandSource(i)||t.recordToApplicable(r,o.contextThat);return u||t.fail("Error in expander record - "+i+" could not be resolved to a function for component ",o.contextThat),u.apply?u.apply(null,a):t.invoke(u,a,o.contextThat)},t.expander.noexpand=function(e,t){return t.expander.value?t.expander.value:t.expander.tree},t.noexpand=t.expander.noexpand}(jQuery,fluid_2_0);var fluid_2_0=fluid_2_0||{};!function(e,t){"use strict";function n(e){return e.lastIndexOf(".")}function o(e,n){return function(o){var r=n().sources,a=arguments,i=o.source||"";t.tryCatch(function(){void 0===r[i]&&(r[i]=0),++r[i],e.apply(null,a)},null,function(){--r[i]})}}t.model.makeEnvironmentStrategy=function(e){return function(t,n,o){return 0===o&&e[n]?e[n]:void 0}},t.model.defaultCreatorStrategy=function(e,t){if(void 0===e[t])return e[t]={},e[t]},t.model.defaultFetchStrategy=function(e,t){return e[t]},t.model.funcResolverStrategy=function(e,t){if(e.resolvePathSegment)return e.resolvePathSegment(t)},t.model.traverseWithStrategy=function(e,n,o,r,a){for(var i=r.strategies,u=n.length-a,l=o;l<u;++l){if(!e)return e;for(var s,c=0;c<i.length&&(s=i[c](e,n[l],l+1,n),void 0===s);++c);s===t.NO_VALUE&&(s=void 0),e=s}return e},t.model.getValueAndSegments=function(e,n,o,r){return t.model.accessWithStrategy(e,n,t.NO_VALUE,o,r,!0)},t.model.makeTrundler=function(e){return function(n,o){return t.model.getValueAndSegments(n.root,o,e,n.segs)}},t.model.getWithStrategy=function(e,n,o,r){return t.model.accessWithStrategy(e,n,t.NO_VALUE,o,r)},t.model.setWithStrategy=function(e,n,o,r,a){t.model.accessWithStrategy(e,n,o,r,a)},t.model.accessWithStrategy=function(e,n,o,r,a,i){if(t.isPrimitive(n)||t.isArrayable(n))return t.model.accessImpl(e,n,o,r,a,i,t.model.traverseWithStrategy);var u=n.type||"default",l=r.resolvers[u];l||t.fail("Unable to find resolver of type "+u);var s=t.model.makeTrundler(r),c={root:e,segs:a};return c=l(c,n,s),n.path&&c&&(c=s(c,n.path)),i?c:c?c.root:void 0},t.registerNamespace("fluid.pathUtil");var r=function(e,t,n){var o=null;e&&(o="");for(var r=!1,a=t.length;n<a;++n){var i=t.charAt(n);if(r)r=!1,null!==o&&(o+=i);else{if("."===i)break;"\\"===i?r=!0:null!==o&&(o+=i)}}return null!==o&&(e[0]=o),n},a=[];t.pathUtil.parseEL=function(e){for(var t=[],n=0,o=e.length;n<o;){var i=r(a,e,n);t.push(a[0]),n=i+1}return t},t.pathUtil.composeSegment=function(e,t){t=t.toString();for(var n=0;n<t.length;++n){var o=t.charAt(n);"."!==o&&"\\"!==o&&"}"!==o||(e+="\\"),e+=o}return e},t.pathUtil.escapeSegment=function(e){return t.pathUtil.composeSegment("",e)},t.pathUtil.composePath=function(e,n){return 0!==e.length&&(e+="."),t.pathUtil.composeSegment(e,n)},t.pathUtil.composeSegments=function(){for(var e="",n=0;n<arguments.length;++n)e=t.pathUtil.composePath(e,arguments[n]);return e},t.model.unescapedParser={parse:t.model.parseEL,compose:t.model.composeSegments},t.model.defaultGetConfig={parser:t.model.unescapedParser,strategies:[t.model.funcResolverStrategy,t.model.defaultFetchStrategy]},t.model.defaultSetConfig={parser:t.model.unescapedParser,strategies:[t.model.funcResolverStrategy,t.model.defaultFetchStrategy,t.model.defaultCreatorStrategy]},t.model.escapedParser={parse:t.pathUtil.parseEL,compose:t.pathUtil.composeSegments},t.model.escapedGetConfig={parser:t.model.escapedParser,strategies:[t.model.defaultFetchStrategy]},t.model.escapedSetConfig={parser:t.model.escapedParser,strategies:[t.model.defaultFetchStrategy,t.model.defaultCreatorStrategy]},t.initSimpleModel=function(e,t){return e.model=t||{},e.model},t.initRelayModel=function(e,t){return t},t.isModelComplete=function(e){return e.model!==t.inEvaluationMarker},t.enlistModelComponent=function(e){var n=t.getInstantiator(e),o=n.modelTransactions.init[e.id];return o||(o={that:e,applier:t.getForComponent(e,"applier"),complete:t.isModelComplete(e)},n.modelTransactions.init[e.id]=o),o},t.clearLinkCounts=function(e,n){t.each(e,function(t,o){"number"==typeof t?e[o]=0:n&&t.options&&"number"==typeof t.options.relayCount&&(t.options.relayCount=0)})},t.sortCompleteLast=function(e,t){return(e.completeOnInit?1:0)-(t.completeOnInit?1:0)},t.operateInitialTransaction=function(e,n){var o,r=t.allocateGuid(),a=t.getModelTransactionRec(e,r),i=t.transform(n,function(e){return o=e.that.applier.initiate("init",r),a[e.that.applier.applierId]={transaction:o},o}),u=t.values(n).sort(t.sortCompleteLast);t.each(u,function(e){var n=e.that,o=i[n.id];e.completeOnInit?t.initModelEvent(n,o,n.applier.changeListeners.listeners):t.each(e.initModels,function(e){o.fireChangeRequest({type:"ADD",segs:[],value:e}),t.clearLinkCounts(a,!0)});var r=t.shadowForComponent(n);r.modelComplete=!0}),o.commit()},t.deenlistModelComponent=function(e){var n=t.getInstantiator(e),o=n.modelTransactions.init;e.model=void 0,o[e.id].complete=!0;var r=t.find_if(o,function(e){return e.complete!==!0});r||(t.operateInitialTransaction(n,o),n.modelTransactions.init={})},t.transformToAdapter=function(e,n){var o={};return o[n]=e,function(e,n){t.model.transformWithRules(n,o,{finalApplier:e})}},t.parseModelReference=function(e,n){var o=t.parseContextReference(n);return o.segs=e.applier.parseEL(o.path),o},t.parseValidModelReference=function(e,n,o){var r,a,i=function(e){t.fail("Error in "+n+": "+o+e)};return"{"===o.charAt(0)?(r=t.parseModelReference(e,o),"model"!==r.segs[0]?i(' must be a reference into a component model beginning with "model"'):(r.modelSegs=r.segs.slice(1),delete r.path),a=t.resolveContext(r.context,e),a||i(" must be a reference to an existing component")):(a=e,r={path:o,modelSegs:e.applier.parseEL(o)}),a.applier||t.getForComponent(a,["applier"]),a.applier||i(" must be a reference to a component with a ChangeApplier (descended from fluid.modelComponent)"),r.that=a,r.applier=a.applier,r.path||(r.path=a.applier.composeSegments.apply(null,r.modelSegs)),r},t.getModelTransactionRec=function(e,n){n||t.fail("Cannot get transaction record without transaction id");var o=e.modelTransactions[n];return o||e.free||(o=e.modelTransactions[n]={},o.externalChanges={}),o},t.recordChangeListener=function(e,n,o){var r=t.shadowForComponent(e);t.recordListener(n.modelChanged,o,r)},t.registerDirectChangeRelay=function(e,n,o,r,a,i,u){var l=t.getInstantiator(e),s=u.targetApplier||e.applier,c=u.sourceApplier||o.applier,f=s.applierId;n=t.makeArray(n),r=r?t.makeArray(r):r;var d=function(e,o,c,d,p,g){var m=p.id,v=t.getModelTransactionRec(l,m);g&&p&&!v[g.applierId]&&(v[g.applierId]={transaction:p});var h=v[f];v[a]=v[a]||0;var k=!0;if(k){if(++v[a],!h){var y=s.initiate("relay",m);h=v[f]={transaction:y,options:u}}i&&!u.targetApplier?i(h.transaction,u.sourceApplier?void 0:e,r,n):void 0!==e&&h.transaction.fireChangeRequest({type:"ADD",segs:n,value:e})}};r&&c.modelChanged.addListener({isRelay:!0,segs:r,transactional:u.transactional},d),o&&(t.recordChangeListener(o,c,d),e!==o&&t.recordChangeListener(e,c,d))},t.connectModelRelay=function(e,n,o,r,a){function i(e){var n=t.enlistModelComponent(e);if(n.complete){var o=t.shadowForComponent(e);o.modelComplete&&(n.completeOnInit=!0)}}var u=t.allocateGuid();i(o),i(e),a.update?a.targetApplier?t.registerDirectChangeRelay(e,n,o,r,u,null,{transactional:!1,targetApplier:a.targetApplier,relayCount:a.relayCount,update:a.update}):t.registerDirectChangeRelay(o,r,e,[],u+"-transform",a.forwardAdapter,{transactional:!0,sourceApplier:a.forwardApplier}):(t.registerDirectChangeRelay(o,r,e,n,u,a.forwardAdapter,{transactional:!1}),n&&t.registerDirectChangeRelay(e,n,o,r,u,a.backwardAdapter,{transactional:!1}))},t.model.guardedAdapter=function(e,n,o,r){var a=e.modelRelay===t.inEvaluationMarker,i=n[a?"init":"live"];i&&o.apply(null,r)},t.makeTransformPackage=function(e,n,o,r,a,i){var u={forwardHolder:{model:n},backwardHolder:{model:null}};u.generateAdapters=function(e){u.forwardAdapterImpl=t.transformToAdapter(e?e.newHolder.model:u.forwardHolder.model,r),null!==o&&(u.backwardHolder.model=t.model.transform.invertConfiguration(n),u.backwardAdapterImpl=t.transformToAdapter(u.backwardHolder.model,o))},u.forwardAdapter=function(n,o){void 0===o&&u.generateAdapters(),t.model.guardedAdapter(e,a,u.forwardAdapterImpl,arguments)},u.runTransform=function(e){e.commit(),e.reset()},u.forwardApplier=t.makeNewChangeApplier(u.forwardHolder),u.forwardApplier.isRelayApplier=!0,u.invalidator=t.makeEventFirer({name:"Invalidator for model relay with applier "+u.forwardApplier.applierId}),null!==o&&(u.backwardApplier=t.makeNewChangeApplier(u.backwardHolder),u.backwardAdapter=function(){t.model.guardedAdapter(e,i,u.backwardAdapterImpl,arguments)}),u.update=u.invalidator.fire;var l={relayCount:0,targetApplier:u.forwardApplier,update:u.update,refCount:0};return u.forwardHolder.model=t.parseImplicitRelay(e,n,[],l),u.refCount=l.refCount,u.generateAdapters(),u.invalidator.addListener(u.generateAdapters),u.invalidator.addListener(u.runTransform),u},t.singleTransformToFull=function(t){var n=e.extend(!0,{valuePath:""},t);return{"":{transform:n}}},t.model.relayConditions={initOnly:{init:!0,live:!1},liveOnly:{init:!1,live:!0},never:{init:!1,live:!1},always:{init:!0,live:!0}},t.model.parseRelayCondition=function(e){return t.model.relayConditions[e||"always"]},t.parseModelRelay=function(e,n){var o=n.source?t.parseValidModelReference(e,'modelRelay record member "source"',n.source):{path:null,modelSegs:null},r=t.parseValidModelReference(e,'modelRelay record member "target"',n.target),a=n.singleTransform?t.singleTransformToFull(n.singleTransform):n.transform;a||t.fail('Cannot parse modelRelay record without element "singleTransform" or "transform":',n);var i=t.model.parseRelayCondition(n.forward),u=t.model.parseRelayCondition(n.backward),l=t.makeTransformPackage(e,a,o.path,r.path,i,u);0===l.refCount?t.connectModelRelay(o.that||e,o.modelSegs,r.that,r.modelSegs,{forwardAdapter:l.forwardAdapter,backwardAdapter:l.backwardAdapter}):t.connectModelRelay(o.that||e,o.modelSegs,r.that,r.modelSegs,l)},t.parseImplicitRelay=function(e,n,o,r){var a;if("string"==typeof n&&"{"===n.charAt(0)){var i=t.parseModelReference(e,n),u=t.resolveContext(i.context,e);if("model"===i.segs[0]){var l=i.segs.slice(1);++r.refCount,t.connectModelRelay(e,o,u,l,r)}else a=t.getForComponent(u,i.segs)}else t.isPrimitive(n)||!t.isPlainObject(n)?a=n:n.expander&&t.isPlainObject(n.expander)?a=t.expandOptions(n,e):(a=t.freshContainer(n),t.each(n,function(n,i){o.push(i);var u=t.parseImplicitRelay(e,n,o,r);void 0!==u&&(a[i]=u),o.pop()}));return a},t.model.notifyExternal=function(e){var n=e?t.values(e.externalChanges):[];n.sort(t.priorityComparator);for(var o=0;o<n.length;++o){var r=n[o],a=r.args[5];a.destroyed||r.listener.apply(null,r.args)}t.clearLinkCounts(e,!0)},t.model.commitRelays=function(e,n){var o=e.modelTransactions[n];t.each(o,function(e){e.transaction&&(e.transaction.commit("relay"),e.transaction.reset())})},t.model.updateRelays=function(e,n){var o=e.modelTransactions[n],r=0;return t.each(o,function(e){e.options&&e.transaction&&e.transaction.changeRecord.changes>0&&e.options.relayCount<2&&e.options.update&&(e.options.relayCount++,t.clearLinkCounts(o),e.options.update(e.transaction,o),++r)}),r},t.establishModelRelay=function(e,n,o,r,a){function i(e){for(;t.model.updateRelays(f,e.id)>0;);}function u(e,n,o){"relay"!==o&&t.model.commitRelays(f,e.id)}function l(e,n,o){"relay"!==o&&(t.model.notifyExternal(f.modelTransactions[e.id]),delete f.modelTransactions[e.id])}t.mergeModelListeners(e,o);var s=t.enlistModelComponent(e);t.each(r,function(n){t.parseModelRelay(e,n)});var c=t.transform(n,function(n){return t.parseImplicitRelay(e,n,[],{refCount:0})});s.initModels=c;var f=t.getInstantiator(e);return a.preCommit.addListener(i),a.preCommit.addListener(u),a.postCommit.addListener(l),t.deenlistModelComponent(e),a.holder.model},t.defaults("fluid.commonModelComponent",{gradeNames:["fluid.littleComponent","autoInit"],mergePolicy:{modelListeners:t.makeMergeListenersPolicy(t.arrayConcatPolicy)}}),t.defaults("fluid.modelComponent",{gradeNames:["fluid.commonModelComponent","autoInit"],members:{model:"@expand:fluid.initSimpleModel({that}, {that}.options.model)",applier:"@expand:fluid.makeChangeApplier({that}.model, {that}.options.changeApplierOptions)",modelListeners:"@expand:fluid.mergeModelListeners({that}, {that}.options.modelListeners)"},mergePolicy:{model:"preserve"}}),t.defaults("fluid.modelRelayComponent",{gradeNames:["fluid.commonModelComponent","fluid.eventedComponent","autoInit"],changeApplierOptions:{relayStyle:!0,cullUnchanged:!0},members:{model:"@expand:fluid.initRelayModel({that}, {that}.modelRelay)",applier:"@expand:fluid.makeNewChangeApplier({that}, {that}.options.changeApplierOptions)",modelRelay:"@expand:fluid.establishModelRelay({that}, {that}.options.model, {that}.options.modelListeners, {that}.options.modelRelay, {that}.applier)"},mergePolicy:{model:{noexpand:!0,func:t.arrayConcatPolicy},modelRelay:{noexpand:!0,func:t.arrayConcatPolicy}}}),t.defaults("fluid.standardComponent",{gradeNames:["fluid.modelComponent","fluid.eventedComponent","autoInit"]}),t.defaults("fluid.standardRelayComponent",{gradeNames:["fluid.modelRelayComponent","autoInit"]}),t.modelChangedToChange=function(e,n){var o=n[0],r=n[1],a=n[3];return e?{value:n[0],oldValue:n[1],path:n[2]}:{value:t.get(o,a),oldValue:t.get(r,a),path:a}},t.resolveModelListener=function(e,n,o){var r=function(){if(!t.isDestroyed(e)){var r=t.modelChangedToChange(o,arguments),a=[r],i={change:r,arguments:a};n.args&&(a=t.expandOptions(n.args,e,{},i)),t.event.invokeListener(n.listener,t.makeArray(a))}};return t.event.impersonateListener(n.listener,r),r},t.mergeModelListeners=function(e,n){var o=0;t.each(n,function(n,r){"string"==typeof n&&(n={funcName:n});var a=t.event.resolveListenerRecord(n,e,"modelListeners",null,!1),i=t.parseValidModelReference(e,"modelListeners entry",r),u=i.applier.preCommit;t.each(a.records,function(n){function r(){if(u&&t.isModelComplete(i.that)){var n=i.applier.initiate("init");t.initModelEvent(e,n,[l]),n.commit()}}var a=t.resolveModelListener(e,n,u),l={listener:a,listenerIndex:o,segs:i.modelSegs,path:i.path,includeSource:n.includeSource,excludeSource:n.excludeSource,priority:n.priority,guardSource:n.guardSource,transactional:!0};++o,n.guardSource?t.addSourceGuardedListener(i.applier,l,n.guardSource,a,"modelChanged",n.namespace,n.softNamespace):i.applier.modelChanged.addListener(l,a,n.namespace,n.softNamespace),t.recordChangeListener(e,i.applier,a),e===i.that||t.isModelComplete(e)||e.events.onCreate.addListener(r)})})},t.addSourceGuardedListener=function(e,n,o,r,a,i,u){a=a||"modelChanged";var l=function(t,n,a,i){if(!e.hasChangeSource(o,i))return r.apply(null,arguments)};t.event.impersonateListener(r,l),e[a].addListener(n,l,i,u)},t.fireSourcedChange=function(e,t,n,o){e.fireChangeRequest({path:t,value:n,source:o})},t.requestChanges=function(e,t){for(var n=0;n<t.length;++n)e.fireChangeRequest(t[n])},t.bindRequestChange=function(e){e.requestChange=e.change=function(t,n,o){var r={path:t,value:n,type:o};e.fireChangeRequest(r)}},t.identifyChangeListener=function(e){return t.event.identifyListener(e)||e},t.typeCode=function(e){return t.isPrimitive(e)||!t.isPlainObject(e)?"primitive":t.isArrayable(e)?"array":"object"},t.model.isChangedPath=function(e,t){for(var n=0;n<=t.length;++n){if("string"==typeof e)return!0;n<t.length&&e&&(e=e[t[n]])}return!1},t.model.setChangedPath=function(e,n,o){var r=function(r){n.unshift(r),t.model.setSimple(e,n,o),n.shift()};t.model.isChangedPath(e.changeMap,n)||(++e.changes,r("changeMap")),t.model.isChangedPath(e.deltaMap,n)||(++e.deltas,r("deltaMap"))},t.model.fetchChangeChildren=function(e,n,o,r,a){t.each(r,function(r,i){o[n]=i,t.model.applyChangeStrategy(e,i,n,o,r,a),o.length=n})},t.model.isSameValue=function(e,t){if("number"!=typeof e||"number"!=typeof t)return e===t;if(e===t)return!0;var n=Math.abs((e-t)/t);return n<1e-12},t.model.applyChangeStrategy=function(e,n,o,r,a,i){var u=e[n],l=t.typeCode(a),s=t.typeCode(u),c=t.NO_VALUE;"primitive"===l?t.model.isSameValue(u,a)||(c=a,++i.unchanged):(s!==l||"array"===l&&a.length!==u.length)&&(c=t.freshContainer(a)),c!==t.NO_VALUE&&(e[n]=c,i.changeMap&&t.model.setChangedPath(i,r,i.inverse?"DELETE":"ADD")),"primitive"!==l&&t.model.fetchChangeChildren(e[n],o+1,r,a,i)},t.model.stepTargetAccess=function(e,n,o,r,a,i){for(var u=r;u<a;++u){var l=e[o[u]];e=t.model.traverseWithStrategy(e,o,u,i["ADD"===n?"resolverSetConfig":"resolverGetConfig"],o.length-u-1),l!==e&&i.changeMap&&t.model.setChangedPath(i,o.slice(0,u+1),"ADD")}return{root:e,last:o[a]}},t.model.defaultAccessorConfig=function(e){return e=e||{},e.resolverSetConfig=e.resolverSetConfig||t.model.defaultSetConfig,e.resolverGetConfig=e.resolverGetConfig||t.model.defaultGetConfig,e},t.model.applyHolderChangeRequest=function(e,n,o){o=t.model.defaultAccessorConfig(o),o.deltaMap=o.changeMap?{}:null,o.deltas=0;var r,a=n.segs.length,i=0===a;if(i?r={root:e,last:"model"}:(e.model||(e.model={},t.model.setChangedPath(o,[],o.inverse?"DELETE":"ADD")),r=t.model.stepTargetAccess(e.model,n.type,n.segs,0,a-1,o)),"ADD"===n.type){var u=n.value,l=t.makeArray(n.segs);t.model.applyChangeStrategy(r.root,r.last,a-1,l,u,o,i)}else"DELETE"===n.type?r.root&&void 0!==r.root[r.last]&&(delete r.root[r.last],o.changeMap&&t.model.setChangedPath(o,n.segs,"DELETE")):t.fail("Unrecognised change type of "+n.type);return o.deltas?o.deltaMap:null},t.model.diff=function(e,n,o){o=o||{changes:0,unchanged:0,changeMap:{}};var r,a=t.typeCode(e),i=t.typeCode(n);if("primitive"===a&&"primitive"===i)r=t.model.isSameValue(e,n);else if("primitive"===a^"primitive"===i)r=!1;else{var u={model:t.copy(e)};t.model.applyHolderChangeRequest(u,{value:n,segs:[],type:"ADD"},o);var l={model:t.copy(n)};o.inverse=!0,t.model.applyHolderChangeRequest(l,{value:e,segs:[],type:"ADD"},o),r=0===o.changes}return r===!1&&0===o.changes?(o.changes=1,o.changeMap=void 0===n?"DELETE":"ADD"):r===!0&&0===o.unchanged&&(o.unchanged=1),r},t.matchChanges=function(e,n,o){for(var r=o.model,a=e,i=["model"],u=!1,l=[],s=0;s<n.length;++s){var c=n[s];"*"===c?s===n.length-1?u=!0:t.fail("Wildcard specification in modelChanged listener is only supported for the final path segment: "+n.join(".")):(i.push(c),a=t.isPrimitive(a)?a:a[c],r=r?r[c]:void 0)}return a&&(u?t.each(r,function(e,t){l.push(i.concat(t))}):l.push(i)),l},t.storeExternalChange=function(e,n,o,r,a){var i=n.composeSegments.apply(null,o),u=[n.applierId,t.event.identifyListener(r.listener),r.listenerIndex,i],l=u.join("|");e.externalChanges[l]={listener:r.listener,priority:r.priority,args:a}},t.isExcludedChangeSource=function(e,t){if(!t.excludeSource)return!1;var n=t.excludeSource["*"];for(var o in e.sources)t.excludeSource[o]&&(n=!0),t.includeSource[o]&&(n=!1);return n},t.notifyModelChanges=function(e,n,o,r,a,i,u,l){for(var s=t.getInstantiator(l),c=i&&t.getModelTransactionRec(s,i.id),f=0;f<e.length;++f)for(var d=e[f],p=t.matchChanges(n,d.segs,o),g=0;g<p.length;++g){if(u.destroyed)return;var m=p[g];d.listener=t.event.resolveListener(d.listener);var v=[t.model.getSimple(o,m),t.model.getSimple(r,m),m.slice(1),a,i,u];if(!d.isRelay){var h=t.model.diff(v[0],v[1]);if(h)continue;var k=t.isExcludedChangeSource(i,d);if(k)continue}c&&!d.isRelay&&d.transactional?t.storeExternalChange(c,u,m,d,v):d.listener.apply(null,v)}},t.bindELMethods=function(e){e.parseEL=function(n){return t.model.pathToSegments(n,e.options.resolverSetConfig)},e.composeSegments=function(){return e.options.resolverSetConfig.parser.compose.apply(null,arguments)}},t.initModelEvent=function(e,n,o){t.notifyModelChanges(o,"ADD",n.oldHolder,t.emptyHolder,null,n,e)},t.emptyHolder={model:void 0},t.makeNewChangeApplier=function(e,n){function o(e){e.type||(e.type="ADD"),e.segs=e.segs||a.parseEL(e.path)}n=t.model.defaultAccessorConfig(n);var r=t.allocateGuid(),a={applierId:r,holder:e,changeListeners:{listeners:[],transListeners:[]},options:n,modelChanged:{},preCommit:t.makeEventFirer({name:"preCommit event for ChangeApplier "}),postCommit:t.makeEventFirer({name:"postCommit event for ChangeApplier "})};return a.destroy=function(){a.preCommit.destroy(),a.postCommit.destroy(),a.destroyed=!0},a.modelChanged.addListener=function(e,n,o,r){e="string"==typeof e?{path:e}:t.copy(e),e.id=t.event.identifyListener(n),e.namespace=o,e.softNamespace=r,"string"==typeof n&&(n={globalName:n}),e.listener=n,e.transactional!==!1&&(e.transactional=!0),e.segs=e.segs||a.parseEL(e.path);var i=a.changeListeners[e.transactional?"transListeners":"listeners"];e.excludeSource=t.arrayToHash(t.makeArray(e.excludeSource||(e.includeSource?"*":void 0))),e.includeSource=t.arrayToHash(t.makeArray(e.includeSource)),e.priority=t.event.mapPriority(e.priority,i.length),i.push(e)},a.modelChanged.removeListener=function(e){var n=t.event.identifyListener(e),o="string"==typeof e?e:null,r=function(e){return e.id===n||e.namespace===o};t.remove_if(a.changeListeners.listeners,r),t.remove_if(a.changeListeners.transListeners,r)},a.modelChanged.isRelayEvent=!0,a.fireChangeRequest=function(e){var t=a.initiate();t.fireChangeRequest(e),t.commit()},a.initiate=function(r,i){r=r||"local";var u="relay"===r,l={instanceId:t.allocateGuid(),id:i||t.allocateGuid(),sources:{},changeRecord:{resolverSetConfig:n.resolverSetConfig,resolverGetConfig:n.resolverGetConfig},reset:function(){l.oldHolder=e,l.newHolder={model:t.copy(e.model)},l.changeRecord.changes=0,l.changeRecord.unchanged=0,l.changeRecord.changeMap={}},commit:function(n){if(a.preCommit.fire(l,a,n),l.changeRecord.changes>0){var o={model:e.model};e.model=l.newHolder.model,t.notifyModelChanges(a.changeListeners.transListeners,l.changeRecord.changeMap,e,o,null,l,a,e)}u||a.postCommit.fire(l,a,n)},fireChangeRequest:function(n){o(n),n.transactionId=l.id;var r=t.model.applyHolderChangeRequest(l.newHolder,n,l.changeRecord);t.notifyModelChanges(a.changeListeners.listeners,r,l.newHolder,e,n,l,a,e)}};return l.sources[r]=!0,l.reset(),t.bindRequestChange(l),l},a.hasChangeSource=function(e,t){return!!t&&t[e]},t.bindRequestChange(a),t.bindELMethods(a),a},t.pathUtil.getPathSegment=function(e,t){return r(a,e,t),a[0]},t.pathUtil.getHeadPath=function(e){return t.pathUtil.getPathSegment(e,0)},t.pathUtil.getFromHeadPath=function(e){var t=r(null,e,0);return t===e.length?"":e.substring(t+1)},t.pathUtil.getToTailPath=function(e){var t=n(e);return t===-1?"":e.substring(0,t)},t.pathUtil.getTailPath=function(e){var o=n(e);return t.pathUtil.getPathSegment(e,o+1)},t.pathUtil.matchSegments=function(e,t,n,o){if(o-n!==e.length)return!1;for(var r=n;r<o;++r)if(t[r]!==e[r-n])return!1;return!0},t.pathUtil.getExcessPath=function(e,n){var o=n.indexOf(e);return 0!==o&&t.fail("Path "+e+" is not a prefix of path "+n),e.length===n.length?"":("."!==n[e.length]&&t.fail("Path "+e+" is not properly nested in path "+n),n.substring(e.length+1))},t.pathUtil.matchPath=function(e,n,o){for(var r=[];;){if(""===n^""===e&&o)return null;if(!e||!n)break;var a=t.pathUtil.getHeadPath(e),i=t.pathUtil.getHeadPath(n);if("*"!==a&&a!==i)return null;r.push(i),e=t.pathUtil.getFromHeadPath(e),n=t.pathUtil.getFromHeadPath(n)}return r},t.model.isNullChange=function(e,n,o){if("ADD"===n.type&&!n.forceChange){var r=t.get(e,n.segs,o);if(r===n.value)return!0}},t.model.applyChangeRequest=function(n,o,r){var a=t.model.accessWithStrategy(n,o.path,t.VALUE,r||t.model.defaultSetConfig,null,!0),i=a.segs[a.segs.length-1];"ADD"===o.type||"MERGE"===o.type?0===a.segs.length||"MERGE"===o.type&&a.root[i]?("ADD"===o.type&&t.clear(a.root),e.extend(!0,0===a.segs.length?a.root:a.root[i],o.value)):a.root[i]=o.value:"DELETE"===o.type&&(0===a.segs.length?t.clear(a.root):delete a.root[i])},t.makeChangeApplier=function(e,n){return t.makeHolderChangeApplier({model:e},n)},t.makeHolderChangeApplier=function(e,n){function r(e){if(!e)return null;var n=function(e){return function(o,r,a){var i=e(o,r,a);return i!==!1&&(t.model.isNullChange(o,r)?(n.culled=!0,!1):void 0)}};return n}function a(e,n){var o=n,r=!1,a=Number.MAX_VALUE;"string"==typeof n&&(n={path:n}),o=n.path,r=n.transactional,void 0!==n.priority&&(a=n.priority),"!"===o.charAt(0)&&(r=!0,o=o.substring(1));var i=function(n,i,u){var l=t.event.identifyListener(e),s=i.guids[l];if(s&&u)u&&(s.accumulate||(s.accumulate=[]),s.accumulate.push(u));else{var c=t.pathUtil.matchPath(o,n);if(null!==c){var f={match:c,pathSpec:o,listener:e,priority:a,transactional:r};u&&(f.accumulate=[u]),i.guids[l]=f;var d=r?"transListeners":"listeners";i[d].push(f),i.all.push(f)}}};return t.event.impersonateListener(e,i),i}function i(e,t,n,o,r){return m[e].fireToListeners(t[o],n,r)}function u(e,t){return e.priority-t.priority}function l(e,t,n,o){m[e].fire(t,n,o),n.all.sort(u),n.listeners.sort(u),n.transListeners.sort(u)}function s(){return{guids:{},all:[],listeners:[],transListeners:[]}}function c(e,t){var n=s();return l(e,t,n),n}function f(e,t,n,o){var r=c(e,t);return i(e,r,n,"all",o)}function d(e,t){e[t]={addListener:function(e,n,o,r){m[t].addListener(a(n,e),o,null,null,r)},removeListener:function(e){m[t].removeListener(e)}}}function p(e){e.type||(e.type="ADD"),e.segs=h.parseEL(e.path)}function g(e,t,n,o,r,a){for(var i=s(),u=0;u<n.length;++u)l(e,n[u].path,i,n[u]);for(var c=0;c<i[t].length;++c){var f=i[t][c];void 0!==r&&(o[r]=f.accumulate),void 0!==a&&(o[a]=f.match);var d=f.listener.apply(null,o);if(d===!1)return!1}}n=t.model.defaultAccessorConfig(n);var m={guards:t.makeEventFirer({preventable:!0,name:"guard event"}),postGuards:t.makeEventFirer({preventable:!0,name:"postGuard event"}),modelChanged:t.makeEventFirer({name:"modelChanged event"})},v=t.threadLocal(function(){return{sources:{}}}),h={applierId:t.allocateGuid(),holder:e,options:n,destroy:t.identity};d(h,"guards"),d(h,"postGuards"),d(h,"modelChanged");var k={fireChangeRequest:function(e){h.fireChangeRequest(e,!0)}};return t.bindRequestChange(k),h.fireChangeRequest=function(e){p(e);var t=h.initiate();t.fireChangeRequest(e),t.commit()},h.fireChangeRequest=o(h.fireChangeRequest,v),t.bindRequestChange(h),t.bindELMethods(h),h.initiate=function(a){var i=!1,u=[];n.thin?a=e.model:(a=a||{},t.model.copyModel(a,e.model));var l={commit:function(){var o;if(i)return!1;var r=g("postGuards","transListeners",u,[a,null,l],1);return r!==!1&&!i&&(n.thin?o=e.model:(o={},t.model.copyModel(o,e.model),t.clear(e.model),t.model.copyModel(e.model,a)),void g("modelChanged","all",u,[e.model,o,null,null],2,3))},fireChangeRequest:function(o){if(p(o),!n.cullUnchanged||!t.model.isNullChange(e.model,o,n.resolverGetConfig)){var s=r(n.cullUnchanged),c=f("guards",o.path,[a,o,l],s);c!==!1||s&&s.culled||(i=!0),i||s&&s.culled||(t.model.applyChangeRequest(a,o,n.resolverSetConfig),u.push(o))}}};return l.fireChangeRequest=o(l.fireChangeRequest,v),t.bindRequestChange(l),l},h.hasChangeSource=function(e){return v().sources[e]>0},h},t.makeSuperApplier=function(){var e=[],n={};return n.addSubApplier=function(t,n){e.push({path:t,subApplier:n})},n.fireChangeRequest=function(n){for(var o=0;o<e.length;++o){var r=e[o].path;if(0===n.path.indexOf(r)){var a=n.path.substring(r.length+1),i=t.copy(n);i.path=a,
e[o].subApplier.fireChangeRequest(i)}}},t.bindRequestChange(n),n},t.attachModel=function(e,n,o){for(var r=t.model.parseEL(n),a=0;a<r.length-1;++a){var i=r[a],u=e[i];u||(e[i]=u={}),e=u}e[r[r.length-1]]=o},t.assembleModel=function(e){var n={},o=t.makeSuperApplier(),r={model:n,applier:o};for(var a in e){var i=e[a];t.attachModel(n,a,i.model),i.applier&&o.addSubApplier(a,i.applier)}return r}}(jQuery,fluid_2_0);var fluid=fluid||require("infusion"),flock=fluid.registerNamespace("flock");!function(){"use strict";var e=fluid.registerNamespace("jQuery");flock.fluid=fluid,flock.init=function(e){var t=e?{audioSettings:e}:void 0,n=flock.enviro.shared=flock.enviro(t);return n},flock.OUT_UGEN_ID="flocking-out",flock.MAX_CHANNELS=32,flock.MIN_BUSES=2,flock.MAX_INPUT_BUSES=32,flock.MIN_INPUT_BUSES=1,flock.ALL_CHANNELS=flock.MAX_INPUT_BUSES,flock.PI=Math.PI,flock.TWOPI=2*Math.PI,flock.HALFPI=Math.PI/2,flock.LOG01=Math.log(.1),flock.LOG001=Math.log(.001),flock.ROOT2=Math.sqrt(2),flock.rates={AUDIO:"audio",CONTROL:"control",SCHEDULED:"scheduled",DEMAND:"demand",CONSTANT:"constant"},flock.sampleFormats={FLOAT32NE:"float32NE"},fluid.registerNamespace("flock.debug"),flock.debug.failHard=!0,flock.browser=function(){if("undefined"==typeof navigator)return{};var e,t,n=navigator.userAgent.toLowerCase(),o={};return e=/(chrome)[ \/]([\w.]+)/.exec(n)||/(webkit)[ \/]([\w.]+)/.exec(n)||/(opera)(?:.*version|)[ \/]([\w.]+)/.exec(n)||/(msie) ([\w.]+)/.exec(n)||n.indexOf("compatible")<0&&/(mozilla)(?:.*? rv:([\w.]+)|)/.exec(n)||[],t={browser:e[1]||"",version:e[2]||"0"},t.browser&&(o[t.browser]=!0,o.version=t.version),o.chrome?o.webkit=!0:o.webkit&&(o.safari=!0),o},fluid.registerNamespace("flock.platform"),flock.platform.isBrowser="undefined"!=typeof window,flock.platform.hasRequire="undefined"!=typeof require,flock.platform.os=flock.platform.isBrowser?window.navigator.platform:fluid.require("os").platform(),flock.platform.isLinux=flock.platform.os.indexOf("Linux")>-1,flock.platform.isAndroid=flock.platform.isLinux&&flock.platform.os.indexOf("arm")>-1,flock.platform.isIOS="iPhone"===flock.platform.os||"iPad"===flock.platform.os||"iPod"===flock.platform.os,flock.platform.isMobile=flock.platform.isAndroid||flock.platform.isIOS,flock.platform.browser=flock.browser(),flock.platform.isWebAudio="undefined"!=typeof AudioContext||"undefined"!=typeof webkitAudioContext,flock.platform.audioEngine=flock.platform.isBrowser?flock.platform.isWebAudio?"webAudio":"moz":"nodejs",fluid.staticEnvironment.audioEngine=fluid.typeTag("flock.platform."+flock.platform.audioEngine),flock.defaultBufferSizeForPlatform=function(){return flock.platform.isMobile?8192:1024},flock.shim={URL:flock.platform.isBrowser?window.URL||window.webkitURL||window.msURL:void 0},flock.requireModule=function(e,t){if(flock.platform.isBrowser)return window[t||e];if(flock.platform.hasRequire){var n=flock.requireModule.paths[e]||e,o=require(n);return t?o[t]:o}},flock.requireModule.paths={dspapi:"../third-party/dspapi/js/dspapi.js",Random:"../third-party/simjs/js/random-0.26.js"},flock.noOp=function(){},flock.isIterable=function(e){var t=typeof e;return e&&void 0!==e.length&&"string"!==t&&"function"!==t},flock.hasTag=function(e,t){return!(!e||!t)&&(e.tags&&e.tags.indexOf(t)>-1)},flock.generate=function(e,t){var n,o="number"==typeof e?new Float32Array(e):e,r="function"==typeof t;for(n=0;n<o.length;n++)o[n]=r?t(n,o):t;return o},flock.generate.silence=function(e){if("number"==typeof e)return new Float32Array(e);var t,n=e;for(t=0;t<n.length;t++)n[t]=0;return n},flock.reverse=function(e){if(!e||!flock.isIterable(e)||e.length<2)return e;if("function"==typeof e.reverse)return e.reverse();for(var t,n=0,o=e.length-1;n<o;n++,o--)t=e[n],e[n]=e[o],e[o]=t;return e},flock.randomIndex=function(e){var t=e.length-1;return Math.round(Math.random()*t)},flock.arrayChoose=function(e,t){t=t||flock.randomIndex,e=fluid.makeArray(e);var n=t(e);return e[n]},flock.choose=function(e,t){var n,o;return flock.isIterable(e)?o=flock.arrayChoose(e,t):(n=flock.arrayChoose(e.keys,t),o=e[n])},flock.normalize=function(e,t,n){n=n||e;var o,r,a,i=0;for(t=void 0===t?1:t,o=0;o<e.length;o++)r=Math.abs(e[o]),r>i&&(i=r);if(i>0)for(o=0;o<e.length;o++)a=e[o],n[o]=a/i*t;return n},flock.generateFourierTable=function(e,t,n,o,r){return o*=flock.TWOPI,flock.generate(e,function(e){var a,i,u,l=0;for(a=0;a<n;a++)i=r?r[a]:1,u=(a+1)*(e*t),l+=i*Math.cos(u+o);return l})},flock.generateNormalizedFourierTable=function(e,t,n,o,r){var a=flock.generate(n,function(e){return r(e+1)}),i=flock.generateFourierTable(e,t,n,o,a);return flock.normalize(i)},flock.fillTable=function(e,t){var n="number"==typeof e?e:e.length;return t(e,flock.TWOPI/n)},flock.tableGenerators={sin:function(e,t){return flock.generate(e,function(e){return Math.sin(e*t)})},tri:function(e,t){return flock.generateNormalizedFourierTable(e,t,1e3,1,function(e){return e%2===0?0:1/(e*e)})},saw:function(e,t){return flock.generateNormalizedFourierTable(e,t,10,-.25,function(e){return 1/e})},square:function(e,t){return flock.generateNormalizedFourierTable(e,t,10,-.25,function(e){return e%2===0?0:1/e})},hann:function(e){return flock.generate(e,function(t){var n=Math.sin(Math.PI*t/e);return n*n})},sinWindow:function(e){return flock.generate(e,function(t){return Math.sin(Math.PI*t/e)})}},flock.range=function(e){var t,n,o={max:Number.NEGATIVE_INFINITY,min:1/0};for(t=0;t<e.length;t++)n=e[t],n>o.max&&(o.max=n),n<o.min&&(o.min=n);return o},flock.scale=function(e){if(e){var t,n=flock.range(e),o=(n.max-n.min)/2,r=(n.max+n.min)/2;for(t=0;t<e.length;t++)e[t]=(e[t]-r)/o;return e}},flock.copyBuffer=function(e,t,n){void 0===n&&(n=e.length);var o,r,a=n-t,i=new Float32Array(a);for(o=t,r=0;o<n;o++,r++)i[r]=e[o];return i},flock.parseMidiString=function(e){if(!e||e.length<2)return NaN;e=e.toLowerCase();var t=e.charAt(1),n="#"===t||"b"===t?2:1,o=e.substring(0,n),r=Number(e.substring(n)),a=flock.midiFreq.noteNames[o],i=12*r+a;return i},flock.midiFreq=function(e,t,n,o){return t=void 0===t?440:t,n=void 0===n?69:n,o=o||12,"string"==typeof e&&(e=flock.parseMidiString(e)),t*Math.pow(2,1*(e-n)/o)},flock.midiFreq.noteNames={"b#":0,c:0,"c#":1,db:1,d:2,"d#":3,eb:3,e:4,"e#":5,f:5,"f#":6,gb:6,g:7,"g#":8,ab:8,a:9,"a#":10,bb:10,b:11,cb:11},flock.interpolate={none:function(e,t){return e%=t.length,t[0|e]},linear:function(e,t){var n=t.length;e%=n;var o=0|e,r=(o+1)%n,a=e-o,i=t[o],u=t[r];return i+a*(u-i)},hermite:function(e,t){var n=t.length,o=Math.floor(e),r=o%n,a=e-o,i=r>0?r-1:n-1,u=(r+1)%n,l=(r+2)%n,s=t[i],c=t[r],f=t[u],d=t[l],p=.5*(f-s),g=c-f,m=p+g,v=m+g+.5*(d-c),h=m+v,k=((v*a-h)*a+p)*a+c;return k}},flock.interpolate.cubic=flock.interpolate.hermite,flock.log={warn:function(e){fluid.log(fluid.logLevel.WARN,e)},debug:function(e){fluid.log(fluid.logLevel.INFO,e)}},flock.fail=function(e){if(flock.debug.failHard)throw new Error(e);fluid.log(fluid.logLevel.FAIL,e)},flock.pathParseError=function(e,t,n){var o="Error parsing path '"+t+"'. Segment '"+n+"' could not be resolved. Root object was: "+fluid.prettyPrintJSON(e);flock.fail(o)},flock.get=function(e,t){if(!e)return fluid.getGlobalValue(t);if(1===arguments.length&&"string"==typeof e)return fluid.getGlobalValue(e);if(t&&""!==t){var n,o=""===t?[]:String(t).split("."),r=e[o[0]];for(n=1;n<o.length;n++){if(null===r||void 0===r)return void flock.pathParseError(e,t,o[n-1]);r=r[o[n]]}return r}},flock.set=function(e,t,n){if(e&&t&&""!==t){var o,r,a=String(t).split("."),i=a.length,u=a[0];for(o=1;o<i;o++){if(e=e[u],r=typeof e,"object"!==r)return void flock.fail("Error while setting a value at path '"+t+"'. A non-container object was found at segment '"+u+"'. Value: "+e);u=a[o],void 0===e[u]&&(e[u]={})}return e[u]=n,n}},flock.invoke=function(e,t,n){var o="function"==typeof e?e:flock.get(e,t);return"function"!=typeof o?void flock.fail("Path '"+t+"' does not resolve to a function."):o.apply(null,n)},flock.input={},flock.input.shouldExpand=function(e){return flock.parse.specialInputs.indexOf(e)<0},flock.input.pathExpander=function(e){var t,n=fluid.model.parseEL(e),o="inputs",r=n.length,a=r-1,i=[];for(t=0;t<a;t++){var u=n[t],l=n[t+1];if(i.push(u),"model"===l||"options"===l){i=i.concat(n.slice(t+1,a));break}isNaN(Number(l))&&i.push(o)}return i.push(n[a]),i.join(".")},flock.input.expandPaths=function(e){var t,n,o,r={};for(t in e)n=flock.input.pathExpander(t),o=e[t],r[n]=o;return r},flock.input.expandPath=function(e){return"string"==typeof e?flock.input.pathExpander(e):flock.input.expandPaths(e)},flock.input.getValueForPath=function(e,t){t=flock.input.expandPath(t);var n=flock.get(e,t);return flock.hasTag(n,"flock.ugen.valueType")?n.inputs.value:n},flock.input.getValuesForPathArray=function(e,t){var n,o,r={};for(n=0;n<t.length;n++)o=t[n],r[o]=flock.input.get(e,o);return r},flock.input.getValuesForPathObject=function(e,t){var n;for(n in t)t[n]=flock.input.get(e,n);return t},flock.input.get=function(e,t){return"string"==typeof t?flock.input.getValueForPath(e,t):flock.isIterable(t)?flock.input.getValuesForPathArray(e,t):flock.input.getValuesForPathObject(e,t)},flock.input.resolveValue=function(e,t,n,o,r,a,i){if("string"==typeof n){var u=fluid.extractEL(n,flock.input.valueExpressionSpec);if(u){var l=flock.input.getValueForPath(e,u);return void 0===l&&flock.log.debug("The value expression '"+n+"' resolved to undefined. If this isn't expected, check to ensure that your path is valid."),l}}return flock.input.shouldExpand(r)&&i?i(n,t,o,a):n},flock.input.valueExpressionSpec={ELstyle:"${}"},flock.input.setValueForPath=function(e,t,n,o,r){t=flock.input.expandPath(t);var a=flock.get(e,t),i=t.lastIndexOf("."),u=t.slice(i+1),l=i>-1?flock.get(e,t.slice(0,t.lastIndexOf(".inputs"))):o,s=flock.input.resolveValue(e,t,n,l,u,a,r);return flock.set(e,t,s),l&&l.onInputChanged&&l.onInputChanged(u),s},flock.input.setValuesForPaths=function(e,t,n,o){var r,a,i,u={};for(r in t)a=t[r],i=flock.input.set(e,r,a,n,o),u[r]=i;return u},flock.input.set=function(e,t,n,o,r){return"string"==typeof t?flock.input.setValueForPath(e,t,n,o,r):flock.input.setValuesForPaths(e,t,o,r)},fluid.defaults("flock.nodeList",{gradeNames:["fluid.littleComponent","autoInit"],members:{nodes:[],namedNodes:{}}}),flock.nodeList.preInit=function(e){e.head=function(t){return e.nodes.unshift(t),t.nickName&&(e.namedNodes[t.nickName]=t),0},e.before=function(t,n){var o=e.nodes.indexOf(t);return e.insert(o,n),o},e.after=function(t,n){var o=e.nodes.indexOf(t),r=o+1;return e.insert(r,n),r},e.insert=function(t,n){return t<0?e.head(n):(e.nodes.splice(t,0,n),n.nickName&&(e.namedNodes[n.nickName]=n),t)},e.tail=function(t){return e.nodes.push(t),t.nickName&&(e.namedNodes[t.nickName]=t),e.nodes.length},e.remove=function(t){var n=e.nodes.indexOf(t);return n<0?n:(e.nodes.splice(n,1),delete e.namedNodes[t.nickName],n)},e.replace=function(t,n){var o=e.nodes.indexOf(n);return o<0?e.head(t):(e.nodes[o]=t,delete e.namedNodes[n.nickName],t.nickName&&(e.namedNodes[t.nickName]=t),o)},e.clearAll=function(){for(;e.nodes.length>0;)e.nodes.pop()}},fluid.defaults("flock.enviro",{gradeNames:["fluid.standardRelayComponent","flock.nodeList","autoInit"],members:{audioSettings:"@expand:flock.enviro.clampAudioSettings({that}.options.audioSettings)",buses:{expander:{funcName:"flock.enviro.createAudioBuffers",args:["{that}.audioSettings.numBuses","{that}.audioSettings.blockSize"]}},buffers:{},bufferSources:{}},model:{isPlaying:!1,nextAvailableBus:{input:0,interconnect:0}},audioSettings:{rates:{audio:48e3,control:void 0,scheduled:void 0,demand:0,constant:0},blockSize:64,chans:2,numInputBuses:2,numBuses:8,bufferSize:flock.defaultBufferSizeForPlatform()},components:{asyncScheduler:{type:"flock.scheduler.async"},audioStrategy:{type:"flock.audioStrategy.platform",options:{audioSettings:"{enviro}.audioSettings"}}},invokers:{acquireNextBus:{funcName:"flock.enviro.acquireNextBus",args:["{arguments}.0","{that}.buses","{that}.applier","{that}.model","{that}.audioSettings"]}},listeners:{onCreate:{funcName:"flock.enviro.calculateControlRate",args:["{that}.audioSettings"]}}}),flock.enviro.clampAudioSettings=function(e){return e.numInputBuses=Math.min(e.numInputBuses,flock.MAX_INPUT_BUSES),e.numInputBuses=Math.max(e.numInputBuses,flock.MIN_INPUT_BUSES),e.chans=Math.min(e.chans,flock.MAX_CHANNELS),e.numBuses=Math.max(e.numBuses,e.chans),e.numBuses=Math.max(e.numBuses,flock.MIN_BUSES),e},flock.enviro.calculateControlRate=function(e){return e.rates.control=e.rates.audio/e.blockSize,e},flock.enviro.acquireNextBus=function(e,t,n,o,r){var a=o.nextAvailableBus[e];if(void 0===a)return void flock.fail("An invalid bus type was specified when invoking flock.enviro.acquireNextBus(). Type was: "+e);var i=a+r.chans,u=r.chans+r.numInputBuses;return"interconnect"===e&&(i+=r.numInputBuses,u=t.length),i>=u?void flock.fail("Unable to aquire a bus. There are insufficient buses available. Please use an existing bus or configure additional buses using the enviroment's numBuses and numInputBuses parameters."):(n.change("nextAvailableBus."+e,++a),i)},flock.enviro.preInit=function(e){e.start=function(){e.model.isPlaying||(e.audioStrategy.start(),e.model.isPlaying=!0)},e.play=e.start,e.stop=function(){e.model.isPlaying&&(e.audioStrategy.stop(),e.model.isPlaying=!1)},e.reset=function(){e.stop(),e.asyncScheduler.clearAll(),e.applier.change("nextAvailableBus.input",0),e.applier.change("nextAvailableBus.interconnect",0),e.audioStrategy.reset(),e.clearAll()},e.registerBuffer=function(t){t.id&&(e.buffers[t.id]=t)},e.releaseBuffer=function(t){if(t){var n="string"==typeof t?t:t.id;delete e.buffers[n]}}},flock.enviro.finalInit=function(e){e.gen=function(){var t=e.audioStrategy.nodeEvaluator;t.clearBuses(),t.gen()}},flock.enviro.createAudioBuffers=function(e,t){var n,o=[];for(n=0;n<e;n++)o[n]=new Float32Array(t);return o},fluid.defaults("flock.audioStrategy",{gradeNames:["fluid.standardRelayComponent"],components:{nodeEvaluator:{type:"flock.enviro.nodeEvaluator",options:{numBuses:"{enviro}.options.audioSettings.numBuses",blockSize:"{enviro}.options.audioSettings.blockSize",members:{buses:"{enviro}.buses",nodes:"{enviro}.nodes"}}}}}),fluid.defaults("flock.enviro.nodeEvaluator",{gradeNames:["fluid.littleComponent","autoInit"]}),flock.enviro.nodeEvaluator.finalInit=function(e){e.clearBuses=function(){var t,n,o,r=e.options.numBuses,a=e.options.blockSize;for(t=0;t<r;t++)for(n=e.buses[t],o=0;o<a;o++)n[o]=0},e.gen=function(){var t,n,o=e.nodes;for(t=0;t<o.length;t++)n=o[t],n.gen(n.model.blockSize)}},fluid.defaults("flock.autoEnviro",{gradeNames:["fluid.littleComponent","autoInit"]}),flock.autoEnviro.preInit=function(){flock.enviro.shared||flock.init()},fluid.defaults("flock.node",{gradeNames:["flock.autoEnviro","fluid.modelComponent","autoInit"]}),fluid.defaults("flock.ugenNodeList",{gradeNames:["flock.nodeList","autoInit"]}),flock.ugenNodeList.finalInit=function(e){e.insertTree=function(t,n){var o,r,a=n.inputs;for(o in a)r=a[o],flock.isUGen(r)&&(t=e.insertTree(t,r),t++);return e.insert(t,n)},e.removeTree=function(t){var n,o,r=t.inputs;for(n in r)o=r[n],"number"!=typeof o&&e.removeTree(o);return e.remove(t)},e.replaceTree=function(t,n){if(!n)return e.insertTree(e.nodes.length,t);var o=e.removeTree(n);return e.insertTree(o,t),o},e.swapTree=function(t,n,o){var r;if(o){for(r in n.inputs)o.indexOf(r)<0?e.removeTree(n.inputs[r]):t.inputs[r]=n.inputs[r];for(r in t.inputs)o.indexOf(r)<0&&e.replaceTree(t.inputs[r],n.inputs[r])}else t.inputs=n.inputs;return e.replace(t,n)}},fluid.defaults("flock.synth",{gradeNames:["fluid.eventedComponent","fluid.modelComponent","flock.node","flock.ugenNodeList","autoInit"],rate:flock.rates.AUDIO,invokers:{play:{funcName:"flock.synth.play",args:["{that}","{that}.enviro"]},pause:{funcName:"flock.synth.pause",args:["{that}","{that}.enviro"]}},listeners:{onDestroy:{func:"{that}.pause"}}}),flock.synth.play=function(e,t){t.nodes.indexOf(e)===-1&&t.head(e),t.model.isPlaying||t.play()},flock.synth.pause=function(e,t){t.remove(e)},flock.synth.finalInit=function(t){return t.rate=t.options.rate,t.enviro=t.enviro||flock.enviro.shared,t.audioSettings=e.extend(!0,{},t.enviro.audioSettings,t.options.audioSettings),t.model.blockSize=t.rate===flock.rates.AUDIO?t.audioSettings.blockSize:1,t.gen=function(){var e,n,o=t.model,r=t.nodes;for(e=0;e<r.length;e++)n=r[e],void 0!==n.gen&&n.gen(n.model.blockSize),o.value=n.model.value},t.get=function(e){return flock.input.get(t.namedNodes,e)},t.set=function(e,n,o){return flock.input.set(t.namedNodes,e,n,void 0,function(e,n,r,a){return flock.synth.ugenValueParser(t,e,a,o)})},t.input=function(e,n,o){return e?"string"==typeof e?arguments.length<2?t.get(e):t.set(e,n,o):flock.isIterable(e)?t.get(e):t.set(e,n,o):void 0},t.init=function(){var e=t.options,n=e.rate===flock.rates.SCHEDULED||e.rate===flock.rates.DEMAND;e.synthDef||fluid.log(fluid.logLevel.IMPORTANT,"Warning: Instantiating a flock.synth instance with an empty synth def."),t.out=flock.parse.synthDef(e.synthDef,{rate:e.rate,overrideRate:n,visitors:t.tail,buffers:t.enviro.buffers,buses:t.enviro.buses,audioSettings:t.audioSettings}),e.addToEnvironment!==!1&&t.enviro.tail(t)},t.init(),t},flock.synth.ugenValueParser=function(e,t,n,o){if(null===t||void 0===t)return n;var r,a,i,u=flock.parse.ugenDef(t,{audioSettings:e.audioSettings,buses:e.enviro.buses,buffers:e.enviro.buffers}),l=flock.isIterable(u)?u:void 0!==u?[u]:[],s=flock.isIterable(n)?n:void 0!==n?[n]:[],c=Math.min(l.length,s.length),f=o?e.swapTree:e.replaceTree;for(r=0;r<c;r++)a=f(l[r],s[r]);for(i=r;i<l.length;i++)a++,e.insertTree(a,l[i]);for(i=r;i<s.length;i++)e.removeTree(s[i]);return u},flock.synth.make=function(e,t){return t=t||{},t.synthDef=e,flock.synth(t)},fluid.defaults("flock.synth.value",{gradeNames:["flock.synth","autoInit"],rate:"demand",addToEnvironment:!1}),flock.synth.value.finalInit=function(e){e.value=function(){return e.gen(1),e.model.value}},fluid.defaults("flock.synth.frameRate",{gradeNames:["flock.synth.value","autoInit"],rate:"scheduled",fps:60,audioSettings:{rates:{scheduled:"{that}.options.fps"}}}),fluid.defaults("flock.synth.group",{gradeNames:["fluid.eventedComponent","flock.node","flock.nodeList","autoInit"],rate:flock.rates.AUDIO}),flock.synth.group.finalInit=function(e){e.rate=e.options.rate,e.enviro=e.enviro||flock.enviro.shared,flock.synth.group.makeDispatchedMethods(e,["input","get","set","gen","play","pause"]),e.init=function(){e.options.addToEnvironment!==!1&&e.enviro.tail(e)},e.init()},flock.synth.group.makeDispatcher=function(e,t){return function(){var n,o,r;for(n=0;n<e.length;n++)o=e[n],r=o[t].apply(o,arguments);return r}},flock.synth.group.makeDispatchedMethods=function(e,t){var n,o;for(o=0;o<t.length;o++)n=t[o],e[n]=flock.synth.group.makeDispatcher(e.nodes,n,flock.synth.group.dispatch);return e},fluid.defaults("flock.synth.polyphonic",{gradeNames:["flock.synth.group","autoInit"],noteSpecs:{on:{"env.gate":1},off:{"env.gate":0}},maxVoices:16,initVoicesLazily:!0,amplitudeKey:"env.sustain",amplitudeNormalizer:"static"}),flock.synth.polyphonic.finalInit=function(t){return t.activeVoices={},t.freeVoices=[],t.noteChange=function(n,o,r){var a=t.options.noteSpecs[o];r=e.extend({},a,r),n.input(r)},t.noteOn=function(e,n){var o=t.nextFreeVoice();return t.activeVoices[e]&&t.noteOff(e),t.activeVoices[e]=o,t.noteChange(o,"on",n),o},t.noteOff=function(e,n){var o=t.activeVoices[e];return o?(t.noteChange(o,"off",n),delete t.activeVoices[e],t.freeVoices.push(o),o):null},t.createVoice=function(){var e,n=flock.synth({synthDef:t.options.synthDef,addToEnvironment:!1}),o=t.options.amplitudeNormalizer,r=t.options.amplitudeKey;return o&&("function"==typeof o?o(n,r):"static"===o&&(e=1/t.options.maxVoices,n.input(r,e))),t.nodes.push(n),n},t.pooledVoiceAllocator=function(){return t.freeVoices.pop()},t.lazyVoiceAllocator=function(){return t.freeVoices.length>1?t.freeVoices.pop():Object.keys(t.activeVoices).length>t.options.maxVoices?null:t.createVoice()},t.init=function(){if(t.options.initVoicesLazily)t.nextFreeVoice=t.lazyVoiceAllocator;else{var e;for(e=0;e<t.options.maxVoices;e++)t.freeVoices[e]=t.createVoice();t.nextFreeVoice=t.pooledVoiceAllocator}},t.init(),t},fluid.defaults("flock.band",{gradeNames:["fluid.eventedComponent","autoInit"],invokers:{play:{func:"{that}.events.onPlay.fire"},pause:{func:"{that}.events.onPause.fire"},set:{func:"{that}.events.onSet.fire"}},events:{onPlay:null,onPause:null,onSet:null},distributeOptions:{source:"{that}.options.synthListeners",removeSource:!0,target:"{that flock.synth}.options.listeners"},synthListeners:{"{band}.events.onPlay":{func:"{that}.play"},"{band}.events.onPause":{func:"{that}.pause"}}}),flock.bufferDesc=function(){throw new Error("flock.bufferDesc is not defined. Did you forget to include the flocking-buffers.js file?")}}();var fluid=fluid||require("infusion"),flock=fluid.registerNamespace("flock");!function(){"use strict";flock.shim={URL:"undefined"!=typeof window?window.URL||window.webkitURL||window.msURL:void 0},flock.worker=function(e){var t,n,o=typeof e;if("function"===o)e="("+e.toString()+")();";else if("string"!==o)throw new Error("A flock.worker must be initialized with a String or a Function.");return window.Blob?(n=new Blob([e],{type:"text/javascript"}),t=flock.shim.URL.createObjectURL(n)):t="data:text/javascript;base64,"+window.btoa(e),new Worker(t)},fluid.registerNamespace("flock.scheduler"),fluid.defaults("flock.scheduler.intervalClock",{gradeNames:["fluid.eventedComponent","autoInit"],events:{tick:null}}),flock.scheduler.intervalClock.finalInit=function(e){e.scheduled={},e.schedule=function(t){var n=setInterval(function(){e.events.tick.fire(t)},t);e.scheduled[t]=n},e.clear=function(t){var n=e.scheduled[t];clearInterval(n),delete e.scheduled[t]},e.clearAll=function(){for(var t in e.scheduled)e.clear(t)},e.end=e.clearAll},fluid.defaults("flock.scheduler.scheduleClock",{gradeNames:["fluid.eventedComponent","autoInit"],events:{tick:null}}),flock.scheduler.scheduleClock.finalInit=function(e){e.scheduled=[],e.schedule=function(t){var n;n=setTimeout(function(){e.clear(n),e.events.tick.fire(t)},t),e.scheduled.push(n)},e.clear=function(t,n){n=void 0===n?e.scheduled.indexOf(t):n,n>-1&&e.scheduled.splice(n,1),clearTimeout(t)},e.clearAll=function(){for(var t=0;t<e.scheduled.length;t++){var n=e.scheduled[t];clearTimeout(n)}e.scheduled.length=0},e.end=e.clearAll},fluid.defaults("flock.scheduler.webWorkerClock",{gradeNames:["fluid.modelComponent","fluid.eventedComponent","autoInit"],model:{messages:{schedule:{msg:"schedule"},clear:{msg:"clear"},clearAll:{msg:"clearAll"},end:{msg:"end"}}},events:{tick:null},clockType:"intervalClock"}),flock.scheduler.webWorkerClock.finalInit=function(e){e.worker=new flock.worker(flock.scheduler.webWorkerClock.workerImpl),e.worker.postMessage({msg:"start",value:e.options.clockType}),e.worker.addEventListener("message",function(t){e.events.tick.fire(t.data.value)},!1),e.postToWorker=function(t,n){var o=e.model.messages[t];void 0!==n&&(o.value=n),e.worker.postMessage(o)},e.schedule=function(t){e.postToWorker("schedule",t)},e.clear=function(t){e.postToWorker("clear",t)},e.clearAll=function(){e.postToWorker("clearAll")},e.end=function(){e.postToWorker("end")}},flock.scheduler.webWorkerClock.workerImpl=function(){var e=e||{};e.worker=e.worker||{},e.worker.clock=function(){var e={};return e.tick=function(e){self.postMessage({msg:"tick",value:e})},e},e.worker.intervalClock=function(){var t=e.worker.clock();return t.scheduled={},t.schedule=function(e){var n=setInterval(function(){t.tick(e)},e);t.scheduled[e]=n},t.clear=function(e){var n=t.scheduled[e];clearInterval(n),delete t.scheduled[e]},t.clearAll=function(){for(var e in t.scheduled)t.clear(e)},t},e.worker.scheduleClock=function(){var t=e.worker.clock();return t.scheduled=[],t.schedule=function(e){var n;n=setTimeout(function(){t.clear(n),t.tick(e)},e),t.scheduled.push(n)},t.clear=function(e,n){n=void 0===n?t.scheduled.indexOf(e):n,n>-1&&t.scheduled.splice(n,1),clearTimeout(e)},t.clearAll=function(){for(var e=0;e<t.scheduled.length;e++){var n=t.scheduled[e];clearTimeout(n)}t.scheduled.length=0},t},self.addEventListener("message",function(t){"start"===t.data.msg?e.clock=e.worker[t.data.value]():"end"===t.data.msg?e.clock&&(e.clock.clearAll(),self.close()):e.clock&&e.clock[t.data.msg](t.data.value)},!1)},fluid.defaults("flock.scheduler.webWorkerIntervalClock",{gradeNames:["flock.scheduler.webWorkerClock","autoInit"],clockType:"intervalClock"}),fluid.defaults("flock.scheduler.webWorkerScheduleClock",{gradeNames:["flock.scheduler.webWorkerClock","autoInit"],clockType:"scheduleClock"}),flock.scheduler.makeOneShotValueListener=function(e,t,n){var o=function(r){r===e&&(t(r),n(o))};return o},flock.scheduler.makeRepeatingValueListener=function(e,t){return function(n){n===e&&t(n)}},fluid.defaults("flock.scheduler.async",{gradeNames:["fluid.eventedComponent","autoInit"],components:{timeConverter:{type:"flock.convert.seconds"},intervalClock:{type:"flock.scheduler.webWorkerIntervalClock"},scheduleClock:{type:"flock.scheduler.webWorkerScheduleClock"}}}),flock.scheduler.async.finalInit=function(e){e.intervalListeners={},e.scheduleListeners=[],e.addIntervalListener=function(t,n){var o=flock.scheduler.makeRepeatingValueListener(t,n);return o.wrappedListener=n,e.intervalListeners[t]=e.intervalListeners[t]||[],e.intervalListeners[t].push(o),e.intervalClock.events.tick.addListener(o),o},e.addScheduleListener=function(t,n){var o=flock.scheduler.makeOneShotValueListener(t,n,e.clear);return o.wrappedListener=n,e.scheduleListeners.push(o),e.scheduleClock.events.tick.addListener(o),o},e.scheduleChange=function(t,n,o,r){var a=e.timeConverter.value(t),i=flock.scheduler.async.prepareSchedulerFn(n,e.events),u=o(a,i);return r.schedule(a),u},e.repeat=function(t,n){return e.scheduleChange(t,n,e.addIntervalListener,e.intervalClock)},e.once=function(t,n){return e.scheduleChange(t,n,e.addScheduleListener,e.scheduleClock)},e.sequence=function(t,n){for(var o,r=[],a=0;a<t.length;a++)o=e.once(t[a],n),r.push(o);return r},e.schedule=function(t){t=flock.isIterable(t)?t:[t];var n,o;for(n=0;n<t.length;n++)o=t[n],flock.invoke(e,o.interval,[o.time,o.change])},e.clear=function(t){if(t){var n,o=e.scheduleListeners.indexOf(t);if(o>-1)return e.scheduleClock.events.tick.removeListener(t),void e.scheduleListeners.splice(o,1);e.intervalClock.events.tick.removeListener(t);for(n in e.intervalListeners)o=e.intervalListeners[n].indexOf(t),o>-1&&e.intervalListeners[n].splice(o,1)}},e.clearRepeat=function(t){e.intervalClock.clear(t);var n,o,r=e.intervalListeners[t];if(r){for(n=0;n<r.length;n++)o=r[n],e.intervalClock.events.tick.removeListener(o);return r.length=0,o}},e.clearAll=function(){e.intervalClock.clearAll();for(var t in e.intervalListeners)e.clearRepeat(t);e.scheduleClock.clearAll();for(var n in e.scheduleListeners)e.clear(n)},e.end=function(){e.intervalClock.end(),e.scheduleClock.end()},e.options.score&&e.schedule(e.options.score)},flock.scheduler.async.prepareSchedulerFn=function(e,t){var n,o=typeof e;return n="function"===o?e:"string"===o?t[e].fire:flock.scheduler.async.evaluateChangeSpec(e)},flock.scheduler.async.evaluateChangeSpec=function(e){var t={},n={};for(var o in e.values){var r=e.values[o];r.synthDef?t[o]=flock.synth.value(r):n[o]=r}return function(){for(var o in t){var r=t[o];n[o]=r.value()}var a="string"==typeof e.synth?flock.enviro.shared.namedNodes[e.synth]:e.synth;a.set(n)}},fluid.defaults("flock.scheduler.async.tempo",{gradeNames:["flock.scheduler.async","autoInit"],bpm:60,components:{timeConverter:{type:"flock.convert.beats",options:{bpm:"{tempo}.options.bpm"}}}}),fluid.registerNamespace("flock.convert"),flock.convert.makeStatelessConverter=function(e){return function(){return{value:e}}},flock.convert.ms=flock.convert.makeStatelessConverter(fluid.identity),flock.convert.seconds=flock.convert.makeStatelessConverter(function(e){return 1e3*e}),fluid.defaults("flock.convert.beats",{gradeNames:["fluid.littleComponent","autoInit"],bpm:60}),flock.convert.beats.finalInit=function(e){e.value=function(t){var n=e.options.bpm;return n<=0?0:t/n*6e4}}}();var fluid=fluid||require("infusion"),flock=fluid.registerNamespace("flock");!function(){"use strict";fluid.registerNamespace("flock.webAudio"),flock.webAudio.createNode=function(e,t,n,o){"string"!=typeof t&&(n=t.args,o=t.params,t=t.node),n=void 0===n||null===n?[]:fluid.isArrayable(n)?n:[n];var r="create"+t,a=r.indexOf("Node");a>-1&&(r=r.substring(0,a));var i=e[r].apply(e,n);return flock.webAudio.initializeNodeInputs(i,o),i},flock.webAudio.initializeNodeInputs=function(e,t){if(e&&t){for(var n in t)e[n].value=t[n];return e}},fluid.registerNamespace("flock.webAudio.chrome"),flock.webAudio.chrome.getSources=function(e){return MediaStreamTrack.getSources(function(t){var n=fluid.transform(t,function(e){return e.deviceId=e.id,e});e(n)})},flock.webAudio.mediaStreamFailure=function(){flock.fail("Media Capture and Streams are not supported on this browser.")};var e={AudioContext:window.AudioContext||window.webkitAudioContext,getUserMediaImpl:navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia||flock.webAudio.mediaStreamFailure,getUserMedia:function(){flock.shim.getUserMediaImpl.apply(navigator,arguments)},getMediaDevicesImpl:navigator.getMediaDevices?navigator.getMediaDevices:"undefined"!=typeof window.MediaStreamTrack?flock.webAudio.chrome.getSources:flock.webAudio.mediaStreamFailure,getMediaDevice:function(){flock.shim.getMediaDevicesImpl.apply(navigator,arguments)}};jQuery.extend(flock.shim,e),fluid.defaults("flock.audioStrategy.web",{gradeNames:["flock.audioStrategy","autoInit"],members:{context:"{contextWrapper}.context",sampleRate:"{that}.context.sampleRate",chans:{expander:{funcName:"flock.audioStrategy.web.calculateChannels",args:["{contextWrapper}.context","{enviro}.options.audioSettings.chans"]}},jsNode:{expander:{funcName:"flock.audioStrategy.web.createScriptProcessor",args:["{contextWrapper}.context","{enviro}.options.audioSettings.bufferSize","{enviro}.options.audioSettings.numInputBuses","{that}.chans"]}}},model:{isGenerating:!1,shouldInitIOS:flock.platform.isIOS,krPeriods:{expander:{funcName:"flock.audioStrategy.web.calcNumKrPeriods",args:"{enviro}.options.audioSettings"}}},invokers:{start:{func:"{that}.events.onStart.fire"},stop:{func:"{that}.events.onStop.fire"},reset:{func:"{that}.events.onReset.fire"}},components:{contextWrapper:{type:"flock.webAudio.contextWrapper"},nativeNodeManager:{type:"flock.webAudio.nativeNodeManager"},inputDeviceManager:{type:"flock.webAudio.inputDeviceManager"}},events:{onStart:null,onStop:null,onReset:null},listeners:{onCreate:[{funcName:"flock.audioStrategy.web.setChannelState",args:["{that}.chans","{contextWrapper}.context.destination"]},{funcName:"flock.audioStrategy.web.pushAudioSettings",args:["{that}.sampleRate","{that}.chans","{enviro}.options.audioSettings"]},{funcName:"flock.audioStrategy.web.bindWriter",args:["{that}.jsNode","{nodeEvaluator}","{nativeNodeManager}","{that}.model","{enviro}.options.audioSettings"]}],onStart:[{func:"{that}.applier.change",args:["isGenerating",!0]},{funcName:"flock.audioStrategy.web.iOSStart",args:["{that}.model","{that}.applier","{contextWrapper}.context","{that}.jsNode"]},{func:"{nativeNodeManager}.connect"}],onStop:[{func:"{that}.applier.change",args:["isGenerating",!1]},{func:"{nativeNodeManager}.disconnect"}],onReset:[{func:"{that}.stop"},{func:"{nativeNodeManager}.removeAllInputs"},{func:"{that}.applier.change",args:["playState.written",0]}]}}),flock.audioStrategy.web.calculateChannels=function(e,t){return flock.platform.browser.safari?e.destination.channelCount:Math.min(t,e.destination.maxChannelCount)},flock.audioStrategy.web.pushAudioSettings=function(e,t,n){n.rates.audio=e,n.chans=t},flock.audioStrategy.web.setChannelState=function(e,t){flock.platform.browser.safari||(t.channelCount=e,t.channelCountMode="explicit",t.channelInterpretation="discrete")},flock.audioStrategy.web.calcNumKrPeriods=function(e){return e.bufferSize/e.blockSize},flock.audioStrategy.web.createScriptProcessor=function(e,t,n,o){var r=e.createScriptProcessor?"createScriptProcessor":"createJavaScriptNode",a=e[r](t,n,o);
return a.channelCountMode="explicit",a},flock.audioStrategy.web.bindWriter=function(e,t,n,o,r){e.model=o,e.evaluator=t,e.audioSettings=r,e.inputNodes=n.inputNodes,e.onaudioprocess=flock.audioStrategy.web.writeSamples},flock.audioStrategy.web.writeSamples=function(e){var t,n,o,r=this.model,a=this.inputNodes.length,i=this.evaluator,u=this.audioSettings,l=e.inputBuffer,s=e.outputBuffer,c=r.krPeriods,f=i.buses,d=u.blockSize,p=u.chans,g=l.numberOfChannels;if(i.nodes.length<1)for(t=0;t<p;t++)flock.generate.silence(s.getChannelData(t));else for(n=0;n<c;n++){var m=n*d;if(i.clearBuses(),a>0)for(t=0;t<g;t++){var v=l.getChannelData(t),h=p+t,k=f[h];for(o=0;o<d;o++)k[o]=v[o+m]}for(i.gen(),t=0;t<p;t++){var y=f[t],b=s.getChannelData(t);for(o=0;o<d;o++)b[o+m]=y[o]}}},flock.audioStrategy.web.iOSStart=function(e,t,n,o){if(e.shouldInitIOS){var r=n.createBufferSource();r.connect(o),r.start(0),r.disconnect(0),t.change("shouldInitIOS",!1)}},fluid.defaults("flock.webAudio.contextWrapper",{gradeNames:["fluid.eventedComponent","autoInit"],members:{context:"@expand:flock.webAudio.contextWrapper.create()"},listeners:{onCreate:[{funcName:"flock.webAudio.contextWrapper.registerSingleton",args:["{that}"]}]}}),flock.webAudio.contextWrapper.create=function(){var e=fluid.staticEnvironment.webAudioContextWrapper;return e?e.context:new flock.shim.AudioContext},flock.webAudio.contextWrapper.registerSingleton=function(e){fluid.staticEnvironment.webAudioContextWrapper=e},fluid.defaults("flock.webAudio.nativeNodeManager",{gradeNames:["fluid.eventedComponent","autoInit"],audioSettings:"{enviro}.options.audioSettings",members:{outputNode:void 0,inputNodes:[],merger:{expander:{funcName:"flock.webAudio.nativeNodeManager.createInputMerger",args:["{contextWrapper}.context","{enviro}.options.audioSettings.numInputBuses","{web}.jsNode"]}}},invokers:{connect:{funcName:"flock.webAudio.nativeNodeManager.connect",args:["{that}.merger","{web}.jsNode","{that}.outputNode","{contextWrapper}.context.destination"]},createNode:{funcName:"flock.webAudio.createNode",args:["{contextWrapper}.context","{arguments}.0","{arguments}.1","{arguments}.2"]},createInputNode:{funcName:"flock.webAudio.nativeNodeManager.createInputNode",args:["{that}","{arguments}.0","{arguments}.1","{arguments}.2","{arguments}.3"]},createMediaStreamInput:{funcName:"flock.webAudio.nativeNodeManager.createInputNode",args:["{that}","MediaStreamSource","{arguments}.0",void 0,"{arguments}.1"]},createMediaElementInput:{funcName:"flock.webAudio.nativeNodeManager.createInputNode",args:["{that}","MediaElementSource","{arguments}.0",void 0,"{arguments}.1"]},createOutputNode:{funcName:"flock.webAudio.nativeNodeManager.createOutputNode",args:["{that}","{arguments}.0","{arguments}.1","{arguments}.2"]},disconnect:{funcName:"flock.webAudio.nativeNodeManager.disconnect",args:["{that}.merger","{web}.jsNode","{that}.outputNode"]},insertInput:{funcName:"flock.webAudio.nativeNodeManager.insertInput",args:["{that}","{enviro}","{arguments}.0","{arguments}.1"]},removeInput:{funcName:"flock.webAudio.nativeNodeManager.removeInput",args:["{arguments}.0","{that}.inputNodes"]},removeAllInputs:{funcName:"flock.webAudio.nativeNodeManager.removeAllInputs",args:"{that}.inputNodes"},insertOutput:{funcName:"flock.webAudio.nativeNodeManager.insertOutput",args:["{that}","{arguments}.0"]},removeOutput:{funcName:"flock.webAudio.nativeNodeManager.removeOutput",args:["{web}.jsNode"]}},listeners:{onCreate:{func:"{that}.insertOutput",args:"{web}.jsNode"}}}),flock.webAudio.nativeNodeManager.createInputNode=function(e,t,n,o,r){var a=e.createNode(t,n,o);return e.insertInput(a,r)},flock.webAudio.nativeNodeManager.createOutputNode=function(e,t,n,o){var r=e.createNode(t,n,o);return e.insertOutput(r)},flock.webAudio.nativeNodeManager.createInputMerger=function(e,t,n){var o=e.createChannelMerger(t);return o.channelInterpretation="discrete",o.connect(n),o},flock.webAudio.nativeNodeManager.connect=function(e,t,n,o){e.connect(t),n.connect(o),t!==n&&t.connect(n)},flock.webAudio.nativeNodeManager.disconnect=function(e,t,n){e.disconnect(0),t.disconnect(0),n.disconnect(0)},flock.webAudio.nativeNodeManager.removeAllInputs=function(e){for(var t=0;t<e.length;t++){var n=e[t];n.disconnect(0)}e.length=0},flock.webAudio.nativeNodeManager.insertInput=function(e,t,n,o){var r=e.options.audioSettings.numInputBuses;if(e.inputNodes.length>=r)return void flock.fail("There are too many input nodes connected to Flocking. The maximum number of input buses is currently set to "+r+". Either remove an existing input node or increase Flockings numInputBuses option.");o=void 0===o?t.acquireNextBus("input"):o;var a=o-t.audioSettings.chans;return e.inputNodes.push(n),n.connect(e.merger,0,a),o},flock.webAudio.nativeNodeManager.removeInput=function(e,t){var n=t.indexOf(e);n>-1&&t.splice(n,1),e.disconnect(0)},flock.webAudio.nativeNodeManager.insertOutput=function(e,t){return e.outputNode&&e.outputNode.disconnect(0),e.outputNode=t,t},flock.webAudio.nativeNodeManager.removeOutput=function(e){flock.webAudio.nativeNodeManager.insertOutput(e)},fluid.defaults("flock.webAudio.inputDeviceManager",{gradeNames:["fluid.eventedComponent","autoInit"],members:{context:"{contextWrapper}.context"},invokers:{openAudioDevice:{funcName:"flock.webAudio.inputDeviceManager.openAudioDevice",args:["{arguments}.0","{that}.openAudioDeviceWithId","{that}.openFirstAudioDeviceWithLabel","{that}.openAudioDeviceWithConstraints"]},openAudioDeviceWithConstraints:{funcName:"flock.webAudio.inputDeviceManager.openAudioDeviceWithConstraints",args:["{that}.context","{enviro}","{nativeNodeManager}.createMediaStreamInput","{arguments}.0"]},openAudioDeviceWithId:{funcName:"flock.webAudio.inputDeviceManager.openAudioDeviceWithId",args:["{arguments}.0","{that}.openAudioDeviceWithConstraints"]},openFirstAudioDeviceWithLabel:{funcName:"flock.webAudio.inputDeviceManager.openFirstAudioDeviceWithLabel",args:["{arguments}.0","{that}.openAudioDeviceWithId"]}}}),flock.webAudio.inputDeviceManager.openAudioDevice=function(e,t,n,o){if(e){if(e.id)return t(e.id);if(e.label)return n(e.label)}return o()},flock.webAudio.inputDeviceManager.openAudioDeviceWithId=function(e,t){var n={audio:{optional:[{sourceId:e}]}};t(n)},flock.webAudio.inputDeviceManager.openFirstAudioDeviceWithLabel=function(e,t){e&&flock.shim.getMediaDevices(function(n){var o=n.filter(function(t){if(t.label.toLowerCase()===e.toLowerCase())return!0});o.length>0?t(o[0].deviceId):fluid.log(fluid.logLevel.IMPORTANT,"An audio device named '"+e+"' could not be found.")})},flock.webAudio.inputDeviceManager.openAudioDeviceWithConstraints=function(e,t,n,o){function r(e){fluid.log(fluid.logLevel.IMPORTANT,"An error occurred while trying to access the user's microphone. "+e)}function a(e){n(e,i)}o=o||{audio:!0};var i=t.acquireNextBus("input");return flock.shim.getUserMedia(o,a,r),i},fluid.demands("flock.audioStrategy.platform","flock.platform.webAudio",{funcName:"flock.audioStrategy.web"})}();var fluid=fluid||require("infusion"),flock=fluid.registerNamespace("flock");!function(){"use strict";var e=fluid.registerNamespace("jQuery");fluid.registerNamespace("flock.parse"),flock.parse.synthDef=function(e,t){return e||(e=[]),flock.parse.synthDef.hasOutUGen(e)||(e={id:flock.OUT_UGEN_ID,ugen:"flock.ugen.valueOut",inputs:{sources:e}},t.rate===flock.rates.AUDIO&&(e.ugen="flock.ugen.out",e.inputs.bus=0,e.inputs.expand=t.audioSettings.chans)),flock.parse.ugenForDef(e,t)},flock.parse.synthDef.hasOutUGen=function(e){return!flock.isIterable(e)&&(e.id===flock.OUT_UGEN_ID||"flock.ugen.out"===e.ugen||"flock.ugen.valueOut"===e.ugen)},flock.parse.makeUGen=function(t,n,o){var r=o.audioSettings.rates,a=o.audioSettings.blockSize;t.rate||(t.rate=flock.rates.AUDIO);var i;i=t.options&&void 0!==t.options.sampleRate?t.options.sampleRate:r[t.rate],t.options=e.extend(!0,{},t.options,{sampleRate:i,rate:t.rate,audioSettings:{rates:r,blockSize:a}}),t.options.audioSettings.buffers=o.buffers,t.options.audioSettings.buses=o.buses;var u,l=t.rate===flock.rates.AUDIO?a:1;if(flock.hasTag(t.options,"flock.ugen.multiChannelOutput")){var s=t.options.numOutputs||1;u=[];for(var c=0;c<s;c++)u.push(new Float32Array(l))}else u=new Float32Array(l);return flock.invoke(void 0,t.ugen,[n,u,t.options])},flock.parse.reservedWords=["id","ugen","rate","inputs","options"],flock.parse.specialInputs=["value","buffer","list","table","envelope"],flock.parse.expandUGenDef=function(e){var t,n={};for(t in e)flock.parse.reservedWords.indexOf(t)===-1&&(n[t]=e[t],delete e[t]);return e.inputs=n,e},flock.parse.ugenDefForConstantValue=function(e){return{ugen:"flock.ugen.value",rate:flock.rates.CONSTANT,inputs:{value:e}}},flock.parse.expandValueDef=function(e){var t=typeof e;if("number"===t)return flock.parse.ugenDefForConstantValue(e);if("object"===t)return e;throw new Error("Invalid value type found in ugen definition. UGenDef was: "+fluid.prettyPrintJSON(e))},flock.parse.rateMap={ar:flock.rates.AUDIO,kr:flock.rates.CONTROL,sr:flock.rates.SCHEDULED,dr:flock.rates.DEMAND,cr:flock.rates.CONSTANT},flock.parse.expandRate=function(e,t){return e.rate=flock.parse.rateMap[e.rate]||e.rate,t.overrideRate&&e.rate!==flock.rates.CONSTANT&&(e.rate=t.rate),e},flock.parse.ugenDef=function(e,t){var n=flock.isIterable(e)?flock.parse.ugensForDefs:flock.parse.ugenForDef,o=n(e,t);return o},flock.parse.ugenDef.mergeOptions=function(t){var n=fluid.defaults(t.ugen)||{};return n=fluid.copy(n),n.options=n.ugenOptions,delete n.ugenOptions,e.extend(!0,{},n,t)},flock.parse.ugensForDefs=function(e,t){var n,o=[];for(n=0;n<e.length;n++)o[n]=flock.parse.ugenForDef(e[n],t);return o},flock.parse.ugenForDef=function(t,n){n=e.extend(!0,{audioSettings:flock.enviro.shared.options.audioSettings,buses:flock.enviro.shared.buses,buffers:flock.enviro.shared.buffers},n);var o=n,r=o.visitors,a=o.audioSettings.rates;if(t=flock.parse.expandValueDef(t),flock.isIterable(t))return flock.parse.ugensForDefs(t,n);t.inputs||(t=flock.parse.expandUGenDef(t)),flock.parse.expandRate(t,n),t=flock.parse.ugenDef.mergeOptions(t,n);var i,u=t.inputs,l={};for(i in u){var s=u[i];null!==s&&(l[i]=flock.input.shouldExpand(i,t)?flock.parse.ugenForDef(s,n):s)}if(!t.ugen)throw new Error("Unit generator definition lacks a 'ugen' property; can't initialize the synth graph. Value: "+fluid.prettyPrintJSON(t));var c=flock.parse.makeUGen(t,l,n);return t.id&&(c.id=t.id,c.nickName=t.id),c.options.ugenDef=t,r&&(r=fluid.makeArray(r),fluid.each(r,function(e){e(c,t,a)})),c},flock.parse.expandBufferDef=function(e){return"string"==typeof e?{id:e}:flock.isIterable(e)||e.data||e.format?flock.bufferDesc(e):e},flock.parse.bufferForDef=function(e,t,n){e=flock.parse.expandBufferDef(e),e.data&&e.data.channels?(e=flock.bufferDesc(e),flock.parse.bufferForDef.resolveBuffer(e,t,n)):flock.parse.bufferForDef.resolveDef(e,t,n)},flock.parse.bufferForDef.findSource=function(e,t){var n;return t&&e.id?(n=t.bufferSources[e.id],n||(n=t.bufferSources[e.id]=flock.bufferSource())):n=flock.bufferSource(),n},flock.parse.bufferForDef.bindToPromise=function(e,t,n){var o=function(e){t.events.onBufferUpdated.addListener(o),n&&n.setBuffer(e)},r=function(e){throw!e&&t.model.src&&t.model.src.indexOf(".aif")&&(e="if this is an AIFF file, you might need to include flocking-audiofile-compatibility.js in some browsers."),new Error("Error while resolving buffer "+t.model.src+": "+e)};e.then(o,r)},flock.parse.bufferForDef.resolveDef=function(e,t,n){var o,r=flock.parse.bufferForDef.findSource(e,n);e.src=e.url||e.src,e.selector&&"undefined"!=typeof document&&(e.src=document.querySelector(e.selector).files[0]),o=r.get(e),flock.parse.bufferForDef.bindToPromise(o,r,t)},flock.parse.bufferForDef.resolveBuffer=function(e,t,n){var o=flock.parse.bufferForDef.findSource(e,n),r=o.set(e);flock.parse.bufferForDef.bindToPromise(r,o,t)}}();var fluid=fluid||require("infusion"),flock=fluid.registerNamespace("flock");!function(){"use strict";var e=fluid.registerNamespace("jQuery"),t=flock.requireModule("dspapi","DSP"),n=flock.requireModule("dspapi","Filter");flock.isUGen=function(e){return e&&e.tags&&e.tags.indexOf("flock.ugen")>-1},flock.aliasUGen=function(t,n,o,r){var a=flock.get(t);flock.set(a,n,function(t,n,o){return o=e.extend(!0,{},r,o),a(t,n,o)}),fluid.defaults(t+"."+n,o)},flock.aliasUGens=function(e,t){var n,o;for(n in t)o=t[n],flock.aliasUGen(e,n,{inputs:o.inputDefaults},o.options)},flock.krMul=function(e,t,n){var o,r=n.output[0];for(o=0;o<e;o++)t[o]=t[o]*r},flock.mul=function(e,t,n){var o,r=n.output;for(o=0;o<e;o++)t[o]=t[o]*r[o]},flock.krAdd=function(e,t,n,o){var r,a=o.output[0];for(r=0;r<e;r++)t[r]=t[r]+a},flock.add=function(e,t,n,o){var r,a=o.output;for(r=0;r<e;r++)t[r]=t[r]+a[r]},flock.krMulAdd=function(e,t,n,o){var r,a=n.output[0],i=o.output;for(r=0;r<e;r++)t[r]=t[r]*a+i[r]},flock.mulKrAdd=function(e,t,n,o){var r,a=n.output,i=o.output[0];for(r=0;r<e;r++)t[r]=t[r]*a[r]+i},flock.krMulKrAdd=function(e,t,n,o){var r,a=n.output[0],i=o.output[0];for(r=0;r<e;r++)t[r]=t[r]*a+i},flock.mulAdd=function(e,t,n,o){var r,a=n.output,i=o.output;for(r=0;r<e;r++)t[r]=t[r]*a[r]+i[r]},flock.onMulAddInputChanged=function(e){var t,n=e.inputs.mul,o=e.inputs.add;return n||o?(t=n?o?n.rate!==flock.rates.AUDIO?o.rate!==flock.rates.AUDIO?flock.krMulKrAdd:flock.krMulAdd:o.rate!==flock.rates.AUDIO?flock.mulKrAdd:flock.mulAdd:n.rate!==flock.rates.AUDIO?flock.krMul:flock.mul:o.rate!==flock.rates.AUDIO?flock.krAdd:flock.add,void(e.mulAdd=function(r){t(r,e.output,n,o)})):void(e.mulAdd=flock.noOp)},flock.ugen=function(e,t,n){n=n||{};var o={rate:n.rate||flock.rates.AUDIO,inputs:e,output:t,options:n,model:n.model||{unscaledValue:0,value:0},multiInputs:{},tags:["flock.ugen"]};return o.lastOutputIdx=o.output.length-1,o.get=function(e){return flock.input.get(o.inputs,e)},o.set=function(e,t){return flock.input.set(o.inputs,e,t,o,function(e){if(null!==e&&void 0!==e)return flock.parse.ugenDef(e,{audioSettings:o.options.audioSettings,buses:o.options.audioSettings.buses,buffers:o.options.audioSettings.buffers})})},o.input=function(e,t){return e?"string"==typeof e?arguments.length<2?o.get(e):o.set(e,t):flock.isIterable(e)?o.get(e):o.set(e,t):void 0},o.calculateStrides=function(){var e,t,n,r=o.model,a=o.options.strideInputs,i=o.inputs;if(r.strides=r.strides||{},a)for(e=0;e<a.length;e++)t=a[e],n=i[t],n?r.strides[t]=n.rate===flock.rates.AUDIO?1:0:fluid.log(fluid.logLevel.WARN,"An invalid input ('"+t+"') was found on a unit generator: "+o)},o.collectMultiInputs=function(){var e,t,n,r,a=o.options.multiInputNames,i=o.multiInputs;for(e=0;e<a.length;e++)t=a[e],n=i[t],n?n.length=0:n=i[t]=[],r=o.inputs[t],flock.ugen.collectMultiInputs(r,n)},o.onInputChanged=function(e){var t=o.options.multiInputNames;flock.onMulAddInputChanged(o),o.options.strideInputs&&o.calculateStrides(),!t||e&&!t.indexOf(e)||o.collectMultiInputs()},o.init=function(){var e,t,n,r=fluid.makeArray(o.options.tags),a=o.model,i=o.options;for(e=0;e<r.length;e++)o.tags.push(r[e]);if(t=i.audioSettings=i.audioSettings||flock.enviro.shared.audioSettings,a.sampleRate=i.sampleRate||t.rates[o.rate],a.nyquistRate=a.sampleRate,a.blockSize=o.rate===flock.rates.AUDIO?t.blockSize:1,a.sampleDur=1/a.sampleRate,o.interpolate=flock.interpolate.none,i.interpolation){var u=flock.interpolate[i.interpolation];u?o.interpolate=u:fluid.log(fluid.logLevel.IMPORTANT,"An invalid interpolation type of '"+i.interpolation+"' was specified. Defaulting to none.")}o.rate===flock.rates.DEMAND&&o.inputs.freq&&(n=flock.parse.ugenDefForConstantValue(1),o.inputs.freq=flock.parse.ugenDef(n))},o.init(),o},flock.ugen.collectMultiInputs=function(e,t){flock.isIterable(e)||(e=e=fluid.makeArray(e));for(var n=0;n<e.length;n++){var o=e[n];flock.ugen.collectChannelsForInput(o,t)}return t},flock.ugen.collectChannelsForInput=function(e,t){var n,o=flock.hasTag(e,"flock.ugen.multiChannelOutput"),r=o?e.output:[e.output];for(n=0;n<r.length;n++)t.push({rate:e.rate,output:r[n]});return t},flock.ugen.lastOutputValue=function(e,t){return t[e-1]},flock.ugen.value=function(e,t,n){var o=flock.ugen(e,t,n);return o.value=function(){return o.model.value},o.dynamicGen=function(e){for(var t=o.output,n=o.model,r=0;r<e;r++)t[r]=n.unscaledValue;o.mulAdd(e),n.value=flock.ugen.lastOutputValue(e,t)},o.onInputChanged=function(){var e=o.inputs,t=o.model;t.value=t.unscaledValue=e.value,"constant"!==o.rate?o.gen=o.dynamicGen:o.gen=void 0,flock.onMulAddInputChanged(o),o.dynamicGen(1)},o.onInputChanged(),o},fluid.defaults("flock.ugen.value",{rate:"control",inputs:{value:1,mul:null,add:null},ugenOptions:{model:{unscaledValue:1,value:1},tags:["flock.ugen.valueType"]}}),flock.ugen.silence=function(e,t,n){var o=flock.ugen(e,t,n);return o.onInputChanged=function(){for(var e=0;e<o.output.length;e++)o.output[e]=0},o.onInputChanged(),o},fluid.defaults("flock.ugen.silence",{rate:"constant"}),flock.ugen.passThrough=function(e,t,n){var o=flock.ugen(e,t,n);return o.gen=function(e){var t,n,r=o.model,a=o.inputs.source.output,i=o.output;for(t=0;t<a.length;t++)i[t]=n=a[t];for(;t<e;t++)i[t]=n=0;r.unscaledValue=n,o.mulAdd(e),r.value=flock.ugen.lastOutputValue(e,i)},o.onInputChanged(),o},fluid.defaults("flock.ugen.passThrough",{rate:"audio",inputs:{source:null,mul:null,add:null}}),flock.ugen.change=function(e,t,n){var o=flock.ugen(e,t,n);return o.gen=function(e){for(var t,n=o.model,r=o.inputs.initial.output,a=n.strides.initial,i=o.inputs.target.output,u=n.strides.target,l=o.output,s=n.samplesLeft,c=n.crossfadeLevel,f=0,d=0,p=0;f<e;f++,d+=a,p+=u)s>0?(t=r[d],s--):c>0?(t=r[d]*c+i[p]*(1-c),c-=n.crossfadeStepSize):t=i[p],l[f]=t;n.samplesLeft=s,n.crossfadeLevel=c,n.value=n.unscaledValue=t},o.onInputChanged=function(e){var t=o.model,n=o.inputs;"time"!==e&&e||(t.samplesLeft=Math.round(n.time.output[0]*t.sampleRate)),"crossfade"!==e&&e||(t.crossfadeStepSize=1/Math.round(n.crossfade.output[0]*t.sampleRate),t.crossfadeLevel=n.crossfade.output[0]>0?1:0),o.calculateStrides()},o.onInputChanged(),o},fluid.defaults("flock.ugen.change",{rate:"audio",inputs:{initial:0,target:0,time:0,crossfade:0},ugenOptions:{model:{samplesLeft:0,crossfadeStepSize:0,crossfadeLevel:0,unscaledValue:0,value:0},strideInputs:["initial","target"]}}),flock.ugen.valueChangeTrigger=function(e,t,n){var o=flock.ugen(e,t,n);return o.gen=function(e){var t,n,r,a=o.model,i=o.inputs.source.output,u=o.output;for(t=0,n=0;t<e;t++,n+=a.strides.source)r=i[n],u[t]=r!==a.prevVal?1:0,a.prevVal=r;a.value=a.unscaledValue=r},o.onInputChanged=function(e){o.calculateStrides(),"source"===e&&(o.model.prevVal=null)},o.calculateStrides(),o},fluid.defaults("flock.ugen.valueChangeTrigger",{rate:"control",inputs:{source:0},ugenOptions:{model:{unscaledValue:0,value:0,prevVal:0},strideInputs:["source"]}}),flock.ugen.inputChangeTrigger=function(e,t,n){var o=flock.ugen(e,t,n);return o.gen=function(e){var t,n,r,a,i,u=o.model,l=o.inputs.source.output,s=u.strides.source,c=o.inputs.duration.output,f=u.strides.duration,d=u.prevDur,p=o.output;for(t=n=r=0;t<e;t++,n+=s,r+=f)a=l[n],i=c[r],i!==d&&(u.prevDur=i,u.remainingOpenSamples=a>0?i>0?u.sampleRate*i:1:0),u.remainingOpenSamples>0?(p[t]=a,u.remainingOpenSamples--):p[t]=0;u.value=u.unscaledValue=flock.ugen.lastOutputValue(e,p)},o.onInputChanged=function(e){o.calculateStrides(),"source"===e&&(o.model.prevDur=null)},o.calculateStrides(),o},fluid.defaults("flock.ugen.inputChangeTrigger",{rate:"control",inputs:{source:0,duration:0},ugenOptions:{model:{unscaledValue:0,value:0,prevDuration:0,remainingOpenSamples:0},strideInputs:["source","duration"]}}),flock.ugen.triggerCallback=function(e,t,n){var o=flock.ugen(e,t,n);return o.gen=function(e){var t,n,r,a,i,u=o.model,l=o.options,s=o.output,c=o.inputs,f=u.strides.trigger,d=u.strides.source,p=c.trigger.output,g=c.source.output,m=l.callback,v=m.func,h=m.args,k=m.this,y=u.lastArgIdx,b=u.prevTrig;for(t=n=r=0;t<e;t++,n+=f,r+=d)a=p[n],i=g[r],a>0&&b<=0&&v&&(h[y]=i,v.apply(k,h)),s[t]=i,b=a;u.prevTrig=b,u.value=u.unscaledValue=i},o.onInputChanged=function(){var e=o.options,t=o.model,n=e.callback,r=n.funcName;if(r)n.func=fluid.getGlobalValue(r);else if(n.this&&n.method){if("string"!=typeof n.this)throw new Error("flock.ugen.triggerCallback doesn't support raw 'this' objects.Use a global key path instead.");n.this="string"==typeof n.this?fluid.getGlobalValue(n.this):n.this,n.func=fluid.get(n.this,n.method)}t.lastArgIdx=n.args.length,o.calculateStrides()},o.onInputChanged(),o},fluid.defaults("flock.ugen.triggerCallback",{rate:"audio",inputs:{source:0,trigger:0},ugenOptions:{model:{unscaledValue:0,value:0,funcName:void 0,lastArgIdx:0},callback:{this:void 0,method:void 0,func:void 0,args:[]},strideInputs:["source","trigger"]}}),flock.ugen.math=function(e,n,o){var r=flock.ugen(e,n,o);return r.expandedSource=new Float32Array(r.options.audioSettings.blockSize),r.krSourceKrInputGen=function(){var e=r.model,n=r.activeInput,o=r.inputs[n],a=r.output,i=flock.generate(r.expandedSource,r.inputs.source.output[0]);t[n](a,i,o.output[0]),e.value=e.unscaledValue=a[a.length-1]},r.krSourceArInputGen=function(){var e=r.model,n=r.activeInput,o=r.inputs[n],a=r.output,i=flock.generate(r.expandedSource,r.inputs.source.output[0]);t[n](a,i,o.output),e.value=e.unscaledValue=a[a.length-1]},r.arSourceKrInputGen=function(){var e=r.model,n=r.activeInput,o=r.inputs[n],a=r.output,i=r.inputs.source.output;t[n](a,i,o.output[0]),e.value=e.unscaledValue=a[a.length-1]},r.arSourceArInputGen=function(){var e=r.model,n=r.activeInput,o=r.inputs[n],a=r.output;t[n](r.output,r.inputs.source.output,o.output),e.value=e.unscaledValue=a[a.length-1]},r.onInputChanged=function(){var e,t,n,o=Object.keys(r.inputs);for(e=0;e<o.length;e++)if(t=o[e],"source"!==t){r.activeInput=t,n="audio"===r.inputs[t].rate,r.gen="audio"===r.inputs.source.rate?n?r.arSourceArInputGen:r.arSourceKrInputGen:n?r.krSourceArInputGen:r.krSourceKrInputGen;break}},r.init=function(){if("undefined"==typeof t)throw new Error("DSP is undefined. Please include dspapi.js to use the flock.math unit generator.");r.onInputChanged()},r.init(),r},fluid.defaults("flock.ugen.math",{rate:"audio",inputs:{source:null}}),flock.ugen.sum=function(e,t,n){var o=flock.ugen(e,t,n);return o.copyGen=function(e){var t,n=o.model,r=o.output,a=o.inputs.sources.output;for(t=0;t<e;t++)r[t]=a[t];n.value=n.unscaledValue=flock.ugen.lastOutputValue(e,r)},o.sumGen=function(e){var t,n,r,a=o.model,i=o.inputs.sources,u=o.output;for(t=0;t<e;t++){for(r=0,n=0;n<i.length;n++)r+=i[n].output[t];u[t]=r}a.value=a.unscaledValue=flock.ugen.lastOutputValue(e,u)},o.onInputChanged=function(){"number"==typeof o.inputs.sources.length?o.gen=o.sumGen:o.gen=o.copyGen},o.onInputChanged(),o},fluid.defaults("flock.ugen.sum",{rate:"audio",inputs:{sources:null}}),flock.ugen.osc=function(e,t,n){var o=flock.ugen(e,t,n);return o.gen=function(e){var t,n,r,a,i,u=o.model,l=o.inputs,s=l.freq.output,c=l.phase.output,f=l.table,d=u.tableLen,p=u.tableIncHz,g=u.tableIncRad,m=o.output,v=u.phase;for(t=0,n=0,r=0;t<e;t++,n+=u.strides.phase,r+=u.strides.freq)a=v+c[n]*g,a>=d?a-=d:a<0&&(a+=d),m[t]=i=o.interpolate(a,f),v+=s[r]*p,v>=d?v-=d:v<0&&(v+=d);u.phase=v,u.unscaledValue=i,o.mulAdd(e),u.value=flock.ugen.lastOutputValue(e,m)},o.onInputChanged=function(e){if(flock.ugen.osc.onInputChanged(o),!e||"table"===e){var t=o.model,n=o.inputs.table;n.length<1&&(n=o.inputs.table=flock.ugen.osc.emptyTable),t.tableLen=n.length,t.tableIncHz=t.tableLen/t.sampleRate,t.tableIncRad=t.tableLen/flock.TWOPI}},o.onInputChanged(),o},flock.ugen.osc.emptyTable=new Float32Array([0,0,0]),flock.ugen.osc.onInputChanged=function(e){e.calculateStrides(),flock.onMulAddInputChanged(e)},fluid.defaults("flock.ugen.osc",{rate:"audio",inputs:{freq:440,phase:0,table:[],mul:null,add:null},ugenOptions:{interpolation:"linear",model:{phase:0,unscaledValue:0,value:0},strideInputs:["freq","phase"]},tableSize:8192}),flock.ugen.osc.define=function(e,t){var n=e.lastIndexOf("."),o=e.substring(0,n),r=e.substring(n+1),a=flock.get(o);a[r]=function(e,n,o){var r=fluid.defaults("flock.ugen.osc"),a=fluid.merge(null,r,o),i=a.tableSize;return e.table=flock.fillTable(i,t),flock.ugen.osc(e,n,o)},fluid.defaults(e,fluid.defaults("flock.ugen.osc"))},flock.ugen.osc.define("flock.ugen.sinOsc",flock.tableGenerators.sin),flock.ugen.osc.define("flock.ugen.triOsc",flock.tableGenerators.tri),flock.ugen.osc.define("flock.ugen.sawOsc",flock.tableGenerators.saw),flock.ugen.osc.define("flock.ugen.squareOsc",flock.tableGenerators.square),flock.ugen.sin=function(e,t,n){var o=flock.ugen(e,t,n);return o.gen=function(e){var t,n,r,a,i=o.model,u=o.inputs.freq.output,l=o.inputs.phase.output,s=o.output,c=i.phase,f=i.sampleRate;for(t=0,n=0,r=0;t<e;t++,n+=i.strides.phase,r+=i.strides.freq)s[t]=a=Math.sin(c+l[n]),c+=u[r]/f*flock.TWOPI;i.phase=c,i.unscaledValue=a,o.mulAdd(e),i.value=flock.ugen.lastOutputValue(e,s)},o.onInputChanged=function(){flock.ugen.osc.onInputChanged(o)},o.onInputChanged(),o},fluid.defaults("flock.ugen.sin",{rate:"audio",inputs:{freq:440,phase:0,mul:null,add:null},ugenOptions:{model:{phase:0,unscaledValue:0,value:0},strideInputs:["freq","phase"]}}),flock.ugen.lfSaw=function(e,t,n){var o=flock.ugen(e,t,n);return o.gen=function(e){var t,n,r,a=o.model,i=o.inputs.freq.output,u=o.output,l=a.scale,s=o.inputs.phase.output[0],c=a.phase;for(t=0,n=0;t<e;t++,n+=a.strides.freq)u[t]=r=c+s,c+=i[n]*l,c>=1?c-=2:c<=-1&&(c+=2);a.phase=c,a.unscaledValue=r,o.mulAdd(e),a.value=flock.ugen.lastOutputValue(e,u)},o.onInputChanged=function(){var e=o.model;e.freqInc=o.inputs.freq.rate===flock.rates.AUDIO?1:0,e.phase=0,o.calculateStrides(),flock.onMulAddInputChanged(o)},o.init=function(){o.model.scale=2*(1/o.options.sampleRate),o.onInputChanged()},o.init(),o},fluid.defaults("flock.ugen.lfSaw",{rate:"audio",inputs:{freq:440,phase:0,mul:null,add:null},ugenOptions:{model:{phase:0,freqInc:1,unscaledValue:0,value:0},strideInputs:["freq"]}}),flock.ugen.lfPulse=function(e,t,n){var o=flock.ugen(e,t,n);return o.gen=function(e){var t,n,r,a=o.inputs,i=o.model,u=a.freq.output,l=i.freqInc,s=a.width.output[0],c=o.output,f=i.scale,d=void 0!==i.phase?i.phase:a.phase.output[0];for(t=0,n=0;t<e;t++,n+=l)d>=1?(d-=1,c[t]=r=s<.5?1:-1):c[t]=r=d<s?1:-1,d+=u[n]*f;i.phase=d,i.unscaledValue=r,o.mulAdd(e),i.value=flock.ugen.lastOutputValue(e,c)},o.onInputChanged=function(){o.model.freqInc=o.inputs.freq.rate===flock.rates.AUDIO?1:0,flock.onMulAddInputChanged(o)},o.init=function(){o.model.scale=1/o.options.sampleRate,o.onInputChanged()},o.init(),o},fluid.defaults("flock.ugen.lfPulse",{rate:"audio",inputs:{freq:440,phase:0,width:.5,mul:null,add:null},ugenOptions:{model:{phase:0,freqInc:1,unscaledValue:0,value:0}}}),flock.ugen.impulse=function(e,t,n){var o=flock.ugen(e,t,n);return o.gen=function(e){var t,n,r,a=o.inputs,i=o.model,u=o.output,l=a.freq.output,s=i.strides.freq,c=a.phase.output[0],f=i.phase,d=i.scale;for(f+=c,t=0,n=0;t<e;t++,n+=s)f>=1?(f-=1,r=1):r=0,u[t]=r,f+=l[n]*d;i.phase=f-c,i.unscaledValue=r,o.mulAdd(e),i.value=flock.ugen.lastOutputValue(e,u)},o.onInputChanged=function(){o.calculateStrides(),flock.onMulAddInputChanged(o)},o.init=function(){o.model.scale=1/o.model.sampleRate,o.onInputChanged()},o.init(),o},fluid.defaults("flock.ugen.impulse",{rate:"audio",inputs:{freq:440,phase:0,mul:null,add:null},ugenOptions:{model:{phase:0,scale:0,unscaledValue:0,value:0},strideInputs:["freq"]}}),flock.ugen.t2a=function(e,t,n){var o=flock.ugen(e,t,n);return o.gen=function(){for(var e,t=o.model,n=o.inputs.source.output[0],r=0|o.inputs.offset.output[0],a=o.output,i=0;i<a.length;i++)a[i]=e=0;n>0&&t.prevTrig<=0&&(a[r]=e=n),t.prevTrig=n,t.value=t.unscaledValue=e},o},fluid.defaults("flock.ugen.t2a",{rate:"audio",inputs:{source:null,offset:0},ugenOptions:{model:{prevTrig:0,unscaledValue:0,value:0}}}),flock.ugen.latch=function(e,t,n){var o=flock.ugen(e,t,n);return o.arGen=function(e){var t,n,r,a,i=o.model,u=o.inputs,l=u.source.output,s=u.trigger,c=i.strides.source,f=o.output;for(void 0===i.holdVal&&(i.holdVal=l[0]),t=0,n=0;t<e;t++,n+=c)r=s.output[t],f[t]=a=r>0&&i.prevTrig<=0?i.holdVal=l[n]:i.holdVal,i.prevTrig=r;i.unscaledValue=a,o.mulAdd(e),i.value=flock.ugen.lastOutputValue(e,f)},o.krGen=function(e){var t,n=o.model,r=o.output,a=o.inputs.trigger.output[0];for((void 0===n.holdVal||a>0&&n.prevTrig<=0)&&(n.holdVal=o.inputs.source.output[0]),n.prevTrig=a,t=0;t<e;t++)r[t]=n.holdVal;n.unscaledValue=n.holdVal,o.mulAdd(e),n.value=flock.ugen.lastOutputValue(e,r)},o.onInputChanged=function(){o.calculateStrides(),o.gen=o.inputs.trigger.rate===flock.rates.AUDIO?o.arGen:o.krGen,flock.onMulAddInputChanged(o)},o.onInputChanged(),o},fluid.defaults("flock.ugen.latch",{rate:"audio",inputs:{source:null,trigger:0,mul:null,add:null},ugenOptions:{strideInputs:["source"],model:{prevTrig:0,unscaledValue:0,value:0}}}),flock.ugen.buffer=function(e){e.onBufferInputChanged=function(t){var n=e.model,o=e.inputs;n.bufDef===o.buffer&&"buffer"!==t||(n.bufDef=o.buffer,flock.parse.bufferForDef(n.bufDef,e,flock.enviro.shared))},e.setBuffer=function(t){e.buffer=t,e.onBufferReady&&e.onBufferReady(t)},e.initBuffer=function(){e.buffer=e.model.bufDef=flock.bufferDesc({format:{sampleRate:e.options.audioSettings.rates.audio},data:{channels:[new Float32Array(e.output.length)]}})}},flock.ugen.playBuffer=function(e,t,n){var o=flock.ugen(e,t,n);return o.defaultKrTriggerGen=function(t){var n,r,a=o.model,i=o.output,u=o.inputs.channel.output[0],l=o.buffer.data.channels[u],s=a.idx,c=o.inputs.loop.output[0],f=e.trigger.output[0];for(f>0&&a.prevTrig<=0&&(s=0),a.prevTrig=f,n=0;n<t;n++){if(s>a.lastIdx){if(!(c>0&&f>0)){i[n]=r=0;continue}s=0}r=o.interpolate(s,l),i[n]=r,s++}a.idx=s,a.unscaledValue=r,o.mulAdd(t),a.value=flock.ugen.lastOutputValue(t,i)},o.otherwiseGen=function(t){var n,r,a,i,u,l,s=o.model,c=o.output,f=o.inputs.channel.output[0],d=o.inputs.speed.output,p=o.buffer.data.channels[f],g=e.trigger.output,m=s.idx,v=o.inputs.loop.output[0],h=o.inputs.start.output[0]*s.lastIdx|0,k=o.inputs.end.output[0]*s.lastIdx|0;for(n=0,r=0,a=0;n<t;n++,r+=s.strides.trigger,a+=s.strides.speed){if(i=g[r],u=d[a],i>0&&s.prevTrig<=0)m=flock.ugen.playBuffer.resetIndex(u,h,k);else if(m<h||m>k){if(!(v>0&&i>0)){c[n]=l=0;continue}m=flock.ugen.playBuffer.resetIndex(u,h,k)}s.prevTrig=g[r],l=o.interpolate(m,p),c[n]=l,m+=s.stepSize*u}s.idx=m,s.unscaledValue=l,o.mulAdd(t),s.value=flock.ugen.lastOutputValue(t,c)},o.onInputChanged=function(e){var t=o.inputs,n=t.speed,r=t.start,a=t.end,i=t.trigger;o.onBufferInputChanged(e),o.gen=n.rate===flock.rates.CONSTANT&&1===n.output[0]&&r.rate===flock.rates.CONSTANT&&0===r.output[0]&&a.rate===flock.rates.CONSTANT&&1===a.output[0]&&i.rate!==flock.rates.AUDIO?o.defaultKrTriggerGen:o.otherwiseGen,o.calculateStrides(),flock.onMulAddInputChanged(o)},o.onBufferReady=function(){var e=o.model,t=o.inputs.end.output[0],n=o.inputs.channel.output[0],r=o.buffer.data.channels[n],a=r.length;e.idx=t*a|0,e.lastIdx=a-1,e.stepSize=o.buffer.format.sampleRate/e.sampleRate},o.init=function(){flock.ugen.buffer(o),o.initBuffer(),o.onInputChanged()},o.init(),o},flock.ugen.playBuffer.resetIndex=function(e,t,n){return e>0?t:n},fluid.defaults("flock.ugen.playBuffer",{rate:"audio",inputs:{channel:0,loop:0,speed:1,start:0,end:1,trigger:1,buffer:null,mul:null,add:null},ugenOptions:{model:{finished:!1,unscaledValue:0,value:0,idx:0,stepSize:0,prevTrig:0,channel:void 0},strideInputs:["trigger","speed"],interpolation:"linear"}}),flock.ugen.readBuffer=function(e,t,n){var o=flock.ugen(e,t,n);return o.gen=function(e){var t,n,r,a,i=o.model,u=i.strides.phase,l=o.output,s=o.inputs.channel.output[0],c=o.inputs.phase.output,f=o.buffer.data.channels[s],d=f.length;for(t=r=0;t<e;t++,r+=u)n=c[r]*d,a=o.interpolate(n,f),l[t]=a;i.unscaledValue=a,o.mulAdd(e),i.value=flock.ugen.lastOutputValue(e,l)},o.onInputChanged=function(e){o.onBufferInputChanged(e),o.calculateStrides(),flock.onMulAddInputChanged(o)},o.init=function(){flock.ugen.buffer(o),o.initBuffer(),o.onInputChanged()},o.init(),o},fluid.defaults("flock.ugen.readBuffer",{rate:"audio",inputs:{buffer:null,channel:0,phase:0,mul:null,add:null},ugenOptions:{model:{channel:void 0,unscaledValue:0,value:0},strideInputs:["phase"],interpolation:"linear"}}),flock.ugen.bufferDuration=function(e,t,n){
var o=flock.ugen(e,t,n);return o.krGen=function(e){var t,n=o.model,r=o.output,a=o.inputs.channel.output[0],i=o.buffer.data.channels[a],u=o.buffer.format.sampleRate;for(t=0;t<e;t++)r[t]=i.length/u;n.unscaledValue=n.value=flock.ugen.lastOutputValue(e,r)},o.onInputChanged=function(e){o.onBufferInputChanged(e)},o.onBufferReady=function(){o.krGen(1)},o.init=function(){var e=o.rate;o.gen=e===flock.rates.CONTROL||e===flock.rates.AUDIO?o.krGen:void 0,o.output[0]=0,flock.ugen.buffer(o),o.initBuffer(),o.onInputChanged()},o.init(),o},fluid.defaults("flock.ugen.bufferDuration",{rate:"constant",inputs:{buffer:null,channel:0},ugenOptions:{model:{unscaledValue:0,value:0}}}),flock.ugen.bufferLength=function(e,t,n){var o=flock.ugen(e,t,n);return o.krGen=function(e){var t,n=o.model,r=o.output,a=o.inputs.channel.output[0],i=o.buffer.data.channels[a],u=i.length;for(t=0;t<e;t++)r[t]=u;n.value=n.unscaledValue=u},o.onInputChanged=function(e){o.onBufferInputChanged(e)},o.onBufferReady=function(){o.krGen(1)},o.init=function(){var e=o.rate;o.gen=e===flock.rates.CONTROL||e===flock.rates.AUDIO?o.krGen:void 0,o.output[0]=0,flock.ugen.buffer(o),o.initBuffer(),o.onInputChanged()},o.init(),o},fluid.defaults("flock.ugen.bufferLength",{rate:"constant",inputs:{buffer:null,channel:0},ugenOptions:{model:{unscaledValue:0,value:0}}}),flock.ugen.bufferPhaseStep=function(e,t,n){var o=flock.ugen(e,t,n);return o.krGen=function(e){var t,n=o.model,r=o.output,a=n.unscaledValue;for(t=0;t<e;t++)r[t]=a;o.mulAdd(e),n.value=flock.ugen.lastOutputValue(e,r)},o.onInputChanged=function(e){o.onBufferInputChanged(e),flock.onMulAddInputChanged(o)},o.onBufferReady=function(e){var t=o.model,n=o.inputs.channel.output[0],r=e.data.channels[n],a=o.options.audioSettings.rates.audio,i=o.buffer.format.sampleRate||a;t.scale=i/a,o.output[0]=t.unscaledValue=1/(r.length*t.scale)},o.init=function(){var e=o.rate;o.gen=e===flock.rates.CONTROL||e===flock.rates.AUDIO?o.krGen:void 0,o.output[0]=0,flock.ugen.buffer(o),o.initBuffer(),o.onInputChanged()},o.init(),o},fluid.defaults("flock.ugen.bufferPhaseStep",{rate:"constant",inputs:{buffer:null,channel:0},ugenOptions:{model:{scale:1,unscaledValue:0,value:0}}}),flock.ugen.sampleRate=function(e,t,n){var o=flock.ugen(e,t,n),r=o.model;return o.output[0]=r.value=r.unscaledValue=o.options.audioSettings.rates.audio,o},fluid.defaults("flock.ugen.sampleRate",{rate:"constant",inputs:{}}),flock.ugen.dust=function(e,t,n){var o=flock.ugen(e,t,n);return o.gen=function(t){var n,r,a,i,u,l=o.model,s=o.output,c=e.density.output[0];for(c!==l.density?(l.density=c,n=l.threshold=c*l.sampleDur,r=l.scale=n>0?1/n:0):(n=l.threshold,r=l.scale),u=0;u<t;u++)a=Math.random(),i=a<n?a*r:0,s[u]=i;l.unscaledValue=i,o.mulAdd(t),l.value=flock.ugen.lastOutputValue(t,s)},o.onInputChanged(),o},fluid.defaults("flock.ugen.dust",{rate:"audio",inputs:{density:1,mul:null,add:null},ugenOptions:{model:{density:0,scale:0,threshold:0,unscaledValue:0,value:0}}}),flock.ugen.whiteNoise=function(e,t,n){var o=flock.ugen(e,t,n);return o.gen=function(e){var t,n,r=o.model,a=o.output;for(t=0;t<e;t++)a[t]=n=Math.random();r.unscaledValue=n,o.mulAdd(e),r.value=flock.ugen.lastOutputValue(e,a)},o.onInputChanged(),o},fluid.defaults("flock.ugen.whiteNoise",{rate:"audio",inputs:{mul:null,add:null}}),flock.ugen.pinkNoise=function(e,t,n){var o=flock.ugen(e,t,n);return o.gen=function(e){var t,n,r,a,i=o.model,u=i.state,l=o.a,s=o.p,c=i.offset,f=o.output;for(t=0;t<e;t++){for(a=0,n=0;n<u.length;n++)r=Math.random(),u[n]=s[n]*(u[n]-r)+r,a+=l[n]*u[n];a=2*a-c,f[t]=a}i.unscaledValue=a,o.mulAdd(e),i.value=flock.ugen.lastOutputValue(e,f)},o.init=function(){o.a=new Float32Array(o.options.coeffs.a),o.p=new Float32Array(o.options.coeffs.p),o.model.state=new Float32Array(o.a.length);for(var e=0;e<o.a.length;e++)o.model.offset+=o.a[e];o.onInputChanged()},o.init(),o},fluid.defaults("flock.ugen.pinkNoise",{rate:"audio",inputs:{mul:null,add:null},ugenOptions:{model:{state:0,unscaledValue:0,value:0,offset:0},coeffs:{a:[.02109238,.07113478,.68873558],p:[.319,.7756,.9613]}}}),flock.ugen.lfNoise=function(e,t,n){var o=flock.ugen(e,t,n);return o.gen=function(t){var n,r,a=o.model,i=e.freq.output[0],u=t,l=o.output,s=0;i=i>.001?i:.001;do for(a.counter<=0&&(a.counter=a.sampleRate/i,a.counter=a.counter>1?a.counter:1,"linear"===o.options.interpolation?(a.start=a.unscaledValue=a.end,a.end=Math.random(),a.ramp=a.ramp=(a.end-a.start)/a.counter):(a.start=a.unscaledValue=Math.random(),a.ramp=0)),n=u<a.counter?u:a.counter,u-=n,a.counter-=n,r=0;r<n;r++)l[s]=a.unscaledValue,a.unscaledValue+=a.ramp,s++;while(u);o.mulAdd(t),a.value=flock.ugen.lastOutputValue(t,l)},o.input=function(){o.model.end=Math.random(),o.onInputChanged()},o.input(),o},fluid.defaults("flock.ugen.lfNoise",{rate:"audio",inputs:{freq:440,mul:null,add:null},ugenOptions:{model:{counter:0,level:0,unscaledValue:0,value:0}}}),flock.ugen.random=function(e,t,n){var o=flock.ugen(e,t,n);return o.gen=function(e){var t,n,r=o.model,a=o.generator,i=o.output;for(t=0;t<e;t++)i[t]=n=a.uniform(-1,1);r.unscaledValue=n,o.mulAdd(e),r.value=flock.ugen.lastOutputValue(e,i)},o.onInputChanged=function(e){"seed"===e&&o.initGenerator(),flock.onMulAddInputChanged(o)},o.initGenerator=function(){var e=o.inputs.seed;o.generator=e?new Random(e):new Random},o.init=function(){o.initGenerator(),o.calculateStrides(),o.onInputChanged()},o.init(),o},fluid.defaults("flock.ugen.random",{rate:"audio",inputs:{seed:null,mul:null,add:null}}),flock.ugen.random.exponential=function(e,t,n){var o=flock.ugen.random(e,t,n);return o.gen=function(e){var t,n,r,a=o.model,i=o.generator,u=o.output,l=o.inputs.lambda.output,s=o.model.strides.lambda;for(t=n=0;t<e;t++,n+=s)u[t]=r=i.exponential(l[n]);a.unscaledValue=r,o.mulAdd(e),a.value=flock.ugen.lastOutputValue(e,u)},o},fluid.defaults("flock.ugen.random.exponential",{rate:"audio",inputs:{seed:null,lambda:1,mul:null,add:null},ugenOptions:{strideInputs:["lambda"]}}),flock.ugen.random.gamma=function(e,t,n){var o=flock.ugen.random(e,t,n);return o.gen=function(e){var t,n,r,a,i=o.model,u=o.inputs,l=o.generator,s=o.output,c=i.strides.alpha,f=u.alpha.output,d=i.strides.beta,p=u.beta.output;for(t=n=r=0;t<e;t++,n+=c,r+=d)s[t]=a=l.gamma(f[n],p[r]);i.unscaledValue=a,o.mulAdd(e),i.value=flock.ugen.lastOutputValue(e,s)},o},fluid.defaults("flock.ugen.random.gamma",{rate:"audio",inputs:{seed:null,alpha:1,beta:2,mul:null,add:null},ugenOptions:{strideInputs:["alpha","beta"]}}),flock.ugen.random.normal=function(e,t,n){var o=flock.ugen.random(e,t,n);return o.gen=function(e){var t,n,r,a,i=o.model,u=o.output,l=o.inputs,s=o.generator,c=i.strides.mu,f=l.mu.output,d=i.strides.sigma,p=l.sigma.output;for(t=n=r=0;t<e;t++,n+=c,r+=d)u[t]=a=s.normal(f[n],p[r]);i.unscaledValue=a,o.mulAdd(e),i.value=flock.ugen.lastOutputValue(e,u)},o},fluid.defaults("flock.ugen.random.normal",{rate:"audio",inputs:{seed:null,mu:0,sigma:1,mul:null,add:null},ugenOptions:{strideInputs:["mu","sigma"]}}),flock.ugen.random.pareto=function(e,t,n){var o=flock.ugen.random(e,t,n);return o.gen=function(e){var t,n,r,a=o.model,i=o.generator,u=o.output,l=o.model.strides.alpha,s=o.inputs.alpha.output;for(t=n=0;t<e;t++,n+=l)u[t]=r=i.pareto(s[n]);a.unscaledValue=r,o.mulAdd(e),a.value=flock.ugen.lastOutputValue(e,u)},o},fluid.defaults("flock.ugen.random.pareto",{rate:"audio",inputs:{seed:null,alpha:5,mul:null,add:null},ugenOptions:{strideInputs:["alpha"]}}),flock.ugen.random.triangular=function(e,t,n){var o=flock.ugen.random(e,t,n);return o.gen=function(e){var t,n,r,a=o.model,i=o.generator,u=o.output,l=o.model.strides.mode,s=o.inputs.mode.output;for(t=n=0;t<e;t++,n+=l)u[t]=r=i.triangular(-1,1,s[n]);a.unscaledValue=r,o.mulAdd(e),a.value=flock.ugen.lastOutputValue(e,u)},o},fluid.defaults("flock.ugen.random.triangular",{rate:"audio",inputs:{seed:null,mode:.5,mul:null,add:null},ugenOptions:{strideInputs:["mode"]}}),flock.ugen.random.weibull=function(e,t,n){var o=flock.ugen.random(e,t,n);return o.gen=function(e){var t,n,r,a,i=o.model,u=o.inputs,l=o.generator,s=o.output,c=i.strides.alpha,f=u.alpha.output,d=i.strides.beta,p=u.beta.output;for(t=n=r=0;t<e;t++,n+=c,r+=d)s[t]=a=l.weibull(f[n],p[r]);i.unscaledValue=a,o.mulAdd(e),i.value=flock.ugen.lastOutputValue(e,s)},o},fluid.defaults("flock.ugen.random.weibull",{rate:"audio",inputs:{seed:null,alpha:1,beta:1,mul:null,add:null},ugenOptions:{strideInputs:["alpha","beta"]}}),flock.ugen.phasor=function(e,t,n){var o=flock.ugen(e,t,n);return o.gen=function(e){var t,n,r,a=o.model,i=o.inputs,u=o.output,l=i.step.output,s=i.trigger.output;for(void 0===a.unscaledValue&&(a.unscaledValue=i.start.output[0]),t=0,n=0,r=0;t<e;t++,n+=a.strides.trigger,r+=a.strides.step)s[n]>0&&a.prevTrig<=0&&(a.unscaledValue=i.reset.output[0]),a.prevTrig=s[n],a.unscaledValue>=i.end.output[0]&&(a.unscaledValue=i.start.output[0]),u[t]=a.unscaledValue,a.unscaledValue+=l[r];o.mulAdd(e),a.value=flock.ugen.lastOutputValue(e,u)},o.onInputChanged(),o},fluid.defaults("flock.ugen.phasor",{rate:"control",inputs:{start:0,end:1,reset:0,step:.1,trigger:0,mul:null,add:null},ugenOptions:{model:{unscaledValue:void 0,value:0},strideInputs:["trigger","step"]}}),flock.ugen.amplitude=function(e,t,n){var o=flock.ugen(e,t,n);return o.gen=function(e){var t,n,r,a=o.model,i=o.inputs.source.output,u=o.output,l=a.attackTime,s=o.inputs.attack.output[0],c=a.releaseTime,f=o.inputs.release.output[0],d=a.prevVal,p=a.attackCoef,g=a.releaseCoef;for(s!==l&&(a.attackTime=s,p=a.attackCoef=0===s?0:Math.exp(flock.LOG01/(s*a.sampleRate))),f!==c&&(a.releaseTime=f,g=a.releaseCoef=0===f?0:Math.exp(flock.LOG01/(f*a.sampleRate))),t=0;t<e;t++)n=Math.abs(i[t]),r=n<d?g:p,u[t]=d=n+(d-n)*r;a.unscaledValue=a.prevVal=d,o.mulAdd(e),a.value=flock.ugen.lastOutputValue(e,u)},o.onInputChanged(),o},fluid.defaults("flock.ugen.amplitude",{rate:"audio",inputs:{source:null,attack:.01,release:.01,mul:null,add:null},ugenOptions:{model:{prevVal:0,unscaledValue:0,value:0}}}),flock.ugen.normalize=function(e,t,n){var o=flock.ugen(e,t,n);return o.gen=function(){var e=o.model,t=o.output,n=o.inputs.max.output[0],r=o.inputs.source.output;flock.normalize(r,n,t),e.value=e.unscaledValue=t[t.length-1]},o.onInputChanged(),o},fluid.defaults("flock.ugen.normalize",{rate:"audio",inputs:{max:1,source:null}}),flock.ugen.gate=function(e,t,n){var o=flock.ugen(e,t,n);return o.gen=function(e){var t,n,r,a,i=o.model,u=i.strides,l=o.output,s=o.inputs,c=s.source.output,f=s.sideChain.output,d=u.sideChain,p=s.threshold.output,g=u.threshold,m=o.options.holdLastValue,v=i.lastValue;for(t=n=r=0;t<e;t++,n+=d,r+=g)f[n]>=p[r]?l[t]=a=v=c[t]:l[t]=a=m?v:0;i.lastValue=v,i.unscaledValue=a,o.mulAdd(e),i.value=flock.ugen.lastOutputValue(e,l)},o.onInputChanged=function(){o.inputs.sideChain||(o.inputs.sideChain=o.inputs.source),flock.onMulAddInputChanged(o),o.calculateStrides()},o.onInputChanged(),o},fluid.defaults("flock.ugen.gate",{rate:"audio",inputs:{source:null,sideChain:null,threshold:Number.MIN_VALUE,mul:null,add:null},ugenOptions:{model:{unscaledValue:0,value:0,lastValue:0},holdLastValue:!1,strideInputs:["sideChain","threshold"]}}),flock.ugen.pan2=function(e,t,n){var o=flock.ugen(e,t,n);return o.gen=function(e){var t,n,r,a,i=o.model,u=o.output,l=u[0],s=u[1],c=o.inputs,f=c.source.output,d=c.pan.output;for(t=0,n=0;t<e;t++,n+=i.strides.pan)r=f[t],a=.5*d[n]+.5,s[t]=r*Math.sin(a*flock.HALFPI),l[t]=r*Math.cos(a*flock.HALFPI);var p=e-1;i.value[0]=u[0][p],i.value[1]=u[1][p]},o.init=function(){o.onInputChanged(),o.model.unscaledValue=o.model.value},o.init(),o},fluid.defaults("flock.ugen.pan2",{rate:"audio",inputs:{source:null,pan:0},ugenOptions:{model:{unscaledValue:[0,0],value:[0,0]},tags:["flock.ugen.multiChannelOutput"],strideInputs:["pan"],numOutputs:2}}),flock.ugen.out=function(e,t,n){var o=flock.ugen(e,t,n);return o.gen=function(e){var t,n,r,a,i,u,l,s,c,f=o.model,d=o.multiInputs.sources,p=o.options.audioSettings.buses,g=o.inputs.bus.output[0],m=o.inputs.expand.output[0];if(t=d.length,n=Math.max(m,t),!(t<1)){for(r=0;r<n;r++)for(i=d[r%t],u=i.rate,l=p[g+r],s=u===flock.rates.AUDIO?1:0,c=0,a=0;a<e;a++,c+=s)l[a]=l[a]+i.output[c];f.value=f.unscaledValue=i.output[c],o.mulAdd(e)}},o.init=function(){o.sourceBuffers=[],o.onInputChanged()},o.init(),o},fluid.defaults("flock.ugen.out",{rate:"audio",inputs:{sources:null,bus:0,expand:2},ugenOptions:{tags:["flock.ugen.outputType"],multiInputNames:["sources"]}}),flock.ugen.valueOut=function(e,t,n){var o=flock.ugen(e,t,n);return o.arraySourceGen=function(){var e,t=o.model,n=o.inputs.sources;for(e=0;e<n.length;e++)t.value[e]=n[e].output[0]},o.ugenSourceGen=function(){o.model.value=o.model.unscaledValue=o.inputs.sources.output[0]},o.onInputChanged=function(){var e=o.model,t=o.inputs.sources;flock.isIterable(t)?(o.gen=o.arraySourceGen,e.value=new Float32Array(t.length),e.unscaledValue=e.value):o.gen=o.ugenSourceGen},o.onInputChanged(),o},fluid.defaults("flock.ugen.valueOut",{rate:"control",inputs:{sources:null},ugenOptions:{model:{unscaledValue:null,value:null},tags:["flock.ugen.outputType","flock.ugen.valueType"]}}),flock.ugen.in=function(e,t,n){var o=flock.ugen(e,t,n);return o.singleBusGen=function(e){var t=o.model,n=o.output;flock.ugen.in.readBus(e,n,o.inputs.bus,o.options.audioSettings.buses),t.unscaledValue=flock.ugen.lastOutputValue(e,n),o.mulAdd(e),t.value=flock.ugen.lastOutputValue(e,n)},o.multiBusGen=function(e){var t,n,r,a,i=o.model,u=o.inputs.bus,l=o.options.audioSettings.buses,s=o.output;for(t=0;t<e;t++){for(a=0,n=0;n<u.length;n++)r=0|u[n].output[0],a+=l[r][t];s[t]=a}i.unscaledValue=a,o.mulAdd(e),i.value=flock.ugen.lastOutputValue(e,s)},o.onInputChanged=function(){o.gen=flock.isIterable(o.inputs.bus)?o.multiBusGen:o.singleBusGen,flock.onMulAddInputChanged(o)},o.onInputChanged(),o},flock.ugen.in.readBus=function(e,t,n,o){var r,a=0|n.output[0],i=o[a];for(r=0;r<e;r++)t[r]=i[r]},fluid.defaults("flock.ugen.in",{rate:"audio",inputs:{bus:0,mul:null,add:null}}),flock.ugen.audioIn=function(e,t,n){var o=flock.ugen(e,t,n);return o.gen=function(e){var t,n,r=o.model,a=o.output,i=o.bus;for(t=0;t<e;t++)a[t]=n=i[t];r.unscaledValue=n,o.mulAdd(e),r.value=flock.ugen.lastOutputValue(e,a)},o.onInputChanged=function(){flock.onMulAddInputChanged(o)},o.init=function(){var e=flock.enviro.shared.audioStrategy.inputDeviceManager.openAudioDevice(n);o.bus=o.options.audioSettings.buses[e],o.onInputChanged()},o.init(),o},fluid.defaults("flock.ugen.audioIn",{rate:"audio",inputs:{mul:null,add:null}}),flock.ugen.filter=function(e,t,o){var r=flock.ugen(e,t,o);return r.gen=function(){var e=r.model,t=r.output,n=r.inputs,o=n.q.output[0],a=n.freq.output[0];e.prevFreq===a&&e.prevQ===o||r.updateCoefficients(e,a,o),r.filterEngine.filter(t,r.inputs.source.output),e.prevQ=o,e.prevFreq=a,e.value=e.unscaledValue=t[t.length-1]},r.init=function(){var e=r.options.recipe,t="string"==typeof e?flock.get(e):e;if(!t)throw new Error("Can't instantiate a flock.ugen.filter() without specifying a filter coefficient recipe.");r.filterEngine=new n(t.sizes.b,t.sizes.a),r.model.coeffs={a:r.filterEngine.a,b:r.filterEngine.b},r.updateCoefficients=flock.get(t,r.options.type),r.onInputChanged()},r.init(),r},fluid.defaults("flock.ugen.filter",{rate:"audio",inputs:{freq:440,q:1,source:null}}),flock.ugen.filter.biquad=function(e,t,n){var o=flock.ugen(e,t,n);return o.gen=function(e){var t,n,r=o.model,a=o.inputs,i=o.output,u=r.coeffs,l=a.freq.output[0],s=a.q.output[0],c=a.source.output;for(r.prevFreq===l&&r.prevQ===s||o.updateCoefficients(r,l,s),t=0;t<e;t++)n=c[t]-u.a[0]*r.d0-u.a[1]*r.d1,i[t]=u.b[0]*n+u.b[1]*r.d0+u.b[2]*r.d1,r.d1=r.d0,r.d0=n;r.prevQ=s,r.prevFreq=l,r.value=r.unscaledValue=flock.ugen.lastOutputValue(e,i)},o.onInputChanged=function(){var e=o.options.type;o.updateCoefficients="string"==typeof e?flock.get(e):e},o.init=function(){o.model.d0=0,o.model.d1=0,o.model.coeffs={a:new Float32Array(2),b:new Float32Array(3)},o.onInputChanged()},o.init(),o},fluid.defaults("flock.ugen.filter.biquad",{inputs:{freq:440,q:1,source:null}}),flock.ugen.filter.biquad.types={hp:{inputDefaults:{freq:440,q:1},options:{type:"flock.coefficients.butterworth.highPass"}},rhp:{inputDefaults:{freq:440,q:1},options:{type:"flock.coefficients.rbj.highPass"}},lp:{inputDefaults:{freq:440,q:1},options:{type:"flock.coefficients.butterworth.lowPass"}},rlp:{inputDefaults:{freq:440,q:1},options:{type:"flock.coefficients.rbj.lowPass"}},bp:{inputDefaults:{freq:440,q:4},options:{type:"flock.coefficients.butterworth.bandPass"}},br:{inputDefaults:{freq:440,q:1},options:{type:"flock.coefficients.butterworth.bandReject"}}},flock.aliasUGens("flock.ugen.filter.biquad",flock.ugen.filter.biquad.types),flock.coefficients={butterworth:{sizes:{a:2,b:3},lowPass:function(e,t){var n=e.coeffs,o=1/Math.tan(Math.PI*t/e.sampleRate),r=o*o,a=flock.ROOT2*o,i=1/(1+a+r);n.b[0]=i,n.b[1]=2*i,n.b[2]=i,n.a[0]=2*(1-r)*i,n.a[1]=(1-a+r)*i},highPass:function(e,t){var n=e.coeffs,o=Math.tan(Math.PI*t/e.sampleRate);o===1/0&&(o=0);var r=o*o,a=flock.ROOT2*o,i=1/(1+a+r);n.b[0]=i,n.b[1]=-2*i,n.b[2]=i,n.a[0]=2*(r-1)*i,n.a[1]=(1-a+r)*i},bandPass:function(e,t,n){var o=e.coeffs,r=t/n,a=1/Math.tan(Math.PI*r/e.sampleRate),i=2*Math.cos(flock.TWOPI*t/e.sampleRate),u=1/(1+a);o.b[0]=u,o.b[1]=0,o.b[2]=-u,o.a[0]=-(a*i*u),o.a[1]=u*(a-1)},bandReject:function(e,t,n){var o=e.coeffs,r=t/n,a=Math.tan(Math.PI*r/e.sampleRate),i=2*Math.cos(flock.TWOPI*t/e.sampleRate),u=1/(1+a),l=-i*u;o.b[0]=u,o.b[1]=l,o.b[2]=u,o.a[0]=l,o.a[1]=(1-a)*u}},rbj:{sizes:{a:2,b:3},lowPass:function(e,t,n){var o=e.coeffs,r=flock.TWOPI*t/e.sampleRate,a=Math.cos(r),i=Math.sin(r),u=i/(2*n),l=1-a,s=1+u,c=l/2/s;o.b[0]=c,o.b[1]=l/s,o.b[2]=c,o.a[0]=-2*a/s,o.a[1]=(1-u)/s},highPass:function(e,t,n){var o=e.coeffs,r=flock.TWOPI*t/e.sampleRate,a=Math.cos(r),i=Math.sin(r),u=i/(2*n),l=1+a,s=1+u,c=l/2/s;o.b[0]=c,o.b[1]=-l/s,o.b[2]=c,o.a[0]=-2*a/s,o.a[1]=(1-u)/s},bandPass:function(e,t,n){var o=e.coeffs,r=flock.TWOPI*t/e.sampleRate,a=Math.cos(r),i=Math.sin(r),u=i/(2*n),l=1+u,s=n*u;o.b[0]=s/l,o.b[1]=0,o.b[2]=-s/l,o.a[0]=-2*a/l,o.a[1]=(1-u)/l},bandReject:function(e,t,n){var o=e.coeffs,r=flock.TWOPI*t/e.sampleRate,a=Math.cos(r),i=Math.sin(r),u=i/(2*n),l=1+u,s=1/l,c=-2*a/l;o.b[0]=s,o.b[1]=c,o.b[2]=s,o.a[0]=c,o.a[1]=(1-u)/l}}},flock.ugen.filter.moog=function(e,t,n){var o=flock.ugen(e,t,n);return o.gen=function(e){var t,n,r,a,i,u,l,s=o.model,c=o.inputs,f=o.output,d=c.source.output,p=s.strides.source,g=c.resonance.output,m=s.strides.resonance,v=c.cutoff.output,h=s.strides.cutoff,k=s.f,y=s.fSq,b=s.fSqSq,C=s.oneMinusF,A=s.fb;for(t=n=r=a=0;t<e;t++,n+=p,r+=m,a+=h)i=v[a],u=g[r],i!==s.prevCutoff&&(i>s.nyquistRate&&(i=s.nyquistRate),k=s.f=i/s.nyquistRate*1.16,y=s.fSq=k*k,b=s.fSqSq=y*y,C=s.oneMinusF=1-k,s.prevRes=void 0),u!==s.prevRes&&(u>4?u=4:u<0&&(u=0),A=s.fb=u*(1-.15*y)),l=d[n]-s.out4*A,l*=.35013*b,s.out1=l+.3*s.in1+C*s.out1,s.in1=l,s.out2=s.out1+.3*s.in2+C*s.out2,s.in2=s.out1,s.out3=s.out2+.3*s.in3+C*s.out3,s.in3=s.out2,s.out4=s.out3+.3*s.in4+C*s.out4,s.in4=s.out3,f[t]=s.out4;s.unscaledValue=s.out4,o.mulAdd(e),s.value=flock.ugen.lastOutputValue(e,f)},o.onInputChanged(),o},fluid.defaults("flock.ugen.filter.moog",{rate:"audio",inputs:{cutoff:3e3,resonance:3.99,source:null},ugenOptions:{model:{in1:0,in2:0,in3:0,in4:0,out1:0,out2:0,out3:0,out4:0,prevCutoff:void 0,prevResonance:void 0,f:void 0,fSq:void 0,fSqSq:void 0,oneMinusF:void 0,fb:void 0,unscaledValue:0,value:0},strideInputs:["source","cutoff","resonance"]}}),flock.ugen.delay=function(e,t,n){var o=flock.ugen(e,t,n);return o.gen=function(e){var t,n,r=o.model,a=o.inputs,i=o.output,u=a.source.output,l=a.time.output[0],s=o.delayBuffer;for(l!==r.time&&(r.time=l,r.delaySamps=l*o.model.sampleRate),t=0;t<e;t++)r.pos>=r.delaySamps&&(r.pos=0),i[t]=n=s[r.pos],s[r.pos]=u[t],r.pos++;r.unscaledValue=n,o.mulAdd(e),r.value=flock.ugen.lastOutputValue(e,i)},o.onInputChanged=function(e){if(flock.onMulAddInputChanged(o),!e||"maxTime"===e){var t=o.model.sampleRate*o.inputs.maxTime.output[0];o.delayBuffer=new Float32Array(t)}},o.onInputChanged(),o},fluid.defaults("flock.ugen.delay",{rate:"audio",inputs:{maxTime:1,time:1,source:null},ugenOptions:{model:{pos:0,unscaledValue:0,value:0}}}),flock.ugen.delay1=function(e,t,n){var o=flock.ugen(e,t,n);return o.gen=function(e){var t,n,r=o.model,a=o.inputs,i=o.output,u=a.source.output,l=r.prevVal;for(t=0;t<e;t++)i[t]=n=l,l=u[t];r.prevVal=l,r.unscaledValue=n,o.mulAdd(e),r.value=flock.ugen.lastOutputValue(e,i)},o.onInputChanged=function(){flock.onMulAddInputChanged(o)},o.onInputChanged(),o},fluid.defaults("flock.ugen.delay1",{rate:"audio",inputs:{source:null},ugenOptions:{model:{prevVal:0,unscaledValue:0,value:0}}}),flock.ugen.freeverb=function(e,t,n){var o=flock.ugen(e,t,n);return o.tunings=o.options.tunings,o.allpassTunings=o.options.allpassTunings,o.gen=function(e){var t,n,r,a=o.model,i=o.inputs,u=o.output,l=i.source.output,s=i.mix.output[0],c=1-s,f=i.room.output[0],d=.28*f+.7,p=i.damp.output[0],g=.4*p,m=1-g;for(t=0;t<e;t++){var v=l[t],h=.015*v;for(n=0;n<o.buffers_a.length;n++)++o.bufferindices_a[n]===o.allpassTunings[n]&&(o.bufferindices_a[n]=0),o.readsamp_a[n]=o.buffers_a[n][o.bufferindices_a[n]];for(n=0;n<o.buffers_c.length;n++){++o.bufferindices_c[n]===o.tunings[n]&&(o.bufferindices_c[n]=0);var k=o.bufferindices_c[n],y=o.buffers_c[n][k];o.filterx_c[n]=m*o.filtery_c[n]+g*o.filterx_c[n],o.buffers_c[n][k]=h+d*o.filterx_c[n],o.filtery_c[n]=y}var b=o.filtery_c[6]+o.filtery_c[7];o.buffers_a[3][o.bufferindices_a[3]]=.5*o.filterx_a[3]+o.filtery_c[0]+(o.filtery_c[1]+o.filtery_c[2])+(o.filtery_c[3]+o.filtery_c[4]+(o.filtery_c[5]+b)),o.filterx_a[3]=o.readsamp_a[3],o.filtery_a[3]=o.filterx_a[3]-(o.filtery_c[0]+o.filtery_c[1]+(o.filtery_c[2]+o.filtery_c[3])+(o.filtery_c[4]+o.filtery_c[5]+b)),o.buffers_a[2][o.bufferindices_a[2]]=.5*o.filterx_a[2]+o.filtery_a[3],o.filterx_a[2]=o.readsamp_a[2],o.filtery_a[2]=o.filterx_a[2]-o.filtery_a[3],o.buffers_a[1][o.bufferindices_a[1]]=.5*o.filterx_a[1]+o.filtery_a[2],o.filterx_a[1]=o.readsamp_a[1],o.filtery_a[1]=o.filterx_a[1]-o.filtery_a[2],o.buffers_a[0][o.bufferindices_a[0]]=.5*o.filterx_a[0]+o.filtery_a[1],o.filterx_a[0]=o.readsamp_a[0],o.filtery_a[0]=o.filterx_a[0]-o.filtery_a[1],r=c*v+s*o.filtery_a[0],u[t]=r}a.unscaledValue=r,o.mulAdd(e),a.value=flock.ugen.lastOutputValue(e,u)},o.initDelayLines=function(){o.buffers_c=new Array(8),o.bufferindices_c=new Int32Array(8),o.filterx_c=new Float32Array(8),o.filtery_c=new Float32Array(8);var e,t,n=o.model.spread;for(e=0;e<o.buffers_c.length;e++)for(o.buffers_c[e]=new Float32Array(o.tunings[e]+n),o.bufferindices_c[e]=0,o.filterx_c[e]=0,o.filtery_c[e]=0,t=0;t<o.tunings[e]+n;t++)o.buffers_c[e][t]=0;for(o.buffers_a=new Array(4),o.bufferindices_a=new Int32Array(4),o.filterx_a=new Float32Array(4),o.filtery_a=new Float32Array(4),o.readsamp_a=new Float32Array(4),e=0;e<o.buffers_a.length;e++){for(o.bufferindices_a[e]=0,o.filterx_a[e]=0,o.filtery_a[e]=0,o.readsamp_a[e]=0,t=0;t<o.allpassTunings.length;t++)o.allpassTunings[t]+=n;for(o.buffers_a[e]=new Float32Array(o.allpassTunings[e]),t=0;t<o.allpassTunings[e];t++)o.buffers_a[e][t]=0}},o.init=function(){o.initDelayLines(),o.onInputChanged()},o.init(),o},fluid.defaults("flock.ugen.freeverb",{rate:"audio",inputs:{source:null,mix:.33,room:.5,damp:.5},ugenOptions:{model:{spread:0,unscaledValue:0,value:0},tunings:[1116,1188,1277,1356,1422,1491,1557,1617],allpassTunings:[556,441,341,225]}}),flock.ugen.distortion=function(e,t,n){var o=flock.ugen(e,t,n);return o.gen=function(e){var t,n,r,a,i,u=o.model,l=o.output,s=o.inputs.source.output,c=u.strides.source,f=o.inputs.gain.output,d=u.strides.gain;for(r=a=i=0;r<e;r++,a+=c,i+=d)t=s[a]*f[i],n=1.5*t-.5*t*t*t,l[r]=n;u.unscaledValue=n,o.mulAdd(e),u.value=flock.ugen.lastOutputValue(e,l)},o.onInputChanged(),o},fluid.defaults("flock.ugen.distortion",{rate:"audio",inputs:{source:null,gain:1},ugenOptions:{strideInputs:["source","gain"]}}),flock.ugen.distortion.deJonge=function(e,t,n){var o=flock.ugen(e,t,n);return o.gen=function(e){var t,n,r,a,i,u,l,s=o.model,c=o.output,f=o.inputs.source.output,d=s.strides.source,p=o.inputs.amount.output,g=s.strides.amount;for(i=u=l=0;i<e;i++,u+=d,l+=g)t=f[u],n=p[l],r=Math.abs(t),a=t*(r+n)/(t*t+(n-1)*r+1),c[i]=a;s.unscaledValue=a,o.mulAdd(e),s.value=flock.ugen.lastOutputValue(e,c)},o.onInputChanged(),o},fluid.defaults("flock.ugen.distortion.deJonge",{rate:"audio",inputs:{source:null,amount:2},ugenOptions:{strideInputs:["source","amount"]}}),flock.ugen.distortion.tarrabiaDeJonge=function(e,t,n){var o=flock.ugen(e,t,n);return o.gen=function(e){var t,n,r,a,i,u,l,s=o.model,c=o.output,f=o.inputs.source.output,d=s.strides.source,p=o.inputs.amount.output,g=s.strides.amount;for(a=i=u=0;a<e;a++,i+=d,u+=g)t=f[i],n=p[u],n>=1?n=.9999999999999999:n<-1&&(n=-1),l=2*n/(1-n),r=(1+l)*t/(1+l*Math.abs(t)),c[a]=r;s.unscaledValue=r,o.mulAdd(e),s.value=flock.ugen.lastOutputValue(e,c)},o.onInputChanged(),o},fluid.defaults("flock.ugen.distortion.tarrabiaDeJonge",{rate:"audio",inputs:{source:null,amount:10},ugenOptions:{strideInputs:["source","amount"]}}),flock.ugen.distortion.gloubiBoulga=function(e,t,n){var o=flock.ugen(e,t,n);return o.gen=function(e){var t,n,r,a,i,u,l,s,c=o.model,f=o.output,d=o.inputs.source.output,p=c.strides.source,g=o.inputs.gain.output,m=c.strides.gain;for(r=a=i=0;r<e;r++,a+=p,i+=m)t=d[a]*g[i],u=.686306*t,l=1+Math.exp(Math.sqrt(Math.abs(u))*-.75),s=Math.exp(u),n=(s-Math.exp(-u*l))/(s+Math.exp(-u)),f[r]=n;c.unscaledValue=n,o.mulAdd(e),c.value=flock.ugen.lastOutputValue(e,f)},o.onInputChanged(),o},fluid.defaults("flock.ugen.distortion.gloubiBoulga",{rate:"audio",inputs:{source:null,gain:1},ugenOptions:{strideInputs:["source","gain"]}}),flock.ugen.decay=function(e,t,n){var o=flock.ugen(e,t,n);return o.gen=function(e){var t,n,r=o.model,a=o.inputs,i=o.output,u=a.source.output,l=a.time.output[0];if(l!==r.time&&(r.time=l,r.coeff=0===l?0:Math.exp(flock.LOG001/(l*o.model.sampleRate))),0===r.coeff)for(t=0;t<e;t++)i[t]=n=u[t];else for(t=0;t<e;t++)r.lastSamp=u[t]+r.coeff*r.lastSamp,i[t]=n=r.lastSamp;r.unscaledValue=n,o.mulAdd(e),r.value=flock.ugen.lastOutputValue(e,i)},o.onInputChanged(),o},fluid.defaults("flock.ugen.decay",{rate:"audio",inputs:{source:null,time:1},ugenOptions:{model:{time:0,lastSamp:0,coeff:0,value:0}}}),flock.ugen.triggerGrains=function(e,t,n){var o=flock.ugen(e,t,n);return o.gen=function(e){var t,n,r,a,i,u,l,s=o.model,c=o.inputs,f=o.output,d=c.channel.output[0],p=o.buffer.data.channels[d],g=o.buffer.format.sampleRate,m=c.dur.output[0],v=c.amp.output,h=c.centerPos.output,k=c.trigger.output,y=c.speed.output,b=o.options.grainEnv,C=e-1,A=0,S=0,x=0,I=0;for(t=0;t<e;t++){if(k[S]>0&&s.prevTrigger<=0&&s.activeGrains.length<s.maxNumGrains){for(a=s.freeGrains.pop(),a.numSamps=s.sampleRate*m,a.centerIdx=a.numSamps/2*s.stepSize,a.envScale=o.options.grainEnv.length/a.numSamps,a.sampIdx=0,a.amp=v[x],i=h[A]*g-a.centerIdx;i<0;)i+=p.length;a.readPos=i,a.writePos=t,a.speed=y[I],s.activeGrains.push(a)}s.prevTrigger=k[S],f[t]=0,A+=s.strides.centerPos,S+=s.strides.trigger,x+=s.strides.amp,I+=s.strides.speed}for(n=0;n<s.activeGrains.length;){for(a=s.activeGrains[n],r=a.writePos;r<Math.min(r+(a.numSamps-a.sampIdx),e);r++)u=o.interpolate(a.readPos,p),l=flock.interpolate.linear(a.sampIdx*a.envScale,b),f[r]+=u*l*a.amp,a.readPos=(a.readPos+s.stepSize*a.speed)%p.length,a.sampIdx++;a.sampIdx>=a.numSamps?(s.freeGrains.push(a),s.activeGrains.splice(n,1)):(n++,a.writePos=r%e)}s.unscaledValue=f[C],o.mulAdd(e),s.value=f[C]},o.onBufferReady=function(){var e=o.model;e.stepSize=o.buffer.format.sampleRate/e.sampleRate},o.onInputChanged=function(e){o.onBufferInputChanged(e),o.calculateStrides(),flock.onMulAddInputChanged(o)},o.allocateGrains=function(e){e=e||o.model.maxNumGrains;for(var t=0;t<e;t++)o.model.freeGrains.push({numSamps:0,centerIdx:0,envScale:0,sampIdx:0,amp:0,readPos:0,writePos:0,speed:0})},o.init=function(){flock.ugen.buffer(o),o.allocateGrains(),o.initBuffer(),o.onInputChanged()},o.init(),o},fluid.defaults("flock.ugen.triggerGrains",{rate:"audio",inputs:{centerPos:0,channel:0,amp:1,dur:.1,speed:1,trigger:0,buffer:null,mul:null,add:null},ugenOptions:{grainEnv:flock.fillTable(8192,flock.tableGenerators.hann),model:{unscaledValue:0,value:0,maxNumGrains:512,activeGrains:[],freeGrains:[],env:null,strides:{}},strideInputs:["centerPos","trigger","amp","speed"],interpolation:"cubic"}}),flock.ugen.granulator=function(e,t,n){var o=flock.ugen(e,t,n);return o.gen=function(e){var t,n,r,a,i,u,l,s,c=o.model,f=o.options,d=o.inputs,p=o.output,g=o.delayLine,m=d.grainDur.output[0],v=d.delayDur.output[0],h=d.numGrains.output[0],k=d.source.output,y=f.maxDelayDur,b=f.grainEnv;for(c.delayDur!==v&&(c.delayDur=v,v>y&&(v=y),c.delayLength=v*c.sampleRate|0,c.writePos=c.writePos%c.delayLength),c.grainDur!==m&&(c.grainDur=m,c.grainLength=c.sampleRate*c.grainDur|0,c.envScale=b.length/c.grainLength),h=h>f.maxNumGrains?f.maxNumGrains:Math.round(h),t=0;t<e;t++){for(g[c.writePos]=k[t],c.writePos=++c.writePos%c.delayLength,r=0,n=0;n<h;n++)a=c.grainIdx[n],i=c.delayLineIdx[n],a>c.grainLength&&(a=0,i=Math.random()*c.delayLength|0),u=g[i],l=a*c.envScale,s=flock.interpolate.linear(l,b),r+=u*s,c.delayLineIdx[n]=++i%c.delayLength,c.grainIdx[n]=++a;r/=h,p[t]=r}c.unscaledValue=r,o.mulAdd(e),c.value=flock.ugen.lastOutputValue(e,p)},o.initGrains=function(){for(var e=o.model,t=0;t<o.options.maxNumGrains;t++)e.grainIdx[t]=0,e.delayLineIdx[t]=Math.random()*e.delayLength},o.init=function(){var e=o.model,t=o.options,n=t.maxDelayDur*e.sampleRate|0;o.delayLine=new Float32Array(n),e.delayLength=n,e.delayLineIdx=new Uint32Array(t.maxNumGrains),e.grainIdx=new Uint32Array(t.maxNumGrains),o.initGrains(),o.onInputChanged()},o.init(),o},fluid.defaults("flock.ugen.granulator",{rate:"audio",inputs:{source:null,grainDur:.1,delayDur:1,numGrains:5,mul:null,add:null},ugenOptions:{maxNumGrains:512,maxDelayDur:30,grainEnv:flock.fillTable(8192,flock.tableGenerators.sinWindow),model:{unscaledValue:0,value:0,grainLength:0,writePos:0}}}),flock.ugen.print=function(e,t,n){var o=flock.ugen(e,t,n);return o.gen=function(e){var t,n,r,a=o.inputs,i=o.output,u=o.model,l=u.label,s=a.channel,c=s?a.source.output[s.output[0]]:a.source.output,f=a.trigger.output[0],d=a.freq.output[0];for(f>0&&u.prevTrig<=0&&fluid.log(fluid.logLevel.IMPORTANT,l+c),u.freq!==d&&(u.sampInterval=Math.round(u.sampleRate/d),u.freq=d,u.counter=u.sampInterval),t=0,n=0;t<e;t++,n+=u.strides.source)u.counter>=u.sampInterval&&(fluid.log(fluid.logLevel.IMPORTANT,l+c[n]),u.counter=0),u.counter++,i[t]=r=c[t];u.value=u.unscaledValue=r},o.init=function(){var e=o.options;o.model.label=e.label?e.label+": ":"",o.onInputChanged()},o.init(),o},fluid.defaults("flock.ugen.print",{rate:"audio",inputs:{source:null,trigger:0,freq:1},ugenOptions:{model:{unscaledValue:0,value:0,counter:0},strideInputs:["source"]}}),flock.ugen.sequence=function(e,t,n){var o=flock.ugen(e,t,n);return o.gen=function(e){var t,n,r,a=o.inputs.list,i=o.inputs,u=i.freq.output,l=i.loop.output[0],s=o.model,c=s.scale,f=o.output,d=i.start?Math.round(i.start.output[0]):0,p=i.end?Math.round(i.end.output[0]):a.length;for(void 0===s.unscaledValue&&(t=a[d],s.unscaledValue=void 0===t?0:t),void 0===s.nextIdx&&(s.nextIdx=d),n=0,r=0;n<e;n++,r+=s.strides.freq){if(s.nextIdx>=p){if(!(l>0)){f[n]=s.unscaledValue;continue}s.nextIdx=d}f[n]=s.unscaledValue=a[s.nextIdx],s.phase+=u[r]*c,s.phase>=1&&(s.phase=0,s.nextIdx++)}o.mulAdd(e),s.value=flock.ugen.lastOutputValue(e,f)},o.onInputChanged=function(){o.model.scale=o.rate!==flock.rates.DEMAND?o.model.sampleDur:1,o.inputs.list||(o.inputs.list=[]),o.calculateStrides(),flock.onMulAddInputChanged(o)},o.init=function(){o.onInputChanged()},o.init(),o},fluid.defaults("flock.ugen.sequence",{rate:"control",inputs:{start:0,freq:1,loop:0,list:[]},ugenOptions:{model:{unscaledValue:void 0,value:0,phase:0},strideInputs:["freq"]}}),flock.ugen.midiFreq=function(e,t,n){var o=flock.ugen(e,t,n);return o.gen=function(e){var t,n,r,a=o.model,i=a.a4,u=i.freq,l=i.noteNum,s=a.notesPerOctave,c=o.inputs.source.output,f=o.output;for(t=0,n=0;t<e;t++,n+=a.strides.source)f[t]=r=flock.midiFreq(c[n],u,l,s);a.unscaledValue=r,o.mulAdd(e),a.value=flock.ugen.lastOutputValue(e,f)},o.init=function(){o.model.octaveScale=1/o.model.notesPerOctave,
o.onInputChanged()},o.init(),o},fluid.defaults("flock.ugen.midiFreq",{rate:"control",inputs:{source:null},ugenOptions:{model:{unscaledValue:0,value:0,a4:{noteNum:69,freq:440},notesPerOctave:12},strideInputs:["source"]}})}();var fluid=fluid||require("infusion"),flock=fluid.registerNamespace("flock");!function(){"use strict";fluid.registerNamespace("flock.view"),flock.view.scope=function(e,t){var n={model:t||{values:[]},canvas:"string"==typeof e?document.querySelector(e):e};return n.refreshView=function(){var e,t,o,r=n.ctx,a=n.model.height,i=n.model.halfHeight,u=n.model.width,l=n.model.values,s=l.length,c=n.model.scaleX*(u/s);for(r.clearRect(0,0,u,a),r.beginPath(),e=0;e<s;e++)t=e*c,o=l[e]*n.model.scaleY*i+i,r.lineTo(t,o);r.stroke()},n.init=function(){n.ctx=n.canvas.getContext("2d"),n.ctx.fillStyle=n.model.fill||n.ctx.fillStyle,n.ctx.strokeStyle=n.model.strokeColor||n.ctx.strokeStyle,n.ctx.lineWidth=n.model.strokeWidth||n.ctx.lineWidth,n.model.min=n.model.min||-1,n.model.max=n.model.max||1,n.model.height=n.canvas.height,n.model.halfHeight=n.model.height/2,n.model.width=n.canvas.width,n.model.scaleX=n.model.scaleX||n.model.scale||1,n.model.scaleY=n.model.scaleY||n.model.scale||1,n.refreshView()},n.init(),n}}();var fluid=fluid||require("infusion"),flock=fluid.registerNamespace("flock");!function(){"use strict";var e=fluid.registerNamespace("jQuery");fluid.registerNamespace("flock.ugen"),flock.ugen.scope=function(e,t,n){var o=flock.ugen(e,t,n);return o.gen=function(e){var t,n=o.model,r=o.inputs.source.output,a=n.spf,i=n.bufIdx,u=n.scope.values;for(t=0;t<e;t++)u[i]=r[t],i<a?i+=1:(i=0,o.scopeView.refreshView());n.bufIdx=i,n.value=n.unscaledValue=flock.ugen.lastOutputValue(e,r)},o.onInputChanged=function(){o.output=o.inputs.source.output},o.init=function(){o.model.spf=Math.round(o.model.sampleRate/o.options.fps),o.model.bufIdx=0,o.model.scope=o.options.styles,o.model.scope.values=new Float32Array(o.model.spf),o.scopeView=flock.view.scope(o.options.canvas,o.model.scope),o.onInputChanged(),o.scopeView.refreshView()},o.init(),o},fluid.defaults("flock.ugen.scope",{rate:"audio",inputs:{source:null},ugenOptions:{fps:60,styles:{strokeColor:"#777777",strokeWidth:1}}}),flock.ugen.mouse={},flock.ugen.mouse.cursor=function(t,n,o){var r=flock.ugen(t,n,o);return r.exponentialGen=function(e){var t,n,o=r.model,a=flock.ugen.mouse.cursor.normalize(r.target,o),i=o.movingAvg,u=r.inputs.lag.output[0],l=r.inputs.add.output[0],s=r.inputs.mul.output[0],c=o.lagCoef,f=r.output;for(u!==c&&(c=0===u?0:Math.exp(flock.LOG001/(u*o.sampleRate)),o.lagCoef=c),t=0;t<e;t++)n=s+l,a=Math.pow(n/l,a)*l,i=a+c*(i-a),f[t]=i;o.movingAvg=i,o.value=o.unscaledValue=i},r.linearGen=function(e){var t,n=r.model,o=flock.ugen.mouse.cursor.normalize(r.target,n),a=n.movingAvg,i=r.inputs.lag.output[0],u=r.inputs.add.output[0],l=r.inputs.mul.output[0],s=n.lagCoef,c=r.output;for(i!==s&&(s=0===i?0:Math.exp(flock.LOG001/(i*n.sampleRate)),n.lagCoef=s),t=0;t<e;t++)a=o+s*(a-o),c[t]=a*l+u;n.movingAvg=n.unscaledValue=a,n.value=flock.ugen.lastOutputValue(e,c)},r.noInterpolationGen=function(e){var t,n=r.model,o=r.output,a=flock.ugen.mouse.cursor.normalize(r.target,n);for(t=0;t<e;t++)o[t]=a*r.inputs.mul.output[0]+r.inputs.add.output[0];n.value=n.unscaledValue=flock.ugen.lastOutputValue(e,o)},r.moveListener=function(e){var t=r.model;t.mousePosition=e[t.eventProp]},r.overListener=function(){r.model.isWithinTarget=!0},r.outListener=function(){var e=r.model;e.isWithinTarget=!1,e.mousePosition=0},r.downListener=function(){r.model.isMouseDown=!0},r.upListener=function(){var e=r.model;e.isMouseDown=!1,e.mousePosition=0},r.moveWhileDownListener=function(e){r.model.isMouseDown&&r.moveListener(e)},r.bindEvents=function(){var e=r.target,t=r.moveListener;r.options.onlyOnMouseDown&&(e.mousedown(r.downListener),e.mouseup(r.upListener),t=r.moveWhileDownListener),e.mouseover(r.overListener),e.mouseout(r.outListener),e.mousemove(t)},r.onInputChanged=function(){flock.onMulAddInputChanged(r);var e=r.options.interpolation;r.gen="none"===e?r.noInterpolationGen:"exponential"===e?r.exponentialGen:r.linearGen},r.init=function(){var t=r.model,n=r.options,o=n.axis,a=e(n.target||window);"x"===o||"width"===o||"horizontal"===o?(t.eventProp="clientX",t.offsetProp="left",t.dimension="width"):(t.eventProp="clientY",t.offsetProp="top",t.dimension="height"),r.target=a,t.mousePosition=0,t.movingAvg=0,r.bindEvents(),r.onInputChanged()},r.init(),r},flock.ugen.mouse.cursor.normalize=function(e,t){if(!t.isWithinTarget)return 0;var n=e[t.dimension](),o=e.offset(),r=t.mousePosition;return o&&(r-=o[t.offsetProp]),r/n},fluid.defaults("flock.ugen.mouse.cursor",{rate:"control",inputs:{lag:.5,add:0,mul:1},ugenOptions:{axis:"x",interpolation:"linear",model:{mousePosition:0,movingAvg:0,value:0}}}),flock.ugen.mouse.click=function(t,n,o){var r=flock.ugen(t,n,o);return r.gen=function(e){var t,n=r.output,o=r.model;for(t=0;t<e;t++)n[t]=o.unscaledValue;r.mulAdd(e),o.value=flock.ugen.lastOutputValue(e,n)},r.mouseDownListener=function(){r.model.unscaledValue=1},r.mouseUpListener=function(){r.model.unscaledValue=0},r.init=function(){var t=r.model;t.target=e(r.options.target?r.options.target:window),t.target.mousedown(r.mouseDownListener),t.target.mouseup(r.mouseUpListener),r.onInputChanged()},r.onInputChanged=function(){flock.onMulAddInputChanged(r)},r.init(),r},fluid.defaults("flock.ugen.mouse.click",{rate:"control"}),flock.ugen.mediaIn=function(t,n,o){var r=flock.ugen(t,n,o);return r.gen=function(e){for(var t,n=r.model,o=r.output,a=r.bus,i=0;i<e;i++)o[i]=t=a[i];n.unscaledValue=t,r.mulAdd(e),n.value=flock.ugen.lastOutputValue(e,o)},r.onInputChanged=function(){flock.onMulAddInputChanged(r)},r.init=function(){var t=flock.enviro.shared,n=e(r.options.element),o=t.audioStrategy.nativeNodeManager.createMediaElementInput(n[0]);r.bus=r.options.audioSettings.buses[o],r.onInputChanged(),flock.platform.browser.safari?flock.log.warn("MediaElementSourceNode does not work on Safari. For more information, see https://bugs.webkit.org/show_bug.cgi?id=84743 and https://bugs.webkit.org/show_bug.cgi?id=125031"):flock.platform.isAndroid&&flock.log.warn("MediaElementSourceNode does not work on Android. For more information, see https://code.google.com/p/chromium/issues/detail?id=419446")},r.init(),r},fluid.defaults("flock.ugen.mediaIn",{rate:"audio",inputs:{mul:null,add:null},ugenOptions:{element:"audio"}})}();